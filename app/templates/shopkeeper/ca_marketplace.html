{% extends 'shopkeeper/s_base.html' %}
{% block title %}CA Marketplace | MyBillingApp{% endblock %}
{% block content %}
<link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css">
<script src="https://unpkg.com/feather-icons"></script>
<div class="flex min-h-screen bg-gray-100">
    <aside class="fixed top-0 left-0 h-full w-64 bg-gradient-to-b from-[#ed6a3e] to-[#ed6a3e] shadow-lg flex flex-col justify-between z-20 mt-15">
        <div>
            <nav class="mt-5 flex-1">
                <ul class="space-y-2">
                    <li><a href="{{ url_for('shopkeeper.dashboard') }}"
                            class="flex items-center px-6 py-3 text-white font-semibold rounded-l-full hover:bg-white/30 transition duration-300"><i
                                data-feather="home" class="mr-3"></i>Dashboard Home</a></li>
                    <li><a href="{{ url_for('shopkeeper.create_bill') }}"
                            class="flex items-center px-6 py-3 text-white hover:bg-white/20 rounded-l-full transition duration-300"><i
                                data-feather="file-plus" class="mr-3"></i>Create Bill</a></li>
                    <li><a href="{{ url_for('shopkeeper.manage_bills') }}"
                            class="flex items-center px-6 py-3 text-white hover:bg-white/20 rounded-l-full transition duration-300"><i
                                data-feather="file-text" class="mr-3"></i>Manage Bills</a></li>
                    <li><a href="{{ url_for('shopkeeper.products_stock') }}"
                            class="flex items-center px-6 py-3 text-white hover:bg-white/20 rounded-l-full transition duration-300"><i
                                data-feather="box" class="mr-3"></i>Products & Stock</a></li>
                    <li><a href="{{ url_for('shopkeeper.sales_reports') }}"
                            class="flex items-center px-6 py-3 text-white hover:bg-white/20 rounded-l-full transition duration-300"><i
                                data-feather="bar-chart-2" class="mr-3"></i>Sales Reports</a></li>
                    <li><a href="{{ url_for('shopkeeper.ca_marketplace') }}"
                            class="flex items-center px-6 py-3 text-white bg-white/20 hover:bg-white/30 rounded-l-full transition duration-300"><i
                                data-feather="users" class="mr-3"></i>CA Marketplace</a></li>
                </ul>
            </nav>
        </div>
        <div class="p-4 text-xs text-white text-center opacity-70">&copy; {{ 2024 }} MyBillingApp</div>
    </aside>

    <main class="flex-1 ml-64 p-8 bg-gray-100 min-h-screen">
        <div class="max-w-7xl mx-auto">
            <h2 class="text-3xl font-bold text-[#ed6a3e] mb-6">CA Marketplace</h2>

            <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                <div class="relative">
                    <i data-feather="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="ca-search" placeholder="Search CAs by name or area..." class="pl-10 pr-4 py-3 border rounded-full w-full focus:outline-none focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent transition duration-300">
                </div>
            </div>

            <div id="ca-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for ca in cas %}
                {% set conn = connections.get(ca.ca_id) %}
                <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col justify-between hover:shadow-2xl transition duration-300 transform hover:-translate-y-1 ca-card"
                     data-name="{{ ca.firm_name|lower }}" data-area="{{ ca.area|lower }}">
                    <div>
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold text-gray-800">{{ ca.firm_name }}</h3>
                            {% if not conn %}
                            <span class="px-3 py-1 text-xs font-semibold rounded-full bg-gray-200 text-gray-600">Not Connected</span>
                            {% elif conn.status == 'pending' %}
                            <span class="px-3 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-700">Pending</span>
                            {% elif conn.status == 'approved' %}
                            <span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-700">Connected</span>
                            {% elif conn.status == 'rejected' %}
                            <span class="px-3 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-700">Rejected</span>
                            {% endif %}
                        </div>
                        <ul class="space-y-3 text-gray-600 mb-6">
                            {% if ca.area %}
                            <li class="flex items-center"><i data-feather="map-pin" class="mr-2 text-[#ed6a3e] w-5 h-5"></i><span>{{ ca.area }}</span></li>
                            {% endif %}
                            {% if ca.contact_number %}
                            <li class="flex items-center"><i data-feather="phone" class="mr-2 text-[#ed6a3e] w-5 h-5"></i><span>{{ ca.contact_number }}</span></li>
                            {% endif %}
                            {% if ca.email %}
                            <li class="flex items-center"><i data-feather="mail" class="mr-2 text-[#ed6a3e] w-5 h-5"></i><span>{{ ca.email }}</span></li>
                            {% endif %}
                        </ul>
                    </div>

                    <div class="mt-auto">
                        {% if not conn or conn.status == 'rejected' %}
                        <form method="POST" action="{{ url_for('shopkeeper.connect_ca', ca_id=ca.ca_id) }}">
                            <button type="submit" class="w-full bg-[#ed6a3e] text-white py-3 rounded-full shadow-md hover:bg-orange-700 transition duration-300 font-semibold flex items-center justify-center">
                                <i data-feather="send" class="mr-2 w-5 h-5"></i> Connect
                            </button>
                        </form>
                        {% elif conn.status == 'pending' %}
                        <button class="w-full bg-yellow-400 text-white py-3 rounded-full shadow-md cursor-not-allowed font-semibold flex items-center justify-center" disabled>
                            <i data-feather="clock" class="mr-2 w-5 h-5"></i> Pending
                        </button>
                        {% elif conn.status == 'approved' %}
                        <button class="w-full bg-green-500 text-white py-3 rounded-full shadow-md cursor-not-allowed font-semibold flex items-center justify-center" disabled>
                            <i data-feather="check-circle" class="mr-2 w-5 h-5"></i> Connected
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div class="col-span-1 md:col-span-2 lg:col-span-3 text-center text-gray-500 py-12">
                    <p class="text-xl">No Chartered Accountants are available right now. Please check back later.</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </main>
</div>

<script>
    feather.replace();

    document.getElementById('ca-search').addEventListener('keyup', function() {
        const searchTerm = this.value.toLowerCase();
        const cards = document.querySelectorAll('.ca-card');

        cards.forEach(card => {
            const name = card.getAttribute('data-name');
            const area = card.getAttribute('data-area');

            if (name.includes(searchTerm) || area.includes(searchTerm)) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    });
</script>
{% endblock %}