{% extends "shopkeeper/s_base.html" %}

{% block title %}Dashboard - MyBilling{% endblock %}

{% block shop_name %} {{ shop_name }} {% endblock %}


{% block head %}
<style>
    .custom-scrollbar {
        scrollbar-width: thin;
        scrollbar-color: #cbd5e0 #f7fafc;
    }

    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f7fafc;
        border-radius: 2px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 2px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #a0aec0;
    }

    .blur-overlay {
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
    }
</style>
<meta name="csrf-token" content="{{ csrf_token() }}">
<script>
    // Set walkthrough flag if user is first time login
    window.showWalkthrough = {{ 'true' if show_walkthrough else 'false' }};
</script>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 p-4 md:p-6 lg:-mt-8">
    <!-- Header Section -->
    <div class="mb-6 md:mb-8">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
            <div class="mb-4 sm:mb-0">
                <h1 class="text-2xl md:text-3xl lg:text-4xl font-bold text-gray-720 flex items-center">
                    <i data-feather="bar-chart" class="w-6 h-6 md:w-8 md:h-8 mr-3 text-[#ed6a3e]"></i>
                    Dashboard</h1>
                <p class="text-gray-600 text-sm md:text-base">Welcome back, {{ current_user.name or
                    current_user.username or 'User' }}!</p>
            </div>
            <div class="text-sm text-gray-500">
                <i data-feather="calendar" class="w-4 h-4 inline mr-1"></i>
                <span id="current-date"></span>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8" data-walkthrough="stats-cards">
        <!-- Stats Card 1: Total Revenue -->
        <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-xl shadow-lg p-4 md:p-6 text-white">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-green-100 text-sm font-medium">Total Revenue</p>
                    <p class="text-2xl md:text-3xl font-bold">₹{{ total_amount|default(0) }}</p>
                </div>
                <div class="p-3 bg-white/20 rounded-full flex-shrink-0">
                    <i data-feather="dollar-sign" class="w-6 h-6 md:w-8 md:h-8"></i>
                </div>
            </div>
            <div
                class="mt-3 md:mt-4 bg-green-400/30 text-green-100 px-3 py-1 rounded text-xs md:text-sm inline-flex items-center">
                {% if monthly_growth > 0 %}
                <i data-feather="trending-up" class="w-3 h-3 md:w-4 md:h-4 mr-1"></i>
                {% else %}
                <i data-feather="trending-down" class="w-3 h-3 md:w-4 md:h-4 mr-1"></i>
                {% endif %}
                {{ monthly_growth|abs }}% vs last month
            </div>
        </div>

        <!-- Stats Card 2: Total Bills -->
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl shadow-lg p-4 md:p-6 text-white">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-blue-100 text-sm font-medium">Total Bills</p>
                    <p class="text-2xl md:text-3xl font-bold">{{ monthly_bills_count|default(0) }}</p>
                </div>
                <div class="p-3 bg-white/20 rounded-full flex-shrink-0">
                    <i data-feather="file-text" class="w-6 h-6 md:w-8 md:h-8"></i>
                </div>
            </div>
            <div
                class="mt-3 md:mt-4 bg-blue-400/30 text-blue-100 px-3 py-1 rounded text-xs md:text-sm inline-flex items-center">
                <i data-feather="calendar" class="w-3 h-3 md:w-4 md:h-4 mr-1"></i>
                This month
            </div>
        </div>

        <!-- Stats Card 3: Low Stock Alerts -->
        <div class="bg-gradient-to-r from-orange-500 to-red-500 rounded-xl shadow-lg p-4 md:p-6 text-white">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-orange-100 text-sm font-medium">Low Stock Alerts</p>
                    <p class="text-2xl md:text-3xl font-bold">{{ low_stock|length if low_stock else 0 }}</p>
                </div>
                <div class="p-3 bg-white/20 rounded-full flex-shrink-0">
                    <i data-feather="alert-triangle" class="w-6 h-6 md:w-8 md:h-8"></i>
                </div>
            </div>
            <div class="mt-3 md:mt-4">
                {% if low_stock and low_stock|length > 0 %}
                <div class="space-y-1 max-h-16 overflow-y-auto custom-scrollbar">
                    {% for product in low_stock[:2] %}
                    <div class="text-xs bg-red-400/30 text-red-100 px-2 py-1 rounded truncate">
                        {{ product.product_name }} ({{ product.stock_qty }})
                    </div>
                    {% endfor %}
                    {% if low_stock|length > 2 %}
                    <div class="text-xs text-red-100">+{{ low_stock|length - 2 }} more...</div>
                    {% endif %}
                </div>
                {% else %}
                <div class="text-md text-orange-100 bg-orange-400/30 px-2 py-1 rounded">All products in stock</div>
                {% endif %}
            </div>
        </div>

        <!-- Stats Card 4: CA Connection -->
        <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl shadow-lg p-4 md:p-6 text-white">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-purple-100 text-sm font-medium">CA Connection</p>
                    {% if connected_ca %}
                    <p class="text-lg md:text-xl font-bold truncate">{{ connected_ca.firm_name }}</p>
                    {% else %}
                    <p class="text-lg md:text-xl font-bold">Not Connected</p>
                    {% endif %}
                </div>
                <div class="p-3 bg-white/20 rounded-full flex-shrink-0">
                    <i data-feather="link" class="w-6 h-6 md:w-8 md:h-8"></i>
                </div>
            </div>
            <div class="mt-3 md:mt-4">
                {% if connected_ca %}
                <div class="flex items-center justify-between">
                    <div
                        class="bg-green-400/30 text-green-100 px-3 py-1 rounded text-xs md:text-sm inline-flex items-center">
                        <i data-feather="check-circle" class="w-3 h-3 md:w-4 md:h-4 mr-1"></i>
                        Connected
                    </div>
                    <a href="{{ url_for('shopkeeper.connected_ca_profile', ca_id=connected_ca.ca_id) }}"
                        class="text-xs text-white hover:text-green-200 font-medium underline">View Profile</a>
                </div>
                {% else %}
                <div
                    class="bg-purple-400/30 text-purple-100 px-3 py-1 rounded text-xs md:text-sm inline-flex items-center" data-walkthrough="ca-connect">
                    <i data-feather="user-plus" class="w-3 h-3 md:w-4 md:h-4 mr-1"></i>
                    <a href="{{ url_for('shopkeeper.ca_marketplace') }}" class="text-white hover:text-purple-200">Find a
                        CA</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Quick Actions Section -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6 md:mb-8" data-walkthrough="quick-actions">
        <a href="{{ url_for('shopkeeper.create_bill') }}"
            class="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition duration-300 border border-gray-200 group">
            <div class="text-center">
                <div
                    class="p-3 bg-green-100 rounded-full mx-auto w-fit mb-2 group-hover:bg-green-200 transition duration-300">
                    <i data-feather="file-plus" class="w-6 h-6 text-green-600"></i>
                </div>
                <p class="text-sm font-medium text-gray-800">Create Bill</p>
            </div>
        </a>

        <a href="{{ url_for('shopkeeper.manage_bills') }}"
            class="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition duration-300 border border-gray-200 group">
            <div class="text-center">
                <div
                    class="p-3 bg-blue-100 rounded-full mx-auto w-fit mb-2 group-hover:bg-blue-200 transition duration-300">
                    <i data-feather="file-text" class="w-6 h-6 text-blue-600"></i>
                </div>
                <p class="text-sm font-medium text-gray-800">Manage Bills</p>
            </div>
        </a>

        <a href="{{ url_for('shopkeeper.products_stock') }}"
            class="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition duration-300 border border-gray-200 group">
            <div class="text-center">
                <div
                    class="p-3 bg-orange-100 rounded-full mx-auto w-fit mb-2 group-hover:bg-orange-200 transition duration-300">
                    <i data-feather="box" class="w-6 h-6 text-orange-600"></i>
                </div>
                <p class="text-sm font-medium text-gray-800">Inventory</p>
            </div>
        </a>

        <a href="{{ url_for('shopkeeper.sales_reports') }}"
            class="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition duration-300 border border-gray-200 group">
            <div class="text-center">
                <div
                    class="p-3 bg-purple-100 rounded-full mx-auto w-fit mb-2 group-hover:bg-purple-200 transition duration-300">
                    <i data-feather="bar-chart-2" class="w-6 h-6 text-purple-600"></i>
                </div>
                <p class="text-sm font-medium text-gray-800">Reports</p>
            </div>
        </a>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
        <!-- Sales Chart -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <div class="flex items-center mb-4"><i data-feather="bar-chart-2" class="text-[#ed6a3e] mr-2"></i><span
                    class="font-bold text-lg">Sales Trends</span></div>
            <div class="h-64">
                <canvas id="monthlySalesChart"></canvas>
            </div>
        </div>

        <!-- Recent Bills -->
        <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 border border-gray-200" data-walkthrough="recent-bills">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <i data-feather="list" class="text-[#ed6a3e] mr-2 w-5 h-5"></i>
                    <span class="font-bold text-lg md:text-xl text-gray-800">Recent Bills</span>
                </div>
                <a href="{{ url_for('shopkeeper.manage_bills') }}"
                    class="text-sm text-[#ed6a3e] hover:text-orange-700 font-medium">View All</a>
            </div>
            <div class="overflow-x-auto">
                <div class="min-w-full">
                    {% if recent_bills %}
                    <div class="space-y-3">
                        {% for bill in recent_bills[:3] %}
                        <div
                            class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition duration-200">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between">
                                    <p class="text-sm font-medium text-gray-900 truncate">
                                        #{{ bill.bill_number }}
                                    </p>
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full ml-2
                                        {% if bill.payment_status == 'Paid' %}bg-green-100 text-green-800
                                        {% elif bill.payment_status == 'Unpaid' %}bg-red-100 text-red-800
                                        {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                        {{ bill.payment_status }}
                                    </span>
                                </div>
                                <div class="flex items-center justify-between mt-1">
                                    <p class="text-xs text-gray-500 truncate">
                                        {{ bill.customer_name|default('N/A') }}
                                    </p>
                                    <p class="text-sm font-bold text-gray-900 ml-2">₹{{ bill.total_amount }}</p>
                                </div>
                                <p class="text-xs text-gray-400">{{ bill.bill_date.strftime('%d %b, %Y') }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-8">
                        <i data-feather="file-text" class="w-12 h-12 text-gray-300 mx-auto mb-2"></i>
                        <p class="text-gray-500">No bills found</p>
                        <a href="{{ url_for('shopkeeper.create_bill') }}"
                            class="mt-2 inline-block text-[#ed6a3e] hover:text-orange-700 text-sm font-medium">
                            Create your first bill
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Info Cards for Mobile -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mt-6 md:mt-8">
        <!-- Low Stock Details -->
        {% if low_stock and low_stock|length > 0 %}
        <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 border border-gray-200">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <i data-feather="alert-triangle" class="text-red-500 mr-2 w-5 h-5"></i>
                    <span class="font-bold text-lg text-gray-800">Stock Alerts</span>
                </div>
                <a href="{{ url_for('shopkeeper.products_stock') }}"
                    class="text-sm bg-red-500 text-white px-3 py-1 rounded-full hover:bg-red-600 transition duration-300">
                    Update Stock
                </a>
            </div>
            <div class="space-y-2 max-h-48 overflow-y-auto custom-scrollbar">
                {% for product in low_stock %}
                <div class="flex items-center justify-between p-2 bg-red-50 rounded-lg">
                    <span class="text-sm font-medium text-gray-800 truncate">{{ product.product_name }}</span>
                    <span class="text-sm font-bold text-red-600">{{ product.stock_qty }} left</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Set current date and debug chart data
    document.addEventListener('DOMContentLoaded', function () {
        const today = new Date();
        const options = { day: '2-digit', month: 'short', year: 'numeric' };
        const dateElement = document.getElementById('current-date');
        if (dateElement) {
            dateElement.textContent = today.toLocaleDateString('en-GB', options);
        }

        // Debug chart data
        const chartDataElement = document.getElementById('chart-data');
        if (chartDataElement) {
            console.log('Chart data element found');
            console.log('Labels:', chartDataElement.getAttribute('data-labels'));
            console.log('Data:', chartDataElement.getAttribute('data-data'));
        } else {
            console.log('Chart data element not found');
        }
    });

    (function () {
        const ctx = document.getElementById('monthlySalesChart').getContext('2d');
        const monthlySalesData = JSON.parse('{{ monthly_sales_data | tojson }}');
        const monthlySalesLabels = JSON.parse('{{ monthly_sales_labels | tojson }}');

        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: monthlySalesLabels,
                datasets: [{
                    label: 'Monthly Sales (₹)',
                    data: monthlySalesData,
                    borderColor: '#ed6a3e',
                    backgroundColor: 'rgba(237, 106, 62, 0.2)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#e2e8f0' // Light gray grid lines
                        },
                        ticks: {
                            callback: function (value) {
                                return '₹' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    })();
</script>

<!-- Compass icon removed - walkthrough auto-starts for first-time users -->

<script>
    // Initialize feather icons
    feather.replace();
</script>
{% endblock %}