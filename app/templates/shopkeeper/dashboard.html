{% extends 'shopkeeper/s_base.html' %}
{% block title %}Shopkeeper Dashboard | MyBillingApp{% endblock %}
{% block content %}
<link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css">
<script src="https://unpkg.com/feather-icons"></script>
<div class="flex min-h-screen bg-gray-100">
    <aside
        class="fixed top-0 left-0 h-full w-64 bg-gradient-to-b from-[#ed6a3e] to-[#ed6a3e] shadow-lg flex flex-col justify-between z-20 mt-15">
        <div>
            <nav class="mt-5 flex-1">
                <ul class="space-y-2">
                    <li><a href="{{ url_for('shopkeeper.dashboard') }}"
                            class="flex items-center px-6 py-3 text-white font-semibold rounded-l-full bg-white/20 hover:bg-white/30 transition duration-300"><i
                                data-feather="home" class="mr-3"></i>Dashboard Home</a></li>
                    <li><a href="{{ url_for('shopkeeper.create_bill') }}"
                            class="flex items-center px-6 py-3 text-white hover:bg-white/20 rounded-l-full transition duration-300"><i
                                data-feather="file-plus" class="mr-3"></i>Create Bill</a></li>
                    <li><a href="{{ url_for('shopkeeper.manage_bills') }}"
                            class="flex items-center px-6 py-3 text-white hover:bg-white/20 rounded-l-full transition duration-300"><i
                                data-feather="file-text" class="mr-3"></i>Manage Bills</a></li>
                    <li><a href="{{ url_for('shopkeeper.products_stock') }}"
                            class="flex items-center px-6 py-3 text-white hover:bg-white/20 rounded-l-full transition duration-300"><i
                                data-feather="box" class="mr-3"></i>Products & Stock</a></li>
                    <li><a href="{{ url_for('shopkeeper.sales_reports') }}"
                            class="flex items-center px-6 py-3 text-white hover:bg-white/20 rounded-l-full transition duration-300"><i
                                data-feather="bar-chart-2" class="mr-3"></i>Sales Reports</a></li>
                    <li><a href="{{ url_for('shopkeeper.ca_marketplace') }}"
                            class="flex items-center px-6 py-3 text-white hover:bg-white/20 rounded-l-full transition duration-300"><i
                                data-feather="users" class="mr-3"></i>CA Marketplace</a></li>
                </ul>
            </nav>
        </div>
        <div class="p-4 text-xs text-white text-center opacity-70">&copy; {{ 2024 }} MyBillingApp</div>
    </aside>
    <main class="flex-1 ml-64 p-8 bg-gray-100 min-h-screen -mt-8">
        <div class="flex justify-between items-center mb-8">
            <div>
                <p class="text-3xl font-bold">Welcome, {{ current_user.username }}!</p>
            </div>
            <div class="flex items-center space-x-4">
                <a href="{{ url_for('shopkeeper.profile') }}"
                    class="flex items-center space-x-2 bg-white px-3 py-2 rounded-full shadow hover:bg-orange-50 transition duration-300">
                    <span class="font-semibold text-[#ed6a3e]">{{ current_user.username }}</span>
                    <div
                        class="bg-[#ed6a3e] text-white rounded-full w-8 h-8 flex items-center justify-center font-bold">
                        {{ current_user.username[0]|upper }}</div>
                </a>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-md p-6 flex flex-col justify-between">
                <div class="flex items-center mb-2"><i data-feather="dollar-sign" class="text-[#ed6a3e] mr-2"></i><span
                        class="font-bold text-lg">Today's Sales</span></div>
                <div class="text-2xl font-bold text-[#ed6a3e]">₹{{ total_amount|default(0.00) }}</div>
                <div class="flex space-x-2 mt-2">
                    <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs">Paid: {{ paid|default(0)
                        }}</span>
                    <span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs">Unpaid: {{ unpaid|default(0)
                        }}</span>
                    <span class="bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs">Partial: {{
                        partial|default(0) }}</span>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 flex flex-col justify-between">
                <div class="flex items-center mb-2">
                    <i data-feather="calendar" class="text-[#ed6a3e] mr-2"></i>
                    <span class="font-bold text-lg">This Month</span>
                </div>
                <div class="text-2xl font-bold text-[#ed6a3e]">₹{{ (monthly_total)| round(3) | default(0.00) }}</div>
                <div class="text-sm text-gray-600 mt-2">
                    Total Bills: {{ monthly_bills_count|default(0) }}
                </div>
                <div class="mt-4 bg-blue-50 text-blue-700 px-3 py-1 rounded text-sm">
                    {% if monthly_growth > 0 %}
                    <i data-feather="trending-up" class="w-4 h-4 inline mr-1"></i>
                    {% else %}
                    <i data-feather="trending-down" class="w-4 h-4 inline mr-1"></i>
                    {% endif %}
                    {{ monthly_growth|abs }}% vs last month
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 flex flex-col justify-between">
                <div class="flex items-center mb-2"><i data-feather="alert-triangle"
                        class="text-[#ed6a3e] mr-2"></i><span class="font-bold text-lg">Low Stock Alerts</span></div>
                <ul class="mt-2 space-y-1">
                    {% if low_stock and low_stock|length > 0 %}
                    {% for product in low_stock %}
                    <li class="text-red-600">{{ product.product_name }} (Stock: {{ product.stock_qty }})</li>
                    {% endfor %}
                    {% else %}
                    <li class="text-gray-500">No low stock products.</li>
                    {% endif %}
                </ul>
                <a href="{{ url_for('shopkeeper.products_stock') }}"
                    class="mt-4 bg-[#ed6a3e] text-white px-4 py-2 rounded shadow hover:bg-orange-700 transition duration-300 text-center">Update
                    Stock</a>
            </div>

            <div class="bg-white rounded-xl shadow-md p-6 flex flex-col justify-between">
                <div class="flex items-center mb-2">
                    <i data-feather="link" class="text-[#ed6a3e] mr-2"></i>
                    <span class="font-bold text-lg">CA Connection</span>
                </div>
                {% if connected_ca %}
                <div class="flex flex-col space-y-2">
                    <div class="text-gray-600">
                        <span class="font-medium">{{ connected_ca.firm_name }}</span>
                        <span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded ml-2">Connected</span>
                    </div>
                    <div class="text-sm text-gray-500">{{ connected_employees|length }} Employee(s) Assigned</div>
                    <a href="{{ url_for('shopkeeper.connected_ca_profile', ca_id=connected_ca.ca_id) }}"
                        class="mt-2 text-[#ed6a3e] hover:text-orange-700 text-sm flex items-center">
                        <span>View Profile</span>
                        <i data-feather="chevron-right" class="w-4 h-4 ml-1"></i>
                    </a>
                </div>
                {% else %}
                <div class="text-gray-500">No CA connected</div>
                <a href="{{ url_for('shopkeeper.ca_marketplace') }}"
                    class="mt-4 bg-[#ed6a3e] text-white px-4 py-2 rounded shadow hover:bg-orange-700 transition duration-300 text-center">Find
                    CA</a>
                {% endif %}
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center mb-4"><i data-feather="bar-chart-2" class="text-[#ed6a3e] mr-2"></i><span
                        class="font-bold text-lg">Sales Trends</span></div>
                <div class="h-64">
                    <canvas id="monthlySalesChart"></canvas>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center mb-4"><i data-feather="list" class="text-[#ed6a3e] mr-2"></i><span
                        class="font-bold text-lg">Recent Bills</span></div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bill #</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for bill in recent_bills %}
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ bill.bill_number }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ bill.customer_name|default('N/A') }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ bill.bill_date.strftime('%Y-%m-%d') }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">₹{{ bill.total_amount }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                                        {% if bill.payment_status == 'Paid' %}bg-green-100 text-green-800
                                        {% elif bill.payment_status == 'Unpaid' %}bg-red-100 text-red-800
                                        {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                        {{ bill.payment_status }}
                                    </span>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="px-6 py-4 text-center text-gray-500">No recent bills found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <a href="{{ url_for('shopkeeper.manage_bills') }}"
                   class="mt-4 block text-center text-sm font-medium text-orange-500 hover:text-orange-700 transition duration-300">
                    View All Bills &rarr;
                </a>
            </div>
        </div>
    </main>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    feather.replace();
    // Use an IIFE (Immediately Invoked Function Expression) to avoid global scope pollution
    (function() {
        const ctx = document.getElementById('monthlySalesChart').getContext('2d');
        const monthlySalesData = JSON.parse('{{ monthly_sales_data | tojson }}');
        const monthlySalesLabels = JSON.parse('{{ monthly_sales_labels | tojson }}');

        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: monthlySalesLabels,
                datasets: [{
                    label: 'Monthly Sales (₹)',
                    data: monthlySalesData,
                    borderColor: '#ed6a3e',
                    backgroundColor: 'rgba(237, 106, 62, 0.2)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#e2e8f0' // Light gray grid lines
                        },
                        ticks: {
                            callback: function(value) {
                                return '₹' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    })();
</script>
{% endblock %}