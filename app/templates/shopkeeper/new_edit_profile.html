{% extends 'shopkeeper/s_base.html' %}
{% block title %}Edit Profile | MyBillingApp{% endblock %}
{% block shop_name %} {{ shop_name }} {% endblock %}
{% block content %}
<link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css">
<script src="https://unpkg.com/feather-icons"></script>

<style>
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideInLeft {
        from {
            opacity: 0;
            transform: translateX(-50px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .fade-in-up {
        animation: fadeInUp 0.6s ease-out;
    }

    .slide-in-left {
        animation: slideInLeft 0.5s ease-out;
    }

    .fade-in {
        animation: fadeIn 0.4s ease-out;
    }

    .gradient-bg {
        background: linear-gradient(135deg, #eeeeee 0%, #eaecee 100%);
    }

    .edit-form-container {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .form-section {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .form-section:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .form-input {
        transition: all 0.3s ease;
    }

    .form-input:focus {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(237, 106, 62, 0.15);
    }
</style>

<div class="p-4 md:p-8 lg:-mt-8">
    <!-- Edit Mode Header -->
    <div class="fade-in gradient-bg rounded-2xl p-6 mb-8 border border-gray-200">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div class="p-3 bg-blue-100  rounded-xl shadow-lg">
                    <i data-feather="edit-3" class="w-6 h-6 text-blue-600"></i>
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Edit Profile</h1>
                    <p class="text-gray-600 hidden">Update your business and personal information</p>
                </div>
            </div>
            <a href="{{ url_for('shopkeeper.profile') }}"
                class="flex items-center justify-center space-x-2 px-2 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-gray-200 transition-colors duration-200 shadow-sm">

                <!-- Icon always visible -->
                <i data-feather="eye" class="w-4 h-4"></i>

                <!-- Text visible only on medium and larger screens -->
                <span class="hidden sm:inline">View Profile</span>
            </a>

        </div>
    </div>

    <div class="edit-form-container fade-in">
        <form method="POST" action="{{ url_for('shopkeeper.profile_edit') }}" enctype="multipart/form-data"
            class="space-y-8">

            <!-- Personal Information Section -->
            <div class="form-section bg-white rounded-2xl shadow-lg p-8 border border-pink-200">
                <div class="flex items-center mb-6">
                    <div class="p-3 bg-pink-100 rounded-xl shadow-lg">
                        <i data-feather="user" class="w-6 h-6 text-pink-600"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 ml-4">Personal Information</h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="owner_name" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i data-feather="user" class="w-4 h-4 inline mr-2 text-pink-500"></i>
                            Owner Name
                        </label>
                        <input type="text" id="owner_name" name="owner_name" value="{{ shopkeeper.owner_name or '' }}"
                            placeholder="Enter your full name"
                            class="form-input w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent transition duration-200 text-gray-700">
                    </div>

                    <div>
                        <label for="pan_number" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i data-feather="credit-card" class="w-4 h-4 inline mr-2 text-pink-500"></i>
                            PAN Number
                        </label>
                        <input type="text" id="pan_number" name="pan_number" value="{{ shopkeeper.pan_number or '' }}"
                            placeholder="Enter PAN (e.g., ABCDE1234F)" maxlength="10" pattern="[A-Z]{5}[0-9]{4}[A-Z]{1}"
                            title="Enter 10-character PAN: 5 letters + 4 digits + 1 letter"
                            class="form-input w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent transition duration-200 text-gray-700">
                    </div>

                    <div class="md:col-span-2">
                        <label for="owner_address" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i data-feather="home" class="w-4 h-4 inline mr-2 text-pink-500"></i>
                            Owner Address
                        </label>
                        <textarea id="owner_address" name="owner_address" rows="3"
                            placeholder="Enter your residential address"
                            class="form-input w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent transition duration-200 text-gray-700">{{ shopkeeper.owner_address or '' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Business Information Section -->
            <div class="form-section bg-white rounded-2xl shadow-lg p-8 border border-cyan-200">
                <div class="flex items-center mb-6">
                    <div class="p-3 bg-cyan-100 rounded-xl shadow-lg">
                        <i data-feather="briefcase" class="w-6 h-6 text-cyan-600"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 ml-4">Business Information</h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="shop_name" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i data-feather="store" class="w-4 h-4 inline mr-2 text-cyan-500"></i>
                            Shop Name <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="shop_name" name="shop_name" value="{{ shopkeeper.shop_name or '' }}"
                            placeholder="Enter your business name" required
                            class="form-input w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition duration-200 text-gray-700">
                    </div>

                    <div>
                        <label for="business_type" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i data-feather="tag" class="w-4 h-4 inline mr-2 text-cyan-500"></i>
                            Business Type
                        </label>
                        <input type="text" id="business_type" name="business_type"
                            value="{{ shopkeeper.business_type or shopkeeper.domain or '' }}"
                            placeholder="e.g., Retail, Wholesale, Services"
                            class="form-input w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition duration-200 text-gray-700">
                    </div>

                    <div>
                        <label for="established_year" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i data-feather="calendar" class="w-4 h-4 inline mr-2 text-cyan-500"></i>
                            Established Year
                        </label>
                        <input type="number" id="established_year" name="established_year"
                            value="{{ shopkeeper.established_year or '' }}" placeholder="Enter year (e.g., 2020)" min="1800"
                            max="2025" title="Enter establishment year between 1800 and 2025"
                            class="form-input w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition duration-200 text-gray-700">
                    </div>

                    <div>
                        <label for="gst_number" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i data-feather="award" class="w-4 h-4 inline mr-2 text-cyan-500"></i>
                            GST Number
                        </label>
                        <input type="text" id="gst_number" name="gst_number" value="{{ shopkeeper.gst_number or '' }}"
                            placeholder="Enter GST Number (e.g., 22AAAAA0000A1Z5)" maxlength="15"
                            pattern="[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}[Z]{1}[0-9A-Z]{1}"
                            title="Enter 15-character GST number"
                            class="form-input w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition duration-200 text-gray-700">
                    </div>

                    <div>
                        <label for="contact_number" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i data-feather="phone" class="w-4 h-4 inline mr-2 text-cyan-500"></i>
                            Contact Number
                        </label>
                        <input type="tel" id="contact_number" name="contact_number"
                            value="{{ shopkeeper.contact_number or '' }}" placeholder="Enter 10-digit mobile number"
                            maxlength="10" pattern="[6-9][0-9]{9}" title="Enter 10-digit mobile number starting with 6, 7, 8, or 9"
                            class="form-input w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition duration-200 text-gray-700">
                    </div>

                    <div class="md:col-span-2">
                        <label for="business_address" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i data-feather="map-pin" class="w-4 h-4 inline mr-2 text-cyan-500"></i>
                            Business Address
                        </label>
                        <textarea id="business_address" name="business_address" rows="3"
                            placeholder="Enter your business address"
                            class="form-input w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition duration-200 text-gray-700">{{ shopkeeper.business_address or shopkeeper.address or '' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Location Information Section -->
            <div class="form-section bg-white rounded-2xl shadow-lg p-8 border border-green-200">
                <div class="flex items-center mb-6">
                    <div class="p-3 bg-green-100 rounded-xl shadow-lg">
                        <i data-feather="map-pin" class="w-6 h-6 text-green-600"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 ml-4">Location Details</h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="city" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i data-feather="map" class="w-4 h-4 inline mr-2 text-green-500"></i>
                            City
                        </label>
                        <input type="text" id="city" name="city" value="{{ shopkeeper.city or '' }}"
                            placeholder="Enter your city"
                            class="form-input w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200 text-gray-700">
                    </div>

                    <div>
                        <label for="state" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i data-feather="globe" class="w-4 h-4 inline mr-2 text-green-500"></i>
                            State
                        </label>
                        <input type="text" id="state" name="state" value="{{ shopkeeper.state or '' }}"
                            placeholder="Enter your state"
                            class="form-input w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200 text-gray-700">
                    </div>

                    <div>
                        <label for="pincode" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i data-feather="hash" class="w-4 h-4 inline mr-2 text-green-500"></i>
                            Pincode
                        </label>
                        <input type="text" id="pincode" name="pincode" value="{{ shopkeeper.pincode or '' }}"
                            placeholder="Enter 6-digit pincode" maxlength="6" pattern="[1-9][0-9]{5}"
                            title="Enter valid 6-digit pincode"
                            class="form-input w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent transition duration-200 text-gray-700">
                    </div>
                </div>
            </div>

            <!-- Banking Information Section -->
            <div class="form-section bg-white rounded-2xl shadow-lg p-8 border border-purple-200">
                <div class="flex items-center mb-6">
                    <div class="p-3 bg-purple-100 rounded-xl shadow-lg">
                        <i data-feather="credit-card" class="w-6 h-6 text-purple-600"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 ml-4">Banking Information</h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="bank_name" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i data-feather="home" class="w-4 h-4 inline mr-2 text-purple-500"></i>
                            Bank Name
                        </label>
                        <input type="text" id="bank_name" name="bank_name" value="{{ shopkeeper.bank_name or '' }}"
                            placeholder="e.g., State Bank of India"
                            class="form-input w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200 text-gray-700">
                    </div>

                    <div>
                        <label for="account_number" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i data-feather="hash" class="w-4 h-4 inline mr-2 text-purple-500"></i>
                            Account Number
                        </label>
                        <input type="text" id="account_number" name="account_number"
                            value="{{ shopkeeper.account_number or '' }}" placeholder="Enter bank account number (9-18 digits)"
                            maxlength="18" pattern="[0-9]{9,18}" title="Enter bank account number (9-18 digits)"
                            class="form-input w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200 text-gray-700">
                    </div>

                    <div>
                        <label for="ifsc_code" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i data-feather="code" class="w-4 h-4 inline mr-2 text-purple-500"></i>
                            IFSC Code
                        </label>
                        <input type="text" id="ifsc_code" name="ifsc_code" value="{{ shopkeeper.ifsc_code or '' }}"
                            placeholder="Enter IFSC code (e.g., SBIN0000123)" maxlength="11" pattern="[A-Z]{4}0[A-Z0-9]{6}"
                            title="Enter 11-character IFSC code"
                            class="form-input w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200 text-gray-700">
                    </div>

                    <div>
                        <label for="upi_id" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i data-feather="smartphone" class="w-4 h-4 inline mr-2 text-purple-500"></i>
                            UPI ID
                        </label>
                        <input type="text" id="upi_id" name="upi_id" value="{{ shopkeeper.upi_id or '' }}"
                            placeholder="Enter UPI ID (e.g., yourname@paytm)" pattern="[\w.-]+@[\w.-]+"
                            title="Enter valid UPI ID (username@provider)"
                            class="form-input w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200 text-gray-700">
                    </div>
                </div>
            </div>

            <!-- Document Upload Section -->
            <div class="form-section bg-white rounded-2xl shadow-lg p-8 border border-gray-200">
                <div class="flex items-center mb-6">
                    <div class="p-3 bg-gray-100 rounded-xl shadow-lg">
                        <i data-feather="folder" class="w-6 h-6 text-gray-600"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 ml-4">Business Documents</h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- GST Certificate -->
                    <div
                        class="document-upload-card p-6 bg-gray-50 rounded-xl border border-gray-200 hover:border-blue-400 transition-colors">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                <i data-feather="award" class="w-5 h-5 text-blue-600"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">GST Certificate</h3>
                                <p class="text-xs text-gray-600">Tax registration document</p>
                            </div>
                        </div>
                        {% if shopkeeper.gst_doc_path %}
                        <div class="mb-3">
                            <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Currently
                                Uploaded</span>
                            <a href="{{ url_for('static', filename=shopkeeper.gst_doc_path) }}" target="_blank"
                                class="text-blue-600 hover:text-blue-800 text-xs ml-2">
                                <i data-feather="external-link" class="w-3 h-3 inline mr-1"></i>View
                            </a>
                        </div>
                        {% endif %}
                        <input type="file" name="gst_doc" accept=".pdf,.jpg,.jpeg,.png"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                        <p class="text-xs text-gray-500 mt-1">PDF, JPG, PNG (Max 2MB)</p>
                        {% if shopkeeper.gst_doc_path %}
                        <button type="button" onclick="deleteDocument('gst')"
                            class="mt-2 text-red-600 hover:text-red-800 text-xs">
                            <i data-feather="trash-2" class="w-3 h-3 inline mr-1"></i>Delete Current
                        </button>
                        {% endif %}
                    </div>

                    <!-- PAN Card -->
                    <div
                        class="document-upload-card p-6 bg-gray-50 rounded-xl border border-gray-200 hover:border-green-400 transition-colors">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                                <i data-feather="credit-card" class="w-5 h-5 text-green-600"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">PAN Card</h3>
                                <p class="text-xs text-gray-600">Tax identification</p>
                            </div>
                        </div>
                        {% if shopkeeper.pan_doc_path %}
                        <div class="mb-3">
                            <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Currently
                                Uploaded</span>
                            <a href="{{ url_for('static', filename=shopkeeper.pan_doc_path) }}" target="_blank"
                                class="text-blue-600 hover:text-blue-800 text-xs ml-2">
                                <i data-feather="external-link" class="w-3 h-3 inline mr-1"></i>View
                            </a>
                        </div>
                        {% endif %}
                        <input type="file" name="pan_doc" accept=".pdf,.jpg,.jpeg,.png"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm">
                        <p class="text-xs text-gray-500 mt-1">PDF, JPG, PNG (Max 2MB)</p>
                        {% if shopkeeper.pan_doc_path %}
                        <button type="button" onclick="deleteDocument('pan')"
                            class="mt-2 text-red-600 hover:text-red-800 text-xs">
                            <i data-feather="trash-2" class="w-3 h-3 inline mr-1"></i>Delete Current
                        </button>
                        {% endif %}
                    </div>

                    <!-- Address Proof -->
                    <div
                        class="document-upload-card p-6 bg-gray-50 rounded-xl border border-gray-200 hover:border-purple-400 transition-colors">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                                <i data-feather="map-pin" class="w-5 h-5 text-purple-600"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">Address Proof</h3>
                                <p class="text-xs text-gray-600">Business address verification</p>
                            </div>
                        </div>
                        {% if shopkeeper.address_proof_path %}
                        <div class="mb-3">
                            <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Currently
                                Uploaded</span>
                            <a href="{{ url_for('static', filename=shopkeeper.address_proof_path) }}" target="_blank"
                                class="text-blue-600 hover:text-blue-800 text-xs ml-2">
                                <i data-feather="external-link" class="w-3 h-3 inline mr-1"></i>View
                            </a>
                        </div>
                        {% endif %}
                        <input type="file" name="address_proof" accept=".pdf,.jpg,.jpeg,.png"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm">
                        <p class="text-xs text-gray-500 mt-1">PDF, JPG, PNG (Max 2MB)</p>
                        {% if shopkeeper.address_proof_path %}
                        <button type="button" onclick="deleteDocument('address_proof')"
                            class="mt-2 text-red-600 hover:text-red-800 text-xs">
                            <i data-feather="trash-2" class="w-3 h-3 inline mr-1"></i>Delete Current
                        </button>
                        {% endif %}
                    </div>

                    <!-- Aadhaar/DL -->
                    <div
                        class="document-upload-card p-6 bg-gray-50 rounded-xl border border-gray-200 hover:border-yellow-400 transition-colors">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center mr-3">
                                <i data-feather="user-check" class="w-5 h-5 text-yellow-600"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">Aadhaar/DL</h3>
                                <p class="text-xs text-gray-600">Identity proof document</p>
                            </div>
                        </div>
                        {% if shopkeeper.aadhaar_dl_path %}
                        <div class="mb-3">
                            <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Currently
                                Uploaded</span>
                            <a href="{{ url_for('static', filename=shopkeeper.aadhaar_dl_path) }}" target="_blank"
                                class="text-blue-600 hover:text-blue-800 text-xs ml-2">
                                <i data-feather="external-link" class="w-3 h-3 inline mr-1"></i>View
                            </a>
                        </div>
                        {% endif %}
                        <input type="file" name="aadhaar_dl" accept=".pdf,.jpg,.jpeg,.png"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-sm">
                        <p class="text-xs text-gray-500 mt-1">PDF, JPG, PNG (Max 2MB)</p>
                        {% if shopkeeper.aadhaar_dl_path %}
                        <button type="button" onclick="deleteDocument('aadhaar_dl')"
                            class="mt-2 text-red-600 hover:text-red-800 text-xs">
                            <i data-feather="trash-2" class="w-3 h-3 inline mr-1"></i>Delete Current
                        </button>
                        {% endif %}
                    </div>

                    <!-- Selfie Photo -->
                    <div
                        class="document-upload-card p-6 bg-gray-50 rounded-xl border border-gray-200 hover:border-pink-400 transition-colors">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-pink-100 rounded-lg flex items-center justify-center mr-3">
                                <i data-feather="camera" class="w-5 h-5 text-pink-600"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">Owner Selfie</h3>
                                <p class="text-xs text-gray-600">Photo verification</p>
                            </div>
                        </div>
                        {% if shopkeeper.selfie_path %}
                        <div class="mb-3">
                            <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Currently
                                Uploaded</span>
                            <a href="{{ url_for('static', filename=shopkeeper.selfie_path) }}" target="_blank"
                                class="text-blue-600 hover:text-blue-800 text-xs ml-2">
                                <i data-feather="external-link" class="w-3 h-3 inline mr-1"></i>View
                            </a>
                        </div>
                        {% endif %}
                        <input type="file" name="selfie" accept=".jpg,.jpeg,.png"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent text-sm">
                        <p class="text-xs text-gray-500 mt-1">JPG, PNG only (Max 2MB)</p>
                        {% if shopkeeper.selfie_path %}
                        <button type="button" onclick="deleteDocument('selfie')"
                            class="mt-2 text-red-600 hover:text-red-800 text-xs">
                            <i data-feather="trash-2" class="w-3 h-3 inline mr-1"></i>Delete Current
                        </button>
                        {% endif %}
                    </div>

                    <!-- Gumasta License -->
                    <div
                        class="document-upload-card p-6 bg-gray-50 rounded-xl border border-gray-200 hover:border-red-400 transition-colors">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center mr-3">
                                <i data-feather="file-text" class="w-5 h-5 text-red-600"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">Gumasta License</h3>
                                <p class="text-xs text-gray-600">Business license document</p>
                            </div>
                        </div>
                        {% if shopkeeper.gumasta_path %}
                        <div class="mb-3">
                            <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Currently
                                Uploaded</span>
                            <a href="{{ url_for('static', filename=shopkeeper.gumasta_path) }}" target="_blank"
                                class="text-blue-600 hover:text-blue-800 text-xs ml-2">
                                <i data-feather="external-link" class="w-3 h-3 inline mr-1"></i>View
                            </a>
                        </div>
                        {% endif %}
                        <input type="file" name="gumasta" accept=".pdf,.jpg,.jpeg,.png"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm">
                        <p class="text-xs text-gray-500 mt-1">PDF, JPG, PNG (Max 2MB)</p>
                        {% if shopkeeper.gumasta_path %}
                        <button type="button" onclick="deleteDocument('gumasta')"
                            class="mt-2 text-red-600 hover:text-red-800 text-xs">
                            <i data-feather="trash-2" class="w-3 h-3 inline mr-1"></i>Delete Current
                        </button>
                        {% endif %}
                    </div>

                    <!-- Udyam Registration -->
                    <div
                        class="document-upload-card p-6 bg-gray-50 rounded-xl border border-gray-200 hover:border-orange-400 transition-colors">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center mr-3">
                                <i data-feather="briefcase" class="w-5 h-5 text-orange-600"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">Udyam Registration</h3>
                                <p class="text-xs text-gray-600">MSME certificate</p>
                            </div>
                        </div>
                        {% if shopkeeper.udyam_path %}
                        <div class="mb-3">
                            <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Currently
                                Uploaded</span>
                            <a href="{{ url_for('static', filename=shopkeeper.udyam_path) }}" target="_blank"
                                class="text-blue-600 hover:text-blue-800 text-xs ml-2">
                                <i data-feather="external-link" class="w-3 h-3 inline mr-1"></i>View
                            </a>
                        </div>
                        {% endif %}
                        <input type="file" name="udyam" accept=".pdf,.jpg,.jpeg,.png"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-sm">
                        <p class="text-xs text-gray-500 mt-1">PDF, JPG, PNG (Max 2MB)</p>
                        {% if shopkeeper.udyam_path %}
                        <button type="button" onclick="deleteDocument('udyam')"
                            class="mt-2 text-red-600 hover:text-red-800 text-xs">
                            <i data-feather="trash-2" class="w-3 h-3 inline mr-1"></i>Delete Current
                        </button>
                        {% endif %}
                    </div>

                    <!-- Bank Statement -->
                    <div
                        class="document-upload-card p-6 bg-gray-50 rounded-xl border border-gray-200 hover:border-indigo-400 transition-colors">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center mr-3">
                                <i data-feather="trending-up" class="w-5 h-5 text-indigo-600"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">Bank Statement</h3>
                                <p class="text-xs text-gray-600">Financial proof document</p>
                            </div>
                        </div>
                        {% if shopkeeper.bank_statement_path %}
                        <div class="mb-3">
                            <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Currently
                                Uploaded</span>
                            <a href="{{ url_for('static', filename=shopkeeper.bank_statement_path) }}" target="_blank"
                                class="text-blue-600 hover:text-blue-800 text-xs ml-2">
                                <i data-feather="external-link" class="w-3 h-3 inline mr-1"></i>View
                            </a>
                        </div>
                        {% endif %}
                        <input type="file" name="bank_statement" accept=".pdf,.jpg,.jpeg,.png"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm">
                        <p class="text-xs text-gray-500 mt-1">PDF, JPG, PNG (Max 2MB)</p>
                        {% if shopkeeper.bank_statement_path %}
                        <button type="button" onclick="deleteDocument('bank_statement')"
                            class="mt-2 text-red-600 hover:text-red-800 text-xs">
                            <i data-feather="trash-2" class="w-3 h-3 inline mr-1"></i>Delete Current
                        </button>
                        {% endif %}
                    </div>

                    <!-- Business Logo -->
                    <div
                        class="document-upload-card p-6 bg-gray-50 rounded-xl border border-gray-200 hover:border-cyan-400 transition-colors">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-cyan-100 rounded-lg flex items-center justify-center mr-3">
                                <i data-feather="image" class="w-5 h-5 text-cyan-600"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">Business Logo</h3>
                                <p class="text-xs text-gray-600">Brand identity image</p>
                            </div>
                        </div>
                        {% if shopkeeper.logo_path %}
                        <div class="mb-3">
                            <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Currently
                                Uploaded</span>
                            <a href="{{ url_for('static', filename=shopkeeper.logo_path) }}" target="_blank"
                                class="text-blue-600 hover:text-blue-800 text-xs ml-2">
                                <i data-feather="external-link" class="w-3 h-3 inline mr-1"></i>View
                            </a>
                        </div>
                        {% endif %}
                        <input type="file" name="logo" accept=".jpg,.jpeg,.png,.svg"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent text-sm">
                        <p class="text-xs text-gray-500 mt-1">JPG, PNG, SVG (Max 2MB)</p>
                        {% if shopkeeper.logo_path %}
                        <button type="button" onclick="deleteDocument('logo')"
                            class="mt-2 text-red-600 hover:text-red-800 text-xs">
                            <i data-feather="trash-2" class="w-3 h-3 inline mr-1"></i>Delete Current
                        </button>
                        {% endif %}
                    </div>
                </div>

                <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <i data-feather="info" class="w-5 h-5 text-blue-600 mt-0.5"></i>
                        </div>
                        <div class="ml-3">
                            <h4 class="text-sm font-semibold text-blue-800">Document Upload Guidelines</h4>
                            <div class="mt-2 text-sm text-blue-700">
                                <ul class="list-disc list-inside space-y-1">
                                    <li>Maximum file size: 2MB per document</li>
                                    <li>Supported formats: PDF, JPG, JPEG, PNG (SVG for logo only)</li>
                                    <li>Ensure documents are clear and readable</li>
                                    <li>All documents help verify your business for better CA connections</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bill Template Settings Section -->
            <div class="form-section bg-white rounded-2xl shadow-lg p-8 border border-indigo-200">
                <div class="flex items-center mb-6">
                    <div class="p-3 bg-indigo-100 rounded-xl shadow-lg">
                        <i data-feather="file-text" class="w-6 h-6 text-indigo-600"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 ml-4">Bill Template Settings</h2>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Template Selection -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Choose Template</h3>
                        <div class="space-y-4">
                            <!-- Basic Template Option -->
                            <div class="template-option border-2 border-gray-300 rounded-xl p-4 cursor-pointer hover:border-indigo-400 transition-all duration-300" 
                                 data-template="template1"
                                 onclick="selectTemplate('template1')">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-12 h-16 bg-white border border-gray-200 rounded overflow-hidden shadow-sm">
                                            <img src="{{ url_for('static', filename='images/bill-templates/basic-bill-template.png') }}" 
                                                 alt="Basic Template" 
                                                 class="w-full h-full object-contain">
                                        </div>
                                        <div>
                                            <h4 class="font-medium text-gray-800">Basic Template</h4>
                                            <p class="text-sm text-gray-600">Simple and clean design</p>
                                        </div>
                                    </div>
                                    <input type="radio" 
                                           id="template1" 
                                           name="template_choice" 
                                           value="template1" 
                                           {{ 'checked' if shopkeeper.template_choice == 'template1' else '' }}
                                           class="w-4 h-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                </div>
                            </div>

                            <!-- Professional Template Option -->
                            <div class="template-option border-2 border-gray-300 rounded-xl p-4 cursor-pointer hover:border-indigo-400 transition-all duration-300" 
                                 data-template="template2"
                                 onclick="selectTemplate('template2')">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-12 h-16 bg-white border border-gray-200 rounded overflow-hidden shadow-sm">
                                            <img src="{{ url_for('static', filename='images/bill-templates/professional-bill-template.png') }}" 
                                                 alt="Professional Template" 
                                                 class="w-full h-full object-contain">
                                        </div>
                                        <div>
                                            <h4 class="font-medium text-gray-800">Professional Template</h4>
                                            <p class="text-sm text-gray-600">Elegant design with advanced formatting</p>
                                        </div>
                                    </div>
                                    <input type="radio" 
                                           id="template2" 
                                           name="template_choice" 
                                           value="template2" 
                                           {{ 'checked' if shopkeeper.template_choice == 'template2' or not shopkeeper.template_choice else '' }}
                                           class="w-4 h-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                </div>
                            </div>

                            <!-- Modern Template Option -->
                            <div class="template-option border-2 border-gray-300 rounded-xl p-4 cursor-pointer hover:border-indigo-400 transition-all duration-300" 
                                 data-template="template3"
                                 onclick="selectTemplate('template3')">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-12 h-16 bg-white border border-gray-200 rounded overflow-hidden shadow-sm">
                                            <img src="{{ url_for('static', filename='images/bill-templates/modern-bill-template.png') }}" 
                                                 alt="Modern Template" 
                                                 class="w-full h-full object-contain">
                                        </div>
                                        <div>
                                            <h4 class="font-medium text-gray-800">Modern Template</h4>
                                            <p class="text-sm text-gray-600">Contemporary design with modern elements</p>
                                        </div>
                                    </div>
                                    <input type="radio" 
                                           id="template3" 
                                           name="template_choice" 
                                           value="template3" 
                                           {{ 'checked' if shopkeeper.template_choice == 'template3' else '' }}
                                           class="w-4 h-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Live Preview -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Live Preview</h3>
                        <div class="bg-gray-50 rounded-xl p-6 border-2 border-gray-200">
                            <!-- Loading State -->
                            <div id="templatePreviewLoading" class="hidden flex items-center justify-center h-64">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                                <span class="ml-3 text-gray-600">Loading preview...</span>
                            </div>
                            
                            <!-- Preview Content -->
                            <div id="templatePreviewContent" class="text-center">
                                <div class="w-full max-w-sm mx-auto bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden">
                                    <img id="templatePreviewImage" 
                                         src="{{ url_for('static', filename='images/bill-templates/' + (
                                             'basic-bill-template.png' if shopkeeper.template_choice == 'template1' else
                                             'modern-bill-template.png' if shopkeeper.template_choice == 'template3' else
                                             'professional-bill-template.png'
                                         )) }}" 
                                         alt="Template Preview" 
                                         class="w-full h-auto object-contain"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="w-full h-64 hidden items-center justify-center bg-gray-100 text-gray-400">
                                        <i data-feather="image" class="w-12 h-12"></i>
                                        <p class="ml-2">Preview not available</p>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <h4 id="previewTitle" class="font-semibold text-gray-800 text-lg">
                                        {% if shopkeeper.template_choice == 'template1' %}
                                            Basic Template
                                        {% elif shopkeeper.template_choice == 'template3' %}
                                            Modern Template
                                        {% else %}
                                            Professional Template
                                        {% endif %}
                                    </h4>
                                    <p id="previewDescription" class="text-sm text-gray-600 mt-1">
                                        {% if shopkeeper.template_choice == 'template1' %}
                                            Simple and clean design
                                        {% elif shopkeeper.template_choice == 'template3' %}
                                            Contemporary design with modern elements
                                        {% else %}
                                            Elegant design with advanced formatting
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Invoice Numbering Settings Section -->
            <div class="form-section bg-white rounded-2xl shadow-lg p-8 border border-emerald-200">
                <div class="flex items-center mb-6">
                    <div class="p-3 bg-emerald-100 rounded-xl shadow-lg">
                        <i data-feather="hash" class="w-6 h-6 text-emerald-600"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 ml-4">Invoice Numbering Settings</h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="invoice_prefix" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i data-feather="tag" class="w-4 h-4 inline mr-2 text-emerald-500"></i>
                            Invoice Prefix
                        </label>
                        <input type="text" id="invoice_prefix" name="invoice_prefix"
                            value="{{ shopkeeper.invoice_prefix or '' }}"
                            placeholder="e.g., INV, BILL (leave empty for timestamp)" maxlength="10"
                            class="form-input w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition duration-200 text-gray-700">
                        <p class="text-xs text-gray-500 mt-1">Leave empty to use timestamp-based numbering
                            (BILL123456789)</p>
                    </div>

                    <div>
                        <label for="invoice_starting_number" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i data-feather="play" class="w-4 h-4 inline mr-2 text-emerald-500"></i>
                            Starting Number
                        </label>
                        <input type="number" id="invoice_starting_number" name="invoice_starting_number"
                            value="{{ shopkeeper.invoice_starting_number or 1 }}" placeholder="1" min="1"
                            class="form-input w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition duration-200 text-gray-700">
                        <p class="text-xs text-gray-500 mt-1">Reset numbering to start from this number</p>
                    </div>

                    <div class="md:col-span-2">
                        <div class="bg-emerald-50 border border-emerald-200 rounded-xl p-4">
                            <div class="flex items-start">
                                <div class="flex-shrink-0">
                                    <i data-feather="info" class="w-5 h-5 text-emerald-600 mt-0.5"></i>
                                </div>
                                <div class="ml-3">
                                    <h4 class="text-sm font-semibold text-emerald-800">Invoice Numbering Preview</h4>
                                    <div class="mt-2 text-sm text-emerald-700">
                                        <p><strong>Current System:</strong>
                                            <span id="current-preview">
                                                {% if shopkeeper.invoice_prefix and shopkeeper.invoice_prefix.strip() %}
                                                Custom: {{ shopkeeper.invoice_prefix }}{{
                                                '%02d'|format(shopkeeper.current_invoice_number)}}
                                                {% else %}
                                                Timestamp-based (BILL123456789)
                                                {% endif %}
                                            </span>
                                        </p>
                                        <p><strong>Next Invoice:</strong>
                                            <span id="next-preview">
                                                {% if shopkeeper.invoice_prefix and shopkeeper.invoice_prefix.strip() %}
                                                {{ preview_next_invoice_number(shopkeeper) }}
                                                {% else %}
                                                Will be generated automatically
                                                {% endif %}
                                            </span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-section bg-white rounded-2xl shadow-lg p-6 border border-gray-200">
                <div class="flex flex-col md:flex-row gap-4 md:justify-end">
                    <a href="{{ url_for('shopkeeper.profile') }}"
                        class="flex items-center justify-center px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl transition duration-300 font-medium border border-gray-300">
                        <i data-feather="x" class="w-4 h-4 mr-2"></i>
                        Cancel
                    </a>
                    <button type="submit"
                        class="flex items-center justify-center px-8 py-3 bg-orange-200 hover:bg-orange-300 text-orange-600 rounded-xl transition duration-300 font-semibold shadow-lg hover:shadow-xl">
                        <i data-feather="save" class="w-4 h-4 mr-2"></i>
                        Save Changes
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    // Initialize Feather icons
    feather.replace();

    // Add form validation and dynamic preview
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize feather icons after DOM is loaded
        feather.replace();

        // Template selection preview (updated for new UI)
        const templatePreview = document.getElementById('template-preview');

        function updateTemplatePreview() {
            // This function is kept for compatibility but the new UI handles preview differently
            const checkedTemplate = document.querySelector('input[name="template_choice"]:checked');
            if (!checkedTemplate) return;
            
            const selected = checkedTemplate.value;
            if (templatePreview) {
                switch (selected) {
                    case 'template1':
                        templatePreview.textContent = 'Basic Format - Simple layout with essential details';
                        break;
                    case 'template2':
                        templatePreview.textContent = 'Professional Format - Enhanced design with business branding';
                        break;
                    case 'template3':
                        templatePreview.textContent = 'Modern Format - Contemporary design with advanced features';
                        break;
                    default:
                        templatePreview.textContent = 'Professional Format';
                }
            }
            
            // Also update the new preview if it exists
            if (document.getElementById('templatePreviewImage')) {
                updateEditTemplatePreview(selected);
                updateTemplateSelection();
            }
        }

        // Template selection functions for new UI
        window.selectTemplate = function(templateValue) {
            // Update radio button
            const radioButton = document.getElementById(templateValue);
            if (radioButton) {
                radioButton.checked = true;
            }
            
            // Update visual selection
            updateTemplateSelection();
            
            // Update preview
            updateEditTemplatePreview(templateValue);
        };

        function updateTemplateSelection() {
            const selectedTemplate = document.querySelector('input[name="template_choice"]:checked');
            const templateOptions = document.querySelectorAll('.template-option');
            
            templateOptions.forEach(option => {
                option.classList.remove('border-indigo-500', 'bg-indigo-50');
                option.classList.add('border-gray-300');
            });
            
            if (selectedTemplate) {
                const selectedOption = document.querySelector(`[data-template="${selectedTemplate.value}"]`);
                if (selectedOption) {
                    selectedOption.classList.remove('border-gray-300');
                    selectedOption.classList.add('border-indigo-500', 'bg-indigo-50');
                }
            }
        }

        function updateEditTemplatePreview(templateValue) {
            const previewImage = document.getElementById('templatePreviewImage');
            const previewTitle = document.getElementById('previewTitle');
            const previewDescription = document.getElementById('previewDescription');
            const previewLoading = document.getElementById('templatePreviewLoading');
            const previewContent = document.getElementById('templatePreviewContent');
            
            // Show loading state
            previewLoading.classList.remove('hidden');
            previewContent.classList.add('opacity-50');
            
            let imagePath, title, description;
            
            switch(templateValue) {
                case 'template1':
                    imagePath = '/static/images/bill-templates/basic-bill-template.png';
                    title = 'Basic Template';
                    description = 'Simple and clean design';
                    break;
                case 'template3':
                    imagePath = '/static/images/bill-templates/modern-bill-template.png';
                    title = 'Modern Template';
                    description = 'Contemporary design with modern elements';
                    break;
                default: // template2
                    imagePath = '/static/images/bill-templates/professional-bill-template.png';
                    title = 'Professional Template';
                    description = 'Elegant design with advanced formatting';
                    break;
            }
            
            // Update preview with animation
            setTimeout(() => {
                previewImage.src = imagePath;
                previewTitle.textContent = title;
                previewDescription.textContent = description;
                previewLoading.classList.add('hidden');
                previewContent.classList.remove('opacity-50');
            }, 300);
        }

        // Add click listeners to radio buttons
        document.querySelectorAll('input[name="template_choice"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    selectTemplate(this.value);
                }
            });
        });

        // Initialize template selection styling
        updateTemplateSelection();

        // Invoice numbering preview
        const prefixInput = document.getElementById('invoice_prefix');
        const startingNumberInput = document.getElementById('invoice_starting_number');
        const currentPreview = document.getElementById('current-preview');
        const nextPreview = document.getElementById('next-preview');

        function updateInvoicePreview() {
            const prefix = prefixInput.value.trim();
            const startingNumber = parseInt(startingNumberInput.value) || 1;

            if (prefix) {
                const formattedNumber = String(startingNumber).padStart(2, '0');
                currentPreview.textContent = `Custom: ${prefix}${formattedNumber}`;
                nextPreview.textContent = `${prefix}${String(startingNumber + 1).padStart(2, '0')}`;
            } else {
                currentPreview.textContent = 'Timestamp-based (BILL123456789)';
                nextPreview.textContent = 'Will be generated automatically';
            }
        }

        prefixInput.addEventListener('input', updateInvoicePreview);
        startingNumberInput.addEventListener('input', updateInvoicePreview);

        // Form validation
        const form = document.querySelector('form');
        form.addEventListener('submit', function (e) {
            const shopName = document.getElementById('shop_name').value.trim();

            if (!shopName) {
                e.preventDefault();
                alert('Shop name is required!');
                document.getElementById('shop_name').focus();
                return false;
            }

        // Clean up empty numeric fields before submission
        const numericFields = ['established_year', 'invoice_starting_number'];
        numericFields.forEach(fieldName => {
            const field = document.getElementById(fieldName);
            if (field) {
                const value = field.value.trim();
                if (value === '' || value === '0' || isNaN(value)) {
                    field.value = '';  // Ensure it's truly empty for optional fields
                }
            }
        });

        // Clean up text fields - remove extra whitespace but preserve content
        const textFields = ['pan_number', 'gst_number', 'ifsc_code', 'pincode', 'contact_number', 'upi_id', 'account_number'];
        textFields.forEach(fieldName => {
            const field = document.getElementById(fieldName);
            if (field) {
                // Trim whitespace and convert to uppercase for PAN, GST, IFSC
                if (['pan_number', 'gst_number', 'ifsc_code'].includes(fieldName)) {
                    field.value = field.value.trim().toUpperCase();
                } else if (fieldName === 'contact_number') {
                    // Remove any non-digit characters
                    const digitsOnly = field.value.replace(/\D/g, '');
                    field.value = digitsOnly;
                } else {
                    field.value = field.value.trim();
                }
            }
        });            // PAN validation - only check format if value is provided
            const panNumber = document.getElementById('pan_number').value.trim();
            if (panNumber && panNumber.length > 0 && panNumber != None) {
                const panPattern = /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/;
                if (!panPattern.test(panNumber)) {
                    e.preventDefault();
                    alert('Please enter a valid PAN number (e.g., ABCDE1234F)');
                    document.getElementById('pan_number').focus();
                    return false;
                }
            }

            // GST validation - only check format if value is provided
            const gstNumber = document.getElementById('gst_number').value.trim();
            if (gstNumber && gstNumber.length > 0 && gstNumber != None) {
                const gstPattern = /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}[Z]{1}[0-9A-Z]{1}$/;
                if (!gstPattern.test(gstNumber)) {
                    e.preventDefault();
                    alert('Please enter a valid GST number (e.g., 22AAAAA0000A1Z5)');
                    document.getElementById('gst_number').focus();
                    return false;
                }
            }

            // Established Year validation - only check format if value is provided
            const establishedYear = document.getElementById('established_year').value.trim();
            if (establishedYear && establishedYear.length > 0 && establishedYear != None) {
                const year = parseInt(establishedYear);
                const currentYear = new Date().getFullYear();
                if (isNaN(year) || year < 1800 || year > currentYear) {
                    e.preventDefault();
                    alert(`Please enter a valid year between 1800 and ${currentYear}`);
                    document.getElementById('established_year').focus();
                    return false;
                }
            }

            // Pincode validation - only check format if value is provided
            const pincode = document.getElementById('pincode').value.trim();
            if (pincode && pincode.length > 0 && pincode != None) {
                const pincodePattern = /^[1-9][0-9]{5}$/;
                if (!pincodePattern.test(pincode)) {
                    e.preventDefault();
                    alert('Please enter a valid 6-digit pincode');
                    document.getElementById('pincode').focus();
                    return false;
                }
            }

            // IFSC validation - only check format if value is provided
            const ifscCode = document.getElementById('ifsc_code').value.trim();
            if (ifscCode && ifscCode.length > 0 && ifscCode != None) {
                const ifscPattern = /^[A-Z]{4}0[A-Z0-9]{6}$/;
                if (!ifscPattern.test(ifscCode)) {
                    e.preventDefault();
                    alert('Please enter a valid IFSC code (e.g., SBIN0000123)');
                    document.getElementById('ifsc_code').focus();
                    return false;
                }
            }

            // Invoice starting number validation - only check format if value is provided
            const invoiceStartNum = document.getElementById('invoice_starting_number').value.trim();
            if (invoiceStartNum && invoiceStartNum.length > 0 && invoiceStartNum != None) {
                const startNum = parseInt(invoiceStartNum);
                if (isNaN(startNum) || startNum <= 0) {
                    e.preventDefault();
                    alert('Please enter a valid positive number for invoice starting number');
                    document.getElementById('invoice_starting_number').focus();
                    return false;
                }
            }

            // Contact number validation - only check format if value is provided
            const contactNumber = document.getElementById('contact_number').value.trim();
            if (contactNumber && contactNumber.length > 0 ** contactNumber != None  ) {
                // Remove any non-digit characters for validation
                const digitsOnly = contactNumber.replace(/\D/g, '');
                const phonePattern = /^[6-9]\d{9}$/;
                if (!phonePattern.test(digitsOnly)) {
                    e.preventDefault();
                    alert('Please enter a valid 10-digit mobile number starting with 6, 7, 8, or 9');
                    document.getElementById('contact_number').focus();
                    return false;
                }
                // Update the input value to contain only digits
                document.getElementById('contact_number').value = digitsOnly;
            }

            // UPI ID validation - only check format if value is provided
            const upiId = document.getElementById('upi_id').value.trim();
            if (upiId && upiId.length > 0 && upiId != None) {
                const upiPattern = /^[\w.-]+@[\w.-]+$/;
                if (!upiPattern.test(upiId)) {
                    e.preventDefault();
                    alert('Please enter a valid UPI ID (e.g., yourname@paytm)');
                    document.getElementById('upi_id').focus();
                    return false;
                }
            }

            // Account number validation - only check if value is provided
            const accountNumber = document.getElementById('account_number').value.trim();
            if (accountNumber && accountNumber.length > 0 && accountNumber != None) {
                const accountPattern = /^[0-9]{9,18}$/;
                if (!accountPattern.test(accountNumber)) {
                    e.preventDefault();
                    alert('Please enter a valid bank account number (9-18 digits)');
                    document.getElementById('account_number').focus();
                    return false;
                }
            }

            // File size validation for document uploads
            const fileInputs = document.querySelectorAll('input[type="file"]');
            for (let input of fileInputs) {
                if (input.files.length > 0) {
                    const file = input.files[0];
                    const maxSize = 2 * 1024 * 1024; // 2MB
                    if (file.size > maxSize) {
                        e.preventDefault();
                        alert(`File "${file.name}" is too large. Maximum size allowed is 2MB.`);
                        input.focus();
                        return false;
                    }
                }
            }
        });

        // Document deletion functionality
        function deleteDocument(docType) {
            if (confirm('Are you sure you want to delete this document? This action cannot be undone.')) {
                fetch(`/shopkeeper/delete_document/${docType}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload(); // Reload page to show updated state
                        } else {
                            alert('Error deleting document: ' + data.message);
                        }
                    })
                    .catch(error => {
                        alert('Error deleting document. Please try again.');
                        console.error('Error:', error);
                    });
            }
        }

        // File input validation on change
        document.querySelectorAll('input[type="file"]').forEach(input => {
            input.addEventListener('change', function () {
                const maxSize = 2 * 1024 * 1024; // 2MB
                if (this.files[0] && this.files[0].size > maxSize) {
                    alert('File size must be less than 2MB. Please choose a smaller file.');
                    this.value = '';
                    return false;
                }
            });
        });

        // Real-time input formatting and validation
        
        // PAN number formatting
        const panInput = document.getElementById('pan_number');
        if (panInput) {
            panInput.addEventListener('input', function() {
                // Convert to uppercase and limit to 10 characters
                this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 10);
            });
        }

        // GST number formatting
        const gstInput = document.getElementById('gst_number');
        if (gstInput) {
            gstInput.addEventListener('input', function() {
                // Convert to uppercase and limit to 15 characters
                this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 15);
            });
        }

        // IFSC code formatting
        const ifscInput = document.getElementById('ifsc_code');
        if (ifscInput) {
            ifscInput.addEventListener('input', function() {
                // Convert to uppercase and limit to 11 characters
                this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 11);
            });
        }

        // Contact number formatting
        const contactInput = document.getElementById('contact_number');
        if (contactInput) {
            contactInput.addEventListener('input', function() {
                // Allow only digits and limit to 10 characters
                this.value = this.value.replace(/\D/g, '').substring(0, 10);
            });
        }

        // Pincode formatting
        const pincodeInput = document.getElementById('pincode');
        if (pincodeInput) {
            pincodeInput.addEventListener('input', function() {
                // Allow only digits and limit to 6 characters
                this.value = this.value.replace(/\D/g, '').substring(0, 6);
            });
        }

        // Account number formatting
        const accountInput = document.getElementById('account_number');
        if (accountInput) {
            accountInput.addEventListener('input', function() {
                // Allow only digits and limit to 18 characters
                this.value = this.value.replace(/\D/g, '').substring(0, 18);
            });
        }

        // Established year formatting
        const yearInput = document.getElementById('established_year');
        if (yearInput) {
            yearInput.addEventListener('input', function() {
                // Allow only digits and limit to 4 characters
                this.value = this.value.replace(/\D/g, '').substring(0, 4);
            });
        }

        // Invoice starting number formatting
        const invoiceInput = document.getElementById('invoice_starting_number');
        if (invoiceInput) {
            invoiceInput.addEventListener('input', function() {
                // Allow only positive digits
                this.value = this.value.replace(/\D/g, '');
                if (this.value && parseInt(this.value) <= 0) {
                    this.value = '';
                }
            });
        }

        // Add hover effects to form sections
        const formSections = document.querySelectorAll('.form-section');
        formSections.forEach(section => {
            section.addEventListener('mouseenter', function () {
                this.style.transform = 'translateY(-2px)';
                this.style.boxShadow = '0 10px 20px rgba(0, 0, 0, 0.1)';
            });

            section.addEventListener('mouseleave', function () {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '';
            });
        });
    });
</script>

{% endblock %}