<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit Bill - {{ bill.bill_number }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            .no-print {
                display: none;
            }
        }
        .editable-field {
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 2px 6px;
            background-color: #f9fafb;
            transition: all 0.2s ease;
        }
        .editable-field:hover {
            background-color: #f3f4f6;
            border-color: #9ca3af;
        }
        .editable-field:focus {
            outline: none;
            background-color: white;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .readonly-field {
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .calculated-field {
            background-color: #ecfdf5;
            border: 1px solid #a7f3d0;
            font-weight: 600;
        }
        .gst-column {
            transition: all 0.3s ease;
        }
        .hide-gst .gst-column {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="max-w-4xl mx-auto bg-white p-6 mt-10 rounded shadow-lg">
        <!-- Header with action buttons -->
        <div class="mb-4 flex justify-between items-center no-print">
            <a href="{{ url_for('shopkeeper.view_bill', bill_id=bill.bill_id) }}" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                ‚Üê Cancel
            </a>
            <div>
                <button onclick="saveBill()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                    Save Changes
                </button>
            </div>
        </div>

        <form id="editBillForm" method="POST" action="{{ url_for('shopkeeper.update_bill', bill_id=bill.bill_id) }}">
            <!-- Header Templates -->
            {% if shopkeeper.template_choice == 'template1' %}
            <!-- Template 1: Classic Left-Aligned -->
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center">
                    {% if shopkeeper.logo_path %}
                    <img src="{{ url_for('static', filename=shopkeeper.logo_path) }}" alt="Shop Logo" class="h-16 mr-4">
                    {% endif %}
                    <h1 class="text-3xl font-bold text-gray-900">{{ shopkeeper.shop_name }}</h1>
                </div>
                <div class="text-right">
                    <p class="text-xl font-semibold text-gray-800">Invoice</p>
                    <p class="text-gray-600">{{ bill.bill_number }}</p>
                    <p class="text-gray-600">Date: {{ bill.bill_date }}</p>
                </div>
            </div>
            {% elif shopkeeper.template_choice == 'template3' %}
            <!-- Template 3: Compact & Minimalist -->
            <div class="flex justify-between items-center mb-6">
                <div>
                    {% if shopkeeper.logo_path %}
                    <img src="{{ url_for('static', filename=shopkeeper.logo_path) }}" alt="Shop Logo" class="h-12 mb-2">
                    {% endif %}
                    <h1 class="text-2xl font-bold text-gray-900">{{ shopkeeper.shop_name }}</h1>
                </div>
                <div class="flex gap-4 text-sm">
                    <p><span class="font-semibold">Invoice #:</span> {{ bill.bill_number }}</p>
                    <p><span class="font-semibold">Date:</span> {{ bill.bill_date }}</p>
                </div>
            </div>
            {% else %}
            <!-- Template 2: Modern Centered (Default) -->
            <div class="text-center mb-6">
                {% if shopkeeper.logo_path %}
                <img src="{{ url_for('static', filename=shopkeeper.logo_path) }}" alt="Shop Logo" class="h-16 mx-auto mb-2">
                {% endif %}
                <h1 class="text-3xl font-bold text-gray-900">{{ shopkeeper.shop_name }}</h1>
                <p class="text-gray-600">Invoice {{ bill.bill_number }}</p>
                <p class="text-gray-600">Date: {{ bill.bill_date }}</p>
            </div>
            {% endif %}

            <!-- From and To section -->
            <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                <div class="border p-4 rounded">
                    <h2 class="font-semibold mb-2">From:</h2>
                    <p>Name: {{ shopkeeper.shop_name }}</p>
                    <p>Contact: {{ shopkeeper.contact_number }}</p>
                    <p>Address: {{ shopkeeper.address }}</p>
                    <p>GSTIN: {{ shopkeeper.gst_number }}</p>
                </div>
                <div class="border p-4 rounded">
                    <h2 class="font-semibold mb-2">To:</h2>
                    <p>Name: <input type="text" name="customer_name" value="{{ bill.customer_name }}" 
                                  class="editable-field inline-block min-w-48" onchange="updateBillTotals()"></p>
                    <p>Contact: <input type="text" name="customer_contact" value="{{ bill.customer_contact }}" 
                                      class="editable-field inline-block min-w-48" onchange="updateBillTotals()"></p>
                    {% if bill.customer_address %}
                    <p>Address: <input type="text" name="customer_address" value="{{ bill.customer_address }}" 
                                      class="editable-field inline-block min-w-48" onchange="updateBillTotals()"></p>
                    {% endif %}
                    {% if bill.customer_gstin %}
                    <p>GSTIN: <input type="text" name="customer_gstin" value="{{ bill.customer_gstin }}" 
                                    class="editable-field inline-block min-w-48" onchange="updateBillTotals()"></p>
                    {% endif %}
                </div>
            </div>

            <!-- Bill Configuration Section -->
            <div class="mb-6 p-4 border rounded bg-yellow-50">
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <label class="block font-semibold mb-1">GST Type:</label>
                        <select name="bill_gst_type" class="editable-field w-full" onchange="onBillGstTypeChange()">
                            <option value="GST" {{ 'selected' if bill.gst_type == 'GST' else '' }}>GST Bill</option>
                            <option value="Non-GST" {{ 'selected' if bill.gst_type == 'Non-GST' else '' }}>Non-GST Bill</option>
                        </select>
                    </div>
                    <div id="gstModeSection">
                        <label class="block font-semibold mb-1">GST Mode:</label>
                        <select name="gst_mode" id="gstModeSelect" class="editable-field w-full" onchange="updateAllRowTotals()">
                            <option value="EXCLUSIVE" {{ 'selected' if bill.gst_mode == 'EXCLUSIVE' else '' }}>Exclusive (Price + GST)</option>
                            <option value="INCLUSIVE" {{ 'selected' if bill.gst_mode == 'INCLUSIVE' else '' }}>Inclusive (Price includes GST)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Payment Status Section -->
            <div class="mb-6 p-4 border rounded bg-blue-50">
                <div class="grid grid-cols-3 gap-4 text-sm">
                    <div>
                        <label class="block font-semibold mb-1">Payment Status:</label>
                        <select name="payment_status" class="editable-field w-full" onchange="onPaymentStatusChange()">
                            <option value="Paid" {{ 'selected' if bill.payment_status == 'Paid' else '' }}>Paid</option>
                            <option value="Partial" {{ 'selected' if bill.payment_status == 'Partial' else '' }}>Partial</option>
                            <option value="Unpaid" {{ 'selected' if bill.payment_status == 'Unpaid' else '' }}>Unpaid</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-semibold mb-1">Paid Amount:</label>
                        <input type="number" name="paid_amount" value="{{ bill.paid_amount|round(2) }}" 
                               step="0.01" min="0" class="editable-field w-full" onchange="onPaidAmountChange()">
                    </div>
                    <div>
                        <label class="block font-semibold mb-1">Due Amount:</label>
                        <input type="number" name="due_amount" id="dueAmountInput" value="{{ bill.due_amount|round(2) }}" 
                               step="0.01" min="0" class="readonly-field w-full" readonly>
                    </div>
                </div>
            </div>

            <!-- GST Summary Table -->
            <h2 class="text-lg font-semibold mb-2">GST Summary</h2>
            <div class="overflow-x-auto">
                <table class="w-full border text-sm text-left" id="itemsTable">
                    <thead class="bg-orange-100 text-orange-700">
                        <tr>
                            <th class="p-2 min-w-36 border">Item</th>
                            <th class="p-2 border">HSN Code</th>
                            <th class="p-2 border text-right">Quantity</th>
                            <th class="p-2 border text-right">Unit Price</th>
                            <th class="p-2 border text-right">Discount %</th>
                            <th class="p-2 border text-right">Discounted Price</th>
                            <th class="p-2 border text-right gst-column">GST Rate %</th>
                            <th class="p-2 border text-center gst-column" colspan="2">SGST/UTGST</th>
                            <th class="p-2 border text-center gst-column" colspan="2">CGST</th>
                            <th class="p-2 border text-right">Sub Total</th>
                            <th class="p-2 border text-center">Action</th>
                        </tr>
                        <tr>
                            <th class="p-2 border"></th>
                            <th class="p-2 border"></th>
                            <th class="p-2 border text-right"></th>
                            <th class="p-2 border text-right"></th>
                            <th class="p-2 border text-right"></th>
                            <th class="p-2 border text-right"></th>
                            <th class="p-2 border text-right gst-column"></th>
                            <th class="p-2 border text-right gst-column">Rate (%)</th>
                            <th class="p-2 border text-right gst-column">Amt</th>
                            <th class="p-2 border text-right gst-column">Rate (%)</th>
                            <th class="p-2 border text-right gst-column">Amt</th>
                            <th class="p-2 border text-right"></th>
                            <th class="p-2 border text-center"></th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                        {% for item_data in bill_items_data %}
                        <tr class="border-t item-row" data-index="{{ loop.index0 }}">
                            <td class="p-2 border">
                                <input type="text" name="product_name[]" value="{{ item_data.product.product_name }}" 
                                       class="editable-field w-full" onchange="updateRowTotals(this)">
                                <input type="hidden" name="product_id[]" value="{{ item_data.product.product_id if not item_data.is_custom else '' }}">
                            </td>
                            <td class="p-2 min-w-20 border">
                                <input type="text" name="hsn_code[]" value="{{ item_data.hsn_code }}" 
                                       class="editable-field w-full" onchange="updateRowTotals(this)">
                            </td>
                            <td class="p-2 border text-right">
                                <input type="number" name="quantity[]" value="{{ item_data.quantity }}" 
                                       min="1" class="editable-field w-20 text-right" onchange="updateRowTotals(this)">
                            </td>
                            <td class="p-2 border text-right">
                                <input type="number" name="unit_price[]" value="{{ item_data.unit_price|round(2) }}" 
                                       step="0.01" min="0.01" class="editable-field w-24 text-right" onchange="updateRowTotals(this)">
                            </td>
                            <td class="p-2 border text-right">
                                <input type="number" name="discount_percent[]" value="{{ item_data.discount_percent }}" 
                                       step="0.01" min="0" max="100" class="editable-field w-20 text-right" onchange="updateRowTotals(this)">
                            </td>
                            <td class="p-2 border text-right">
                                <span class="calculated-field inline-block px-2 py-1 rounded taxable-amount">‚Çπ{{ item_data.taxable_amount|round(2) }}</span>
                            </td>
                            <td class="p-2 border text-right gst-column">
                                <input type="number" name="gst_rate[]" value="{{ item_data.gst_rate|round(2) }}" 
                                       step="0.01" min="0" max="100" class="editable-field w-16 text-right" onchange="updateRowTotals(this)">
                            </td>
                            <td class="p-2 border text-right gst-column">
                                <span class="calculated-field inline-block px-2 py-1 rounded sgst-rate">{{ (item_data.sgst_rate)|round(2) }}</span>
                            </td>
                            <td class="p-2 border text-right gst-column">
                                <span class="calculated-field inline-block px-2 py-1 rounded sgst-amount">‚Çπ{{ item_data.sgst_amount|round(2) }}</span>
                            </td>
                            <td class="p-2 border text-right gst-column">
                                <span class="calculated-field inline-block px-2 py-1 rounded cgst-rate">{{ item_data.cgst_rate|round(2) }}</span>
                            </td>
                            <td class="p-2 border text-right gst-column">
                                <span class="calculated-field inline-block px-2 py-1 rounded cgst-amount">‚Çπ{{ item_data.cgst_amount|round(2) }}</span>
                            </td>
                            <td class="p-2 border text-right">
                                <span class="calculated-field inline-block px-2 py-1 rounded font-bold final-total">‚Çπ{{ item_data.final_total|round(2) }}</span>
                            </td>
                            <td class="p-2 border text-center">
                                <button type="button" onclick="removeRow(this)" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs">
                                    Remove
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Add Item Button -->
            <div class="mt-2 mb-4">
                <button type="button" onclick="addNewRow()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm">
                    + Add Item
                </button>
            </div>

            <!-- Summary Table (Totals) -->
            <table class="w-full text-sm mt-4 border" id="summaryTable">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-2 border">Total Taxable Amount</th>
                        <th class="p-2 border gst-column">GST Rate</th>
                        <th class="p-2 border gst-column">CGST</th>
                        <th class="p-2 border gst-column">SGST</th>
                        <th class="p-2 border gst-column">Total GST</th>
                        <th class="p-2 border">Grand Total</th>
                    </tr>
                </thead>
                <tbody id="summaryTableBody">
                    {% for gst_rate, summary in gst_summary_by_rate.items() %}
                    <tr data-gst-rate="{{ gst_rate }}">
                        <td class="p-2 border summary-taxable">‚Çπ{{ summary.taxable_amount|round(2) }}</td>
                        <td class="p-2 border gst-column">{{ gst_rate }}%</td>
                        <td class="p-2 border gst-column summary-cgst">‚Çπ{{ summary.cgst_amount|round(2) }}</td>
                        <td class="p-2 border gst-column summary-sgst">‚Çπ{{ summary.sgst_amount|round(2) }}</td>
                        <td class="p-2 border gst-column summary-total-gst">‚Çπ{{ summary.total_gst_amount|round(2) }}</td>
                        <td class="p-2 border"></td>
                    </tr>
                    {% endfor %}
                    <!-- Grand Total Row -->
                    <tr class="bg-gray-50 font-bold">
                        <td class="p-2 border" id="grandTaxableAmount">‚Çπ{{ total_taxable_amount|round(2) }}</td>
                        <td class="p-2 border gst-column"></td>
                        <td class="p-2 border gst-column" id="grandCGSTAmount">‚Çπ{{ total_cgst_amount|round(2) }}</td>
                        <td class="p-2 border gst-column" id="grandSGSTAmount">‚Çπ{{ total_sgst_amount|round(2) }}</td>
                        <td class="p-2 border gst-column" id="grandGSTAmount">‚Çπ{{ total_gst_amount|round(2) }}</td>
                        <td class="p-2 border font-bold text-right" id="grandTotalAmount">‚Çπ{{ overall_grand_total|round(2) }}</td>
                    </tr>
                </tbody>
            </table>

            <!-- Bank details -->
            <div class="mt-6 text-sm">
                <h2 class="font-semibold mb-2">Bank Details:</h2>
                <p>Bank Name: {{ shopkeeper.bank_name or '' }}</p>
                <p>Account Number: {{ shopkeeper.account_number or '' }}</p>
                <p>IFSC Code: {{ shopkeeper.ifsc_code or '' }}</p>
            </div>

            <!-- Footer -->
            <div class="text-center text-xs text-gray-400 mt-4">
                Thank you for shopping with us!
            </div>

            <!-- Hidden inputs for totals -->
            <input type="hidden" name="total_taxable_amount" id="hiddenTaxableAmount" value="{{ total_taxable_amount|round(2) }}">
            <input type="hidden" name="total_cgst_amount" id="hiddenCGSTAmount" value="{{ total_cgst_amount|round(2) }}">
            <input type="hidden" name="total_sgst_amount" id="hiddenSGSTAmount" value="{{ total_sgst_amount|round(2) }}">
            <input type="hidden" name="total_gst_amount" id="hiddenGSTAmount" value="{{ total_gst_amount|round(2) }}">
            <input type="hidden" name="grand_total" id="hiddenGrandTotal" value="{{ overall_grand_total|round(2) }}">
        </form>
    </div>

    <script>
        function updateRowTotals(element) {
            const row = element.closest('.item-row');
            const quantity = parseFloat(row.querySelector('input[name="quantity[]"]').value) || 0;
            const unitPrice = parseFloat(row.querySelector('input[name="unit_price[]"]').value) || 0;
            const discountPercent = parseFloat(row.querySelector('input[name="discount_percent[]"]').value) || 0;
            const gstRate = parseFloat(row.querySelector('input[name="gst_rate[]"]').value) || 0;

            // Get GST mode and bill type from form selectors
            const gstMode = document.getElementById('gstModeSelect').value || 'EXCLUSIVE';
            const billGstType = document.querySelector('select[name="bill_gst_type"]').value;
            
            let lineBaseTotal, taxableAmount, finalTotal;
            
            // Handle Non-GST bills first
            if (billGstType === 'Non-GST') {
                // For Non-GST bills, ignore GST calculations entirely
                lineBaseTotal = unitPrice * quantity;
                const discountAmount = (lineBaseTotal * discountPercent) / 100;
                taxableAmount = lineBaseTotal - discountAmount;
                finalTotal = taxableAmount; // No GST added
                
                // Update displayed values for Non-GST
                row.querySelector('.taxable-amount').textContent = '‚Çπ' + taxableAmount.toFixed(2);
                row.querySelector('.sgst-rate').textContent = '0.00';
                row.querySelector('.sgst-amount').textContent = '‚Çπ0.00';
                row.querySelector('.cgst-rate').textContent = '0.00';
                row.querySelector('.cgst-amount').textContent = '‚Çπ0.00';
                row.querySelector('.final-total').textContent = '‚Çπ' + finalTotal.toFixed(2);
                
                console.log(`Non-GST calculation - Price: ${unitPrice}, Qty: ${quantity}, Discount: ${discountPercent}%`);
                console.log(`Result - Taxable: ‚Çπ${taxableAmount.toFixed(2)}, Final: ‚Çπ${finalTotal.toFixed(2)}`);
                
                updateBillTotals();
                return;
            }
            
            // GST Bill calculations
            if (gstMode.toUpperCase() === 'INCLUSIVE') {
                // INCLUSIVE Mode: Following user's exact formula
                // 1. Total Price (incl. GST) = Price √ó Quantity
                const totalPriceInclGST = unitPrice * quantity;
                
                // 2. Base Price = Total Price √∑ (1 + GST/100)
                if (gstRate === 0) {
                    lineBaseTotal = totalPriceInclGST;
                } else {
                    const divisor = 1 + (gstRate / 100);
                    lineBaseTotal = totalPriceInclGST / divisor;
                }
                
                // 3. Discount = Base Price √ó (Discount% / 100)
                const discountAmount = (lineBaseTotal * discountPercent) / 100;
                
                // 4. Taxable Amount = Base Price - Discount
                taxableAmount = lineBaseTotal - discountAmount;
                
            } else {
                // EXCLUSIVE Mode: Following user's exact formula
                // 1. Base Price = Price √ó Quantity
                lineBaseTotal = unitPrice * quantity;
                
                // 2. Discount = Base Price √ó (Discount% / 100)
                const discountAmount = (lineBaseTotal * discountPercent) / 100;
                
                // 3. Taxable Amount = Base Price - Discount
                taxableAmount = lineBaseTotal - discountAmount;
            }
            
            // 5. Calculate GST on Taxable Amount (same for both modes)
            let sgstAmount = 0, cgstAmount = 0, totalGST = 0;
            
            if (gstRate > 0) {
                // Split GST equally between CGST and SGST (intra-state model)
                const halfRate = gstRate / 2;
                sgstAmount = (taxableAmount * halfRate) / 100;
                cgstAmount = (taxableAmount * halfRate) / 100;
                totalGST = sgstAmount + cgstAmount;
            }
            
            // 6. Final Price = Taxable Amount + GST
            finalTotal = taxableAmount + totalGST;

            // Update displayed values with proper rounding
            row.querySelector('.taxable-amount').textContent = '‚Çπ' + taxableAmount.toFixed(2);
            row.querySelector('.sgst-rate').textContent = (gstRate / 2).toFixed(2);
            row.querySelector('.sgst-amount').textContent = '‚Çπ' + sgstAmount.toFixed(2);
            row.querySelector('.cgst-rate').textContent = (gstRate / 2).toFixed(2);
            row.querySelector('.cgst-amount').textContent = '‚Çπ' + cgstAmount.toFixed(2);
            row.querySelector('.final-total').textContent = '‚Çπ' + finalTotal.toFixed(2);

            console.log(`Row calculation - Mode: ${gstMode}, Price: ${unitPrice}, Qty: ${quantity}, Discount: ${discountPercent}%, GST: ${gstRate}%`);
            console.log(`Result - Taxable: ‚Çπ${taxableAmount.toFixed(2)}, GST: ‚Çπ${totalGST.toFixed(2)}, Final: ‚Çπ${finalTotal.toFixed(2)}`);

            // Update bill totals
            updateBillTotals();
        }

        function updateBillTotals() {
            let totalTaxable = 0;
            let totalCGST = 0;
            let totalSGST = 0;
            let totalGST = 0;
            let grandTotal = 0;

            // Calculate totals from all rows
            document.querySelectorAll('.item-row').forEach(row => {
                const taxableText = row.querySelector('.taxable-amount').textContent.replace('‚Çπ', '');
                const cgstText = row.querySelector('.cgst-amount').textContent.replace('‚Çπ', '');
                const sgstText = row.querySelector('.sgst-amount').textContent.replace('‚Çπ', '');
                const finalText = row.querySelector('.final-total').textContent.replace('‚Çπ', '');

                totalTaxable += parseFloat(taxableText) || 0;
                totalCGST += parseFloat(cgstText) || 0;
                totalSGST += parseFloat(sgstText) || 0;
                grandTotal += parseFloat(finalText) || 0;
            });

            totalGST = totalCGST + totalSGST;

            // Update summary table
            document.getElementById('grandTaxableAmount').textContent = '‚Çπ' + totalTaxable.toFixed(2);
            document.getElementById('grandCGSTAmount').textContent = '‚Çπ' + totalCGST.toFixed(2);
            document.getElementById('grandSGSTAmount').textContent = '‚Çπ' + totalSGST.toFixed(2);
            document.getElementById('grandGSTAmount').textContent = '‚Çπ' + totalGST.toFixed(2);
            document.getElementById('grandTotalAmount').textContent = '‚Çπ' + grandTotal.toFixed(2);

            // Update hidden inputs
            document.getElementById('hiddenTaxableAmount').value = totalTaxable.toFixed(2);
            document.getElementById('hiddenCGSTAmount').value = totalCGST.toFixed(2);
            document.getElementById('hiddenSGSTAmount').value = totalSGST.toFixed(2);
            document.getElementById('hiddenGSTAmount').value = totalGST.toFixed(2);
            document.getElementById('hiddenGrandTotal').value = grandTotal.toFixed(2);

            // Update payment fields
            updatePaymentFields();
        }

        function updatePaymentFields() {
            const grandTotal = parseFloat(document.getElementById('hiddenGrandTotal').value) || 0;
            const paidAmount = parseFloat(document.querySelector('input[name="paid_amount"]').value) || 0;
            const paymentStatus = document.querySelector('select[name="payment_status"]').value;
            const dueAmountInput = document.getElementById('dueAmountInput');

            // For Partial status, due amount is always readonly and calculated automatically
            // Only paid amount is editable in Partial status
            dueAmountInput.classList.remove('editable-field');
            dueAmountInput.classList.add('readonly-field');
            dueAmountInput.setAttribute('readonly', true);

            // Calculate due amount based on payment status
            let dueAmount;
            if (paymentStatus === 'Paid') {
                // Paid: paid amount = grand total, due = 0
                document.querySelector('input[name="paid_amount"]').value = grandTotal.toFixed(2);
                dueAmount = 0;
            } else if (paymentStatus === 'Unpaid') {
                // Unpaid: paid amount = 0, due = grand total
                document.querySelector('input[name="paid_amount"]').value = '0.00';
                dueAmount = grandTotal;
            } else {
                // Partial: due amount = grand total - paid amount (automatic calculation)
                dueAmount = grandTotal - paidAmount;
            }

            dueAmountInput.value = Math.max(0, dueAmount).toFixed(2);

            console.log(`Payment Update - Status: ${paymentStatus}, Grand Total: ‚Çπ${grandTotal}, Paid: ‚Çπ${paidAmount}, Due: ‚Çπ${dueAmount}`);
        }

        function onPaymentStatusChange() {
            updatePaymentFields();
        }

        function onPaidAmountChange() {
            const paymentStatus = document.querySelector('select[name="payment_status"]').value;
            if (paymentStatus !== 'Partial') {
                // Auto-update payment status based on paid amount
                const grandTotal = parseFloat(document.getElementById('hiddenGrandTotal').value) || 0;
                const paidAmount = parseFloat(document.querySelector('input[name="paid_amount"]').value) || 0;
                
                if (paidAmount >= grandTotal) {
                    document.querySelector('select[name="payment_status"]').value = 'Paid';
                } else if (paidAmount > 0) {
                    document.querySelector('select[name="payment_status"]').value = 'Partial';
                } else {
                    document.querySelector('select[name="payment_status"]').value = 'Unpaid';
                }
            }
            updatePaymentFields();
        }



        function removeRow(button) {
            if (document.querySelectorAll('.item-row').length > 1) {
                button.closest('.item-row').remove();
                updateBillTotals();
            } else {
                alert('At least one item is required in the bill.');
            }
        }

        function addNewRow() {
            const tbody = document.getElementById('itemsTableBody');
            const newIndex = tbody.children.length;
            
            const newRow = document.createElement('tr');
            newRow.className = 'border-t item-row';
            newRow.setAttribute('data-index', newIndex);
            
            newRow.innerHTML = `
                <td class="p-2 border">
                    <input type="text" name="product_name[]" value="" 
                           class="editable-field w-full" onchange="updateRowTotals(this)" placeholder="Product Name">
                    <input type="hidden" name="product_id[]" value="">
                </td>
                <td class="p-2 border">
                    <input type="text" name="hsn_code[]" value="" 
                           class="editable-field w-full" onchange="updateRowTotals(this)" placeholder="HSN Code">
                </td>
                <td class="p-2 border text-right">
                    <input type="number" name="quantity[]" value="1" 
                           min="1" class="editable-field w-20 text-right" onchange="updateRowTotals(this)">
                </td>
                <td class="p-2 border text-right">
                    <input type="number" name="unit_price[]" value="0.00" 
                           step="0.01" min="0.01" class="editable-field w-24 text-right" onchange="updateRowTotals(this)">
                </td>
                <td class="p-2 border text-right">
                    <input type="number" name="discount_percent[]" value="0" 
                           step="0.01" min="0" max="100" class="editable-field w-20 text-right" onchange="updateRowTotals(this)">
                </td>
                <td class="p-2 border text-right">
                    <span class="calculated-field inline-block px-2 py-1 rounded taxable-amount">‚Çπ0.00</span>
                </td>
                <td class="p-2 border text-right gst-column">
                    <input type="number" name="gst_rate[]" value="18" 
                           step="0.01" min="0" max="100" class="editable-field w-16 text-right" onchange="updateRowTotals(this)">
                </td>
                <td class="p-2 border text-right gst-column">
                    <span class="calculated-field inline-block px-2 py-1 rounded sgst-rate">9.00</span>
                </td>
                <td class="p-2 border text-right gst-column">
                    <span class="calculated-field inline-block px-2 py-1 rounded sgst-amount">‚Çπ0.00</span>
                </td>
                <td class="p-2 border text-right gst-column">
                    <span class="calculated-field inline-block px-2 py-1 rounded cgst-rate">9.00</span>
                </td>
                <td class="p-2 border text-right gst-column">
                    <span class="calculated-field inline-block px-2 py-1 rounded cgst-amount">‚Çπ0.00</span>
                </td>
                <td class="p-2 border text-right">
                    <span class="calculated-field inline-block px-2 py-1 rounded font-bold final-total">‚Çπ0.00</span>
                </td>
                <td class="p-2 border text-center">
                    <button type="button" onclick="removeRow(this)" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs">
                        Remove
                    </button>
                </td>
            `;
            
            tbody.appendChild(newRow);
            updateBillTotals();
        }

        function updateAllRowTotals() {
            // Update all rows when GST mode changes
            document.querySelectorAll('.item-row').forEach(row => {
                const firstInput = row.querySelector('input');
                if (firstInput) {
                    updateRowTotals(firstInput);
                }
            });
        }

        function onBillGstTypeChange() {
            const billGstType = document.querySelector('select[name="bill_gst_type"]').value;
            const itemsTable = document.getElementById('itemsTable');
            const summaryTable = document.getElementById('summaryTable');
            const gstModeSection = document.getElementById('gstModeSection');
            
            if (billGstType === 'Non-GST') {
                // Hide GST columns and GST mode selector
                itemsTable.classList.add('hide-gst');
                summaryTable.classList.add('hide-gst');
                gstModeSection.style.display = 'none';
            } else {
                // Show GST columns and GST mode selector
                itemsTable.classList.remove('hide-gst');
                summaryTable.classList.remove('hide-gst');
                gstModeSection.style.display = 'block';
            }
            
            // Update all calculations
            updateAllRowTotals();
        }

        function saveBill() {
            // Validate form
            let isValid = true;
            const requiredFields = document.querySelectorAll('input[required], select[required]');
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.style.borderColor = '#ef4444';
                    isValid = false;
                } else {
                    field.style.borderColor = '#d1d5db';
                }
            });

            // Check if at least one item exists
            if (document.querySelectorAll('.item-row').length === 0) {
                alert('At least one item is required in the bill.');
                return;
            }

            if (isValid) {
                document.getElementById('editBillForm').submit();
            } else {
                alert('Please fill in all required fields.');
            }
        }

        // Initialize calculations on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize GST column visibility based on bill type
            onBillGstTypeChange();
            updateBillTotals();
        });
    </script>
</body>
</html>