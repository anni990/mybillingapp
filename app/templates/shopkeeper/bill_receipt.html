<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bill Receipt - {{ bill.bill_number }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        @media print {
            .no-print {
                display: none !important;
            }
            
            /* Print-specific table styling */
            .overflow-x-auto {
                overflow-x: visible !important;
            }
            
            table {
                width: 100% !important;
                table-layout: fixed !important;
                font-size: 12px !important;
            }
            
            th, td {
                padding: 4px 2px !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                hyphens: auto !important;
            }
            
            /* Adjust column widths for better print layout */
            .gst-table th:nth-child(1), .gst-table td:nth-child(1) { width: 16% !important; } /* Item */
            .gst-table th:nth-child(2), .gst-table td:nth-child(2) { width: 8% !important; }  /* HSN */
            .gst-table th:nth-child(3), .gst-table td:nth-child(3) { width: 4% !important; }  /* Qty */
            .gst-table th:nth-child(4), .gst-table td:nth-child(4) { width: 8% !important; } /* Unit Price */
            .gst-table th:nth-child(5), .gst-table td:nth-child(5) { width: 10% !important; } /* Discount */
            .gst-table th:nth-child(6), .gst-table td:nth-child(6) { width: 10% !important; } /* Discounted Price */
            .gst-table th:nth-child(7), .gst-table td:nth-child(7) { width: 14% !important; }  /* SGST */
            .gst-table th:nth-child(8), .gst-table td:nth-child(8) { width: 14% !important; }  /* CGST */
            .gst-table th:nth-child(9), .gst-table td:nth-child(9) { width: 10% !important; }  /* Sub total */
            /* .gst-table th:nth-child(10), .gst-table td:nth-child(10) { width: 15% !important; } CGST Amt */
            /* .gst-table th:nth-child(11), .gst-table td:nth-child(11) { width: 12% !important; } Sub Total */
            
            /* Non-GST table column widths */
            .non-gst-table th:nth-child(1), .non-gst-table td:nth-child(1) { width: 40% !important; } /* Item */
            .non-gst-table th:nth-child(2), .non-gst-table td:nth-child(2) { width: 15% !important; } /* Qty */
            .non-gst-table th:nth-child(3), .non-gst-table td:nth-child(3) { width: 15% !important; } /* Unit Price */
            .non-gst-table th:nth-child(4), .non-gst-table td:nth-child(4) { width: 15% !important; } /* Discount */
            .non-gst-table th:nth-child(5), .non-gst-table td:nth-child(5) { width: 15% !important; } /* Total */
            
            /* Ensure proper page margins for printing */
            @page {
                margin: 0.5in;
                size: A4;
            }
            
            body {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
        
        /* Prevent layout shifts */
        .print-container {
            position: relative;
        }
        
        .print-container::before {
            content: '';
            display: block;
            height: 0;
        }
        
        /* Additional print preparation styles */
        .printing {
            overflow: visible !important;
        }
        
        .printing .overflow-x-auto {
            overflow-x: visible !important;
        }
        
        /* Responsive table handling for smaller content */
        @media screen and (max-width: 768px) {
            .gst-table {
                font-size: 11px;
            }
            
            .gst-table th, .gst-table td {
                padding: 2px 1px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="max-w-4xl mx-auto bg-white p-6 mt-10 rounded shadow-lg print-container">
        <div class="mb-4 flex justify-between items-start no-print">
            <!-- Left side: Back button -->
            <a href="{{ back_url }}" class="bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold px-4 py-2 rounded flex items-center gap-2">
                <i data-feather="arrow-left" class="w-5 h-5"></i> 
                <span>Back</span>
            </a>
            
            <!-- Right side: Edit and Print buttons -->
            <div class="flex flex-col items-end space-y-2">
                <!-- Button row -->
                <div class="flex items-center space-x-2">
                    <!-- Only show edit button for shopkeeper role -->
                    {% if current_user.role == 'shopkeeper' %}
                        {% if is_editable and remaining_edit_time %}
                        <a href="{{ url_for('shopkeeper.edit_bill', bill_id=bill.bill_id) }}" target="_blank" id="editBtn" class="bg-blue-100 hover:bg-blue-200 text-blue-600 px-4 py-2 rounded inline-block font-bold">
                            Edit Bill
                        </a>
                        {% elif bill.shopkeeper.user_id == current_user.user_id %}
                        <button onclick="showTimeExpiredMessage()" id="editBtn" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-2 rounded cursor-not-allowed font-bold">
                            Edit Bill (Expired)
                        </button>
                        {% endif %}
                    {% endif %}
                    <button onclick="printToPDF()" class="bg-green-100 hover:bg-green-200 text-green-600 px-4 py-2 rounded font-bold flex items-center gap-2">
                        <i data-feather="save" class="w-5 h-5"></i> 
                        Print / Save PDF
                    </button>
                    <!-- Remark button for both CA and Shopkeeper users -->
                    {% if current_user.role in ['CA', 'shopkeeper'] %}
                    <button onclick="openRemarkModal({{ bill.bill_id }}, '{{ bill.bill_number }}', '{{ bill.total_amount }}', '{{ bill.bill_date.strftime('%Y-%m-%d') if bill.bill_date }}')" 
                            class="bg-orange-100 hover:bg-orange-200 text-orange-600 px-4 py-2 rounded font-bold flex items-center gap-2">
                        <i data-feather="message-circle" class="w-5 h-5"></i>
                        Add Remark
                    </button>
                    {% endif %}
                </div>
                
                <!-- Countdown timer below edit button (only for shopkeeper) -->
                {% if current_user.role == 'shopkeeper' and is_editable and remaining_edit_time %}
                <div class="text-xs text-orange-600 font-medium" id="countdown">
                    Edit expires in: <span id="timer">{{ remaining_edit_time.minutes }}:{{ '%02d'|format(remaining_edit_time.seconds) }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Header Templates -->
        {% if shopkeeper.template_choice == 'template1' %}
        <!-- Template 1: Classic Left-Aligned -->
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center">
                {% if shopkeeper.logo_path %}
                <img src="{{ url_for('static', filename=shopkeeper.logo_path) }}" alt="Shop Logo" class="h-16 mr-4">
                {% endif %}
                <h1 class="text-3xl font-bold text-gray-900">{{ shopkeeper.shop_name }}</h1>
            </div>
            <div class="text-right">
                <p class="text-xl font-semibold text-gray-800">Invoice</p>
                <p class="text-gray-600">{{ bill.bill_number }}</p>
                <p class="text-gray-600">Date: {{ bill.bill_date|format_bill_date(bill.date_with_time) }}</p>
            </div>
        </div>
        {% elif shopkeeper.template_choice == 'template3' %}
        <!-- Template 3: Compact & Minimalist -->
        <div class="flex justify-between items-center mb-6">
            <div>
                {% if shopkeeper.logo_path %}
                <img src="{{ url_for('static', filename=shopkeeper.logo_path) }}" alt="Shop Logo" class="h-12 mb-2">
                {% endif %}
                <h1 class="text-2xl font-bold text-gray-900">{{ shopkeeper.shop_name }}</h1>
            </div>
            <div class="flex gap-4 text-sm">
                <p><span class="font-semibold">Invoice #:</span> {{ bill.bill_number }}</p>
                <p><span class="font-semibold">Date:</span> {{ bill.bill_date|format_bill_date(bill.date_with_time) }}</p>
            </div>
        </div>
        {% else %}
        <!-- Template 2: Modern Centered (Default) -->
        <div class="text-center mb-6">
            {% if shopkeeper.logo_path %}
            <img src="{{ url_for('static', filename=shopkeeper.logo_path) }}" alt="Shop Logo" class="h-16 mx-auto mb-2">
            {% endif %}
            <h1 class="text-3xl font-bold text-gray-900">{{ shopkeeper.shop_name }}</h1>
            <p class="text-gray-600">Invoice {{ bill.bill_number }}</p>
            <p class="text-gray-600">Date: {{ bill.bill_date|format_bill_date(bill.date_with_time) }}</p>
        </div>
        {% endif %}

        <!-- From and To section -->
        <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
            <div class="border p-4 rounded">
                <h2 class="font-semibold mb-2">From:</h2>
                <p>Name: {{ shopkeeper.shop_name }}</p>
                <p>Contact: {{ shopkeeper.contact_number }}</p>
                <p>Address: {{ shopkeeper.address }}</p>
                <p>GSTIN: {{ shopkeeper.gst_number }}</p>
            </div>
            <div class="border p-4 rounded">
                <h2 class="font-semibold mb-2">To:</h2>
                <p>Name: {{ bill.customer_name }}</p>
                <p>Contact: {{ bill.customer_contact }}</p>
                {% if bill.customer_address %}
                <p>Address: {{ bill.customer_address }}</p>
                {% endif %}
                {% if bill.customer_gstin %}
                <p>GSTIN: {{ bill.customer_gstin }}</p>
                {% endif %}
            </div>
        </div>

        {% if bill.gst_type == 'GST' %}
        <!-- GST Summary Table (Only show for GST bills) -->
        <h2 class="text-lg font-semibold mb-2">GST Summary</h2>
        <div class="overflow-x-auto">
            <table class="w-full border text-sm text-left gst-table">
                <thead class="bg-orange-100 text-orange-700">
                    <tr>
                        <th class="p-2 border">Item</th>
                        <th class="p-2 border">HSN Code</th>
                        <th class="p-2 border text-right">Qty</th>
                        <th class="p-2 border text-right">Unit Price</th>
                        <th class="p-2 border text-right">Discount</th>
                        <th class="p-2 border text-right">Discounted Price</th>
                        <th class="p-2 border text-center" colspan="2">SGST/UTGST</th>
                        <th class="p-2 border text-center" colspan="2">CGST</th>
                        <th class="p-2 border text-right">Sub Total</th>
                    </tr>
                    <tr>
                        <th class="p-2 border"></th>
                        <th class="p-2 border"></th>
                        <th class="p-2 border text-right"></th>
                        <th class="p-2 border text-right"></th>
                        <th class="p-2 border text-right"></th>
                        <th class="p-2 border text-right"></th>
                        <th class="p-2 border text-right">Rate (%)</th>
                        <th class="p-2 border text-right">Amt</th>
                        <th class="p-2 border text-right">Rate (%)</th>
                        <th class="p-2 border text-right">Amt</th>
                        <th class="p-2 border text-right"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for item_data in bill_items_data %}
                    <tr class="border-t">
                        <td class="p-2 border">{{ item_data.product.product_name }}</td>
                        <td class="p-2 border">{{ item_data.hsn_code or '-' }}</td>
                        <td class="p-2 border text-right">{{ item_data.quantity }}</td>
                        <td class="p-2 border text-right">₹{{ item_data.unit_price|round(2) }}</td>
                        <td class="p-2 border text-right">₹{{ item_data.discount_amount|round(2) }} ({{ item_data.discount_percent }}%)</td>
                        <td class="p-2 border text-right">₹{{ item_data.taxable_amount|round(2) }}</td>
                        <td class="p-2 border text-right">{{ item_data.sgst_rate|round(2) }}</td>
                        <td class="p-2 border text-right">₹{{ item_data.sgst_amount|round(2) }}</td>
                        <td class="p-2 border text-right">{{ item_data.cgst_rate|round(2) }}</td>
                        <td class="p-2 border text-right">₹{{ item_data.cgst_amount|round(2) }}</td>
                        <td class="p-2 border text-right">₹{{ item_data.final_total|round(2) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- GST Summary Table (Totals) -->
        <table class="w-full text-sm mt-4 border">
            <thead class="bg-gray-100">
                <tr>
                    <th class="p-2 border">Total Taxable Amount</th>
                    <th class="p-2 border">GST Rate</th>
                    <th class="p-2 border">CGST</th>
                    <th class="p-2 border">SGST</th>
                    <th class="p-2 border">Total GST</th>
                    <th class="p-2 border">Grand Total</th>
                </tr>
            </thead>
            <tbody>
                {% for gst_rate, summary in gst_summary_by_rate.items() %}
                <tr>
                    <td class="p-2 border">₹{{ summary.taxable_amount|round(2) }}</td>
                    <td class="p-2 border">{{ gst_rate }}%</td>
                    <td class="p-2 border">₹{{ summary.cgst_amount|round(2) }}</td>
                    <td class="p-2 border">₹{{ summary.sgst_amount|round(2) }}</td>
                    <td class="p-2 border">₹{{ summary.total_gst_amount|round(2) }}</td>
                    <td class="p-2 border"></td>
                </tr>
                {% endfor %}
                <!-- Grand Total Row -->
                <tr class="bg-gray-50 font-bold">
                    <td class="p-2 border">₹{{ total_taxable_amount|round(2) }}</td>
                    <td class="p-2 border"></td>
                    <td class="p-2 border">₹{{ total_cgst_amount|round(2) }}</td>
                    <td class="p-2 border">₹{{ total_sgst_amount|round(2) }}</td>
                    <td class="p-2 border">₹{{ total_gst_amount|round(2) }}</td>
                    <td class="p-2 border font-bold text-right">₹{{ overall_grand_total|round(2) }}</td>
                </tr>
            </tbody>
        </table>
        {% else %}
        <!-- Non-GST Bill Items Table (Simplified for Non-GST) -->
        <h2 class="text-lg font-semibold mb-2">Bill Items</h2>
        <div class="overflow-x-auto">
            <table class="w-full border text-sm text-left non-gst-table">
                <thead class="bg-orange-100 text-orange-700">
                    <tr>
                        <th class="p-2 border">Item</th>
                        <th class="p-2 border text-right">Quantity</th>
                        <th class="p-2 border text-right">Unit Price</th>
                        <th class="p-2 border text-right">Discount</th>
                        <th class="p-2 border text-right">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item_data in bill_items_data %}
                    <tr class="border-t">
                        <td class="p-2 border">{{ item_data.product.product_name }}</td>
                        <td class="p-2 border text-right">{{ item_data.quantity }}</td>
                        <td class="p-2 border text-right">₹{{ item_data.unit_price|round(2) }}</td>
                        <td class="p-2 border text-right">₹{{ item_data.discount_amount|round(2) }} ({{ item_data.discount_percent }}%)</td>
                        <td class="p-2 border text-right">₹{{ (item_data.unit_price * item_data.quantity - item_data.discount_amount)|round(2) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Non-GST Total Table -->
        <table class="w-full text-sm mt-4 border">
            <thead class="bg-gray-100">
                <tr>
                    <th class="p-2 border text-right">Grand Total</th>
                </tr>
            </thead>
            <tbody>
                <tr class="bg-gray-50 font-bold">
                    <td class="p-2 border font-bold text-right text-lg">₹{{ bill.total_amount|round(2) }}</td>
                </tr>
            </tbody>
        </table>
        {% endif %}

        <!-- Bank details -->
        <div class="mt-6 text-sm">
            <h2 class="font-semibold mb-2">Bank Details:</h2>
            <p>Bank Name: {{ shopkeeper.bank_name or '' }}</p>
            <p>Account Number: {{ shopkeeper.account_number or '' }}</p>
            <p>IFSC Code: {{ shopkeeper.ifsc_code or '' }}</p>
        </div>

        <!-- Action buttons with no-print class -->
        <!-- <div class="mt-6 flex justify-center gap-4 no-print">
            <a href="javascript:history.back()" class="bg-blue-500 text-white px-6 py-2 rounded shadow hover:bg-blue-600">Back</a>
            <button onclick="window.print()" class="bg-green-500 text-white px-6 py-2 rounded shadow hover:bg-green-600">Print</button>
        </div> -->

        <!-- Footer -->
            <div class="text-center text-xs text-gray-400 mt-4">
                Thank you for shopping with us!
            </div>
    </div>

    <script>

        feather.replace();



        function showTimeExpiredMessage() {
            // Create and show a temporary alert message for expired edit time
            const alertDiv = document.createElement('div');
            alertDiv.className = 'fixed top-4 right-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-lg z-50';
            alertDiv.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium">Edit time has expired! Bills can only be edited within 60 minutes of creation.</p>
                    </div>
                    <div class="ml-auto pl-3">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-red-500 hover:text-red-600">
                            <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(alertDiv);
            
            // Auto-remove after 7 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 7000);
        }

        function printToPDF() {
            // Store original layout state
            const originalLayout = document.documentElement.scrollTop;
            const originalDisplay = [];
            
            // Hide edit buttons and forms
            document.querySelectorAll('.no-print').forEach((el, index) => {
                originalDisplay[index] = el.style.display;
                el.style.display = 'none';
            });
            
            // Add print class for additional styling control
            document.body.classList.add('printing');
            
            // Store the beforeprint and afterprint event handlers
            const beforePrintHandler = () => {
                // Ensure all styles are applied before printing
                document.body.style.overflow = 'visible';
                document.documentElement.style.overflow = 'visible';
            };
            
            const afterPrintHandler = () => {
                // Clean up after printing
                document.body.classList.remove('printing');
                
                // Restore original display properties
                document.querySelectorAll('.no-print').forEach((el, index) => {
                    el.style.display = originalDisplay[index] || 'block';
                });
                
                // Reset body styles
                document.body.style.overflow = '';
                document.documentElement.style.overflow = '';
                
                // Restore scroll position
                document.documentElement.scrollTop = originalLayout;
                
                // Remove event listeners
                window.removeEventListener('beforeprint', beforePrintHandler);
                window.removeEventListener('afterprint', afterPrintHandler);
                
                // Reload page after a short delay to ensure layout is restored
                setTimeout(() => {
                    window.location.reload();
                }, 1);
            };
            
            // Add event listeners
            window.addEventListener('beforeprint', beforePrintHandler);
            window.addEventListener('afterprint', afterPrintHandler);
            
            // Trigger print
            window.print();
        }

        // Countdown timer for edit button
        function startEditCountdown() {
            const timerElement = document.getElementById('timer');
            if (!timerElement) return;
            
            {% if remaining_edit_time %}
            let remainingSeconds = {{ remaining_edit_time.minutes * 60 + remaining_edit_time.seconds }};
            {% else %}
            let remainingSeconds = 0;
            {% endif %}
            
            function updateCountdown() {
                if (remainingSeconds <= 0) {
                    // Time expired - reload page to show expired state
                    window.location.reload();
                    return;
                }
                
                const minutes = Math.floor(remainingSeconds / 60);
                const seconds = remainingSeconds % 60;
                
                timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                remainingSeconds--;
            }
            
            // Update immediately and then every second
            updateCountdown();
            setInterval(updateCountdown, 1000);
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Start countdown timer if edit button is available (only for shopkeeper)
            {% if current_user.role == 'shopkeeper' and is_editable and remaining_edit_time %}
            startEditCountdown();
            {% endif %}
        });
    </script>

    <!-- Remark Modal for both CA and Shopkeeper users -->
    {% if current_user.role in ['CA', 'shopkeeper'] %}
    <div id="remark-modal" class="fixed inset-0 backdrop-blur-sm hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Add Remark to Bill</h3>
                <button id="close-remark-modal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div id="remark-bill-info" class="mb-4 p-3 bg-gray-50 rounded-lg">
                <!-- Bill info will be populated here -->
            </div>

            <div class="mb-4">
                <label for="remark-text" class="block text-sm font-medium text-gray-700 mb-2">Your Remark</label>
                <textarea 
                    id="remark-text" 
                    rows="4" 
                    maxlength="500"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                    placeholder="Add your remark about this bill..."></textarea>
                <p class="text-xs text-gray-500 mt-1">
                    <span id="remark-char-count">0</span>/500 characters
                </p>
            </div>

            <div class="flex justify-end space-x-3">
                <button id="cancel-remark" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button id="submit-remark" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">
                    Send Remark
                </button>
            </div>
        </div>
    </div>

    <script>
        // Set receiver ID based on user role
        window.REMARK_RECEIVER_ID = {% if current_user.role == 'CA' %}{{ bill.shopkeeper.user_id }}{% else %}null{% endif %};
        
        // Remark modal functionality for both CA and Shopkeeper users
        let currentBillData = null;

        function openRemarkModal(billId, billNumber, totalAmount, billDate) {
            const modal = document.getElementById('remark-modal');
            const billInfo = document.getElementById('remark-bill-info');
            const remarkText = document.getElementById('remark-text');
            const charCount = document.getElementById('remark-char-count');

            // Store current bill data
            currentBillData = {
                id: billId,
                number: billNumber,
                amount: totalAmount,
                date: billDate
            };

            // Update bill info
            billInfo.innerHTML = `
                <h4 class="font-medium text-gray-900">Bill #${billNumber}</h4>
                <p class="text-sm text-gray-600">Amount: ₹${totalAmount} • Date: ${billDate}</p>
            `;

            // Reset form
            remarkText.value = '';
            charCount.textContent = '0';

            // Show modal
            modal.classList.remove('hidden');
            remarkText.focus();
        }

        function closeRemarkModal() {
            document.getElementById('remark-modal').classList.add('hidden');
            currentBillData = null;
        }

        async function submitRemark() {
            const remarkText = document.getElementById('remark-text');
            const message = remarkText.value.trim();

            if (!message) {
                alert('Please enter a remark');
                return;
            }

            if (!currentBillData) {
                alert('No bill selected');
                return;
            }

            try {
                const receiverId = window.REMARK_RECEIVER_ID;
                
                const response = await fetch('/api/messages/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        receiver_id: receiverId,
                        message: message,
                        message_type: 'remark',
                        bill_id: currentBillData.id
                    })
                });

                if (response.ok) {
                    alert('Remark sent successfully!');
                    closeRemarkModal();
                } else {
                    const error = await response.json();
                    alert('Failed to send remark: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error sending remark:', error);
                alert('Failed to send remark. Please try again.');
            }
        }

        // Event listeners for remark modal
        document.addEventListener('DOMContentLoaded', function() {
            const closeBtn = document.getElementById('close-remark-modal');
            const cancelBtn = document.getElementById('cancel-remark');
            const submitBtn = document.getElementById('submit-remark');
            const remarkText = document.getElementById('remark-text');
            const charCount = document.getElementById('remark-char-count');

            if (closeBtn) closeBtn.addEventListener('click', closeRemarkModal);
            if (cancelBtn) cancelBtn.addEventListener('click', closeRemarkModal);
            if (submitBtn) submitBtn.addEventListener('click', submitRemark);

            // Character count update
            if (remarkText) {
                remarkText.addEventListener('input', function() {
                    charCount.textContent = this.value.length;
                });
            }
        });
    </script>
    {% endif %}
</body>
</html>
