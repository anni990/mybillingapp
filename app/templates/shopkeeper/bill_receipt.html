<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bill Receipt - {{ bill.bill_number }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="max-w-4xl mx-auto bg-white p-6 mt-10 rounded shadow-lg">
        <div class="mb-4 flex justify-between items-center no-print">
            <a href="{{ back_url }}" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                ← Back
            </a>
            <div>
                {% if is_editable %}
                <a href="{{ url_for('shopkeeper.edit_bill', bill_id=bill.bill_id) }}" target="_blank" id="editBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded inline-block">
                    Edit Bill
                </a>
                {% else %}
                {% if current_user.role in ['CA', 'employee'] %}
                <button onclick="showEditRestriction()" id="editBtn" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded cursor-not-allowed">
                    Edit Bill
                </button>
                {% endif %}
                {% endif %}
                <button onclick="printToPDF()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded ml-2">
                    Print / Save PDF
                </button>
            </div>
        </div>

        <!-- Header Templates -->
        {% if shopkeeper.template_choice == 'template1' %}
        <!-- Template 1: Classic Left-Aligned -->
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center">
                {% if shopkeeper.logo_path %}
                <img src="{{ url_for('static', filename=shopkeeper.logo_path) }}" alt="Shop Logo" class="h-16 mr-4">
                {% endif %}
                <h1 class="text-3xl font-bold text-gray-900">{{ shopkeeper.shop_name }}</h1>
            </div>
            <div class="text-right">
                <p class="text-xl font-semibold text-gray-800">Invoice</p>
                <p class="text-gray-600">{{ bill.bill_number }}</p>
                <p class="text-gray-600">Date: {{ bill.bill_date }}</p>
            </div>
        </div>
        {% elif shopkeeper.template_choice == 'template3' %}
        <!-- Template 3: Compact & Minimalist -->
        <div class="flex justify-between items-center mb-6">
            <div>
                {% if shopkeeper.logo_path %}
                <img src="{{ url_for('static', filename=shopkeeper.logo_path) }}" alt="Shop Logo" class="h-12 mb-2">
                {% endif %}
                <h1 class="text-2xl font-bold text-gray-900">{{ shopkeeper.shop_name }}</h1>
            </div>
            <div class="flex gap-4 text-sm">
                <p><span class="font-semibold">Invoice #:</span> {{ bill.bill_number }}</p>
                <p><span class="font-semibold">Date:</span> {{ bill.bill_date }}</p>
            </div>
        </div>
        {% else %}
        <!-- Template 2: Modern Centered (Default) -->
        <div class="text-center mb-6">
            {% if shopkeeper.logo_path %}
            <img src="{{ url_for('static', filename=shopkeeper.logo_path) }}" alt="Shop Logo" class="h-16 mx-auto mb-2">
            {% endif %}
            <h1 class="text-3xl font-bold text-gray-900">{{ shopkeeper.shop_name }}</h1>
            <p class="text-gray-600">Invoice {{ bill.bill_number }}</p>
            <p class="text-gray-600">Date: {{ bill.bill_date }}</p>
        </div>
        {% endif %}

        <!-- From and To section -->
        <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
            <div class="border p-4 rounded">
                <h2 class="font-semibold mb-2">From:</h2>
                <p>Name: {{ shopkeeper.shop_name }}</p>
                <p>Contact: {{ shopkeeper.contact_number }}</p>
                <p>Address: {{ shopkeeper.address }}</p>
                <p>GSTIN: {{ shopkeeper.gst_number }}</p>
            </div>
            <div class="border p-4 rounded">
                <h2 class="font-semibold mb-2">To:</h2>
                <p>Name: {{ bill.customer_name }}</p>
                <p>Contact: {{ bill.customer_contact }}</p>
                {% if bill.customer_address %}
                <p>Address: {{ bill.customer_address }}</p>
                {% endif %}
                {% if bill.customer_gstin %}
                <p>GSTIN: {{ bill.customer_gstin }}</p>
                {% endif %}
            </div>
        </div>

        <!-- GST Summary Table -->
        <h2 class="text-lg font-semibold mb-2">GST Summary</h2>
        <div class="overflow-x-auto">
            <table class="w-full border text-sm text-left">
                <thead class="bg-orange-100 text-orange-700">
                    <tr>
                        <th class="p-2 border">Item</th>
                        <th class="p-2 border">HSN Code</th>
                        <th class="p-2 border text-right">Quantity</th>
                        <th class="p-2 border text-right">Unit Price</th>
                        <th class="p-2 border text-right">Discount</th>
                        <th class="p-2 border text-right">Discounted Price</th>
                        <th class="p-2 border text-center" colspan="2">SGST/UTGST</th>
                        <th class="p-2 border text-center" colspan="2">CGST</th>
                        <th class="p-2 border text-right">Sub Total</th>
                    </tr>
                    <tr>
                        <th class="p-2 border"></th>
                        <th class="p-2 border"></th>
                        <th class="p-2 border text-right"></th>
                        <th class="p-2 border text-right"></th>
                        <th class="p-2 border text-right"></th>
                        <th class="p-2 border text-right"></th>
                        <th class="p-2 border text-right">Rate (%)</th>
                        <th class="p-2 border text-right">Amt</th>
                        <th class="p-2 border text-right">Rate (%)</th>
                        <th class="p-2 border text-right">Amt</th>
                        <th class="p-2 border text-right"></th>
                    </tr>
                </thead>
                <tbody>
                    {% for item_data in bill_items_data %}
                    <tr class="border-t">
                        <td class="p-2 border">{{ item_data.product.product_name }}</td>
                        <td class="p-2 border">{{ item_data.hsn_code }}</td>
                        <td class="p-2 border text-right">{{ item_data.quantity }}</td>
                        <td class="p-2 border text-right">₹{{ item_data.unit_price|round(2) }}</td>
                        <td class="p-2 border text-right">₹{{ item_data.discount_amount|round(2) }} ({{ item_data.discount_percent }}%)</td>
                        <td class="p-2 border text-right">₹{{ item_data.taxable_amount|round(2) }}</td>
                        <td class="p-2 border text-right">{{ item_data.sgst_rate|round(2) }}</td>
                        <td class="p-2 border text-right">₹{{ item_data.sgst_amount|round(2) }}</td>
                        <td class="p-2 border text-right">{{ item_data.cgst_rate|round(2) }}</td>
                        <td class="p-2 border text-right">₹{{ item_data.cgst_amount|round(2) }}</td>
                        <td class="p-2 border text-right">₹{{ item_data.final_total|round(2) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Summary Table (Totals) -->
        <table class="w-full text-sm mt-4 border">
            <thead class="bg-gray-100">
                <tr>
                    <th class="p-2 border">Total Taxable Amount</th>
                    <th class="p-2 border">GST Rate</th>
                    <th class="p-2 border">CGST</th>
                    <th class="p-2 border">SGST</th>
                    <th class="p-2 border">Total GST</th>
                    <th class="p-2 border">Grand Total</th>
                </tr>
            </thead>
            <tbody>
                {% for gst_rate, summary in gst_summary_by_rate.items() %}
                <tr>
                    <td class="p-2 border">₹{{ summary.taxable_amount|round(2) }}</td>
                    <td class="p-2 border">{{ gst_rate }}%</td>
                    <td class="p-2 border">₹{{ summary.cgst_amount|round(2) }}</td>
                    <td class="p-2 border">₹{{ summary.sgst_amount|round(2) }}</td>
                    <td class="p-2 border">₹{{ summary.total_gst_amount|round(2) }}</td>
                    <td class="p-2 border"></td>
                </tr>
                {% endfor %}
                <!-- Grand Total Row -->
                <tr class="bg-gray-50 font-bold">
                    <td class="p-2 border">₹{{ total_taxable_amount|round(2) }}</td>
                    <td class="p-2 border"></td>
                    <td class="p-2 border">₹{{ total_cgst_amount|round(2) }}</td>
                    <td class="p-2 border">₹{{ total_sgst_amount|round(2) }}</td>
                    <td class="p-2 border">₹{{ total_gst_amount|round(2) }}</td>
                    <td class="p-2 border font-bold text-right">₹{{ overall_grand_total|round(2) }}</td>
                </tr>
            </tbody>
        </table>

        <!-- Bank details -->
        <div class="mt-6 text-sm">
            <h2 class="font-semibold mb-2">Bank Details:</h2>
            <p>Bank Name: {{ shopkeeper.bank_name or '' }}</p>
            <p>Account Number: {{ shopkeeper.account_number or '' }}</p>
            <p>IFSC Code: {{ shopkeeper.ifsc_code or '' }}</p>
        </div>

        <!-- Action buttons with no-print class -->
        <!-- <div class="mt-6 flex justify-center gap-4 no-print">
            <a href="javascript:history.back()" class="bg-blue-500 text-white px-6 py-2 rounded shadow hover:bg-blue-600">Back</a>
            <button onclick="window.print()" class="bg-green-500 text-white px-6 py-2 rounded shadow hover:bg-green-600">Print</button>
        </div> -->

        <!-- Footer -->
            <div class="text-center text-xs text-gray-400 mt-4">
                Thank you for shopping with us!
            </div>
    </div>

    <script>
        function showEditRestriction() {
            // Create and show a temporary alert message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'fixed top-4 right-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded shadow-lg z-50';
            alertDiv.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-500" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium">Only Shop Owner can Edit bills.</p>
                    </div>
                    <div class="ml-auto pl-3">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-yellow-500 hover:text-yellow-600">
                            <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(alertDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function printToPDF() {
            // Hide edit buttons and forms
            document.querySelectorAll('.no-print').forEach(el => el.style.display = 'none');
            
            // Print
            window.print();
            
            // Show buttons again after printing
            setTimeout(() => {
                document.querySelectorAll('.no-print').forEach(el => el.style.display = 'block');
            }, 100);
        }
    </script>
</body>
</html>
