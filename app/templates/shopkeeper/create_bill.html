{% extends 'shopkeeper/s_base.html' %}
{% block title %}Create Bill | MyBillingApp{% endblock %}
{% block content %}
<link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css">
<script src="https://unpkg.com/feather-icons"></script>
<!-- Sidebar (reuse your sidebar code here if needed) -->
<aside
    class="fixed top-0 left-0 h-full w-64 bg-gradient-to-b from-[#ed6a3e] to-[#ed6a3e] shadow-lg flex flex-col justify-between z-20 mt-15">
    <div>
        <nav class="mt-5 flex-1">
            <ul class="space-y-2">
                <li><a href="{{ url_for('shopkeeper.dashboard') }}"
                        class="flex items-center px-6 py-3 text-white font-semibold rounded-l-full hover:bg-white/30 transition duration-300"><i
                            data-feather="home" class="mr-3"></i>Dashboard Home</a></li>
                <li><a href="{{ url_for('shopkeeper.create_bill') }}"
                        class="flex items-center px-6 py-3 text-white bg-white/20 hover:bg-white/30 rounded-l-full transition duration-300"><i
                            data-feather="file-plus" class="mr-3"></i>Create Bill</a></li>
                <li><a href="{{ url_for('shopkeeper.manage_bills') }}"
                        class="flex items-center px-6 py-3 text-white hover:bg-white/20 rounded-l-full transition duration-300"><i
                            data-feather="file-text" class="mr-3"></i>Manage Bills</a></li>
                <li><a href="{{ url_for('shopkeeper.products_stock') }}"
                        class="flex items-center px-6 py-3 text-white hover:bg-white/20 rounded-l-full transition duration-300"><i
                            data-feather="box" class="mr-3"></i>Products & Stock</a></li>
                <li><a href="{{ url_for('shopkeeper.sales_reports') }}"
                        class="flex items-center px-6 py-3 text-white hover:bg-white/20 rounded-l-full transition duration-300"><i
                            data-feather="bar-chart-2" class="mr-3"></i>Sales Reports</a></li>
                <li><a href="{{ url_for('shopkeeper.ca_marketplace') }}"
                        class="flex items-center px-6 py-3 text-white hover:bg-white/20 rounded-l-full transition duration-300"><i
                            data-feather="users" class="mr-3"></i>CA Marketplace</a></li>
            </ul>
        </nav>
    </div>
    <div class="p-4 text-xs text-white text-center opacity-70">&copy; {{ 2024 }} MyBillingApp</div>
</aside>
<div class="max-w-3xl mx-auto bg-white p-10 rounded-2xl shadow-lg mt-12 ml-80">
    <div class="flex items-center mb-8">
        {% if shopkeeper.logo_path %}
        <img src="{{ url_for('static', filename=shopkeeper.logo_path) }}" alt="Shop Logo"
            class="h-16 w-16 rounded-full object-cover mr-4">
        {% endif %}
        <div class="flex-1 text-center">
            <h2 class="text-3xl font-bold text-[#ed6a3e]">{{ shopkeeper.shop_name }}</h2>
        </div>
    </div>
    <h2 class="text-3xl font-bold text-[#ed6a3e] mb-8">Create Bill</h2>
    <form id="create-bill-form" method="POST" action="{{ url_for('shopkeeper.generate_bill_pdf') }}">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <div>
                <label class="block text-gray-700 font-semibold mb-2">Customer Name</label>
                <input type="text" name="customer_name"
                    class="w-full border rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#ed6a3e]"
                    required>
            </div>
            <div>
                <label class="block text-gray-700 font-semibold mb-2">Customer Contact</label>
                <input type="tel" 
                       name="customer_contact" 
                       pattern="^[6-9]\d{9}$"
                       maxlength="10"
                       placeholder="Enter 10 digit mobile number"
                       title="Please enter a valid 10 digit mobile number"
                       class="w-full border rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#ed6a3e]"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '').substring(0, 10);">
                <small class="text-gray-500">Enter 10 digit mobile number starting with 6-9</small>
            </div>
        </div>
        <div id="gst-type-row" class="mb-8">
            <label class="block text-gray-700 font-semibold mb-1">GST Type:</label>
            <select name="bill_gst_type" id="bill_gst_type"
                class="border rounded px-2 py-1 max-w-full focus:outline-none focus:ring-2 focus:ring-[#ed6a3e]">
                <option value="GST">GST</option>
                <option value="Non-GST">Non-GST</option>
            </select>
        </div>
        <div id="gst-section-container" class="mb-8 grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
                <label class="block text-gray-700 font-semibold mb-1">GST Mode:</label>
                <select name="gst_mode" id="gst_mode"
                    class="border rounded px-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-[#ed6a3e]">
                    <option value="exclusive">GST Exclusive (add GST on top)</option>
                    <option value="inclusive">GST Inclusive (price includes GST)</option>
                </select>
            </div>
            <!-- GST Rate select removed: now taken from database per product -->
        </div>

        <div class="mb-8">
            <label class="block text-gray-700 font-semibold mb-3">Products</label>
            <div class="flex space-x-2 mb-2 font-semibold text-gray-600 items-center">
                <div style="width:10rem;">Product Name</div>
                <div style="width:4rem;" class="text-center">Quantity</div>
                <div style="width:6rem;" class="text-center">Price/qty</div>
                <div style="width:6rem;" class="text-center">Discount %</div>
                <div style="width:6rem;" class="text-center gst-col">GST Rate</div>
                <div style="width:2rem;"></div>
            </div>
            <div id="product-rows">
                <!-- JS will add product rows here -->
            </div>
            <button type="button" id="add-product-btn"
                class="mt-3 bg-[#ed6a3e] text-white px-5 py-2 rounded shadow hover:bg-orange-700 transition duration-300"><i
                    class="fas fa-plus mr-2"></i>Add Product</button>
        </div>
        <div class="mb-8 text-right">
            <span class="text-2xl font-bold text-[#ed6a3e]">Total: ₹<span id="bill-total">0.00</span></span>
            <div class="mt-2 text-gray-700">
                <span>Paid: ₹<span id="paid-amount-display">0.00</span></span> |
                <span>Unpaid: ₹<span id="unpaid-amount-display">0.00</span></span>
            </div>
        </div>
        <div class="mb-8 flex flex-col md:flex-row gap-6 items-center">
            <div>
                <label class="block text-gray-700 font-semibold mb-1">Bill Status:</label>
                <select name="bill_status" id="bill_status"
                    class="border rounded px-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-[#ed6a3e]">
                    <option value="paid">Paid</option>
                    <option value="unpaid">Unpaid</option>
                    <option value="partial">Partial</option>
                </select>
            </div>
            <div id="amount-paid-section" style="display:none;">
                <label class="block text-gray-700 font-semibold mb-1">Amount Paid:</label>
                <input type="number" min="0" step="0.01" name="amount_paid" id="amount_paid"
                    class="border rounded px-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-[#ed6a3e]">
            </div>
            <input type="hidden" name="calculated_paid_amount" id="calculated_paid_amount">
            <input type="hidden" name="calculated_unpaid_amount" id="calculated_unpaid_amount">
        </div>
        <div class="flex flex-col md:flex-row gap-4 justify-end">
            <button type="submit" name="action" value="save"
                class="bg-[#ed6a3e] text-white px-8 py-3 rounded shadow hover:bg-orange-700 transition duration-300">Save</button>
            <button type="submit" name="action" value="generate_pdf"
                class="bg-gray-200 text-[#ed6a3e] px-8 py-3 rounded shadow hover:bg-orange-100 transition duration-300">Generate
                PDF</button>
        </div>
    </form>
</div>
<script type="text/javascript">
    const PRODUCTS = {{ products_js| tojson }};
</script>
<script src="/static/js/create_bill.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const gstSectionContainer = document.getElementById('gst-section-container');
        const billGstType = document.getElementById('bill_gst_type');
        const gstMode = document.getElementById('gst_mode');
        const billStatus = document.getElementById('bill_status');
        const amountPaidSection = document.getElementById('amount-paid-section');
        const amountPaidInput = document.getElementById('amount_paid');
        const billTotal = document.getElementById('bill-total');
        const paidAmountDisplay = document.getElementById('paid-amount-display');
        const unpaidAmountDisplay = document.getElementById('unpaid-amount-display');
        const calculatedPaidAmount = document.getElementById('calculated_paid_amount');
        const calculatedUnpaidAmount = document.getElementById('calculated_unpaid_amount');

        function updateGSTSectionVisibility() {
            if (billGstType.value === 'GST') {
                gstSectionContainer.style.display = '';
            } else {
                gstSectionContainer.style.display = 'none';
            }
        }

        function updatePaymentFields() {
            // Always use parseFloat and round to 2 decimal places
            const total = Math.round((parseFloat(billTotal.textContent) || 0) * 100) / 100;
            let paid = 0, unpaid = 0;
            
            if (billStatus.value === 'paid') {
                paid = total;
                unpaid = 0;
                amountPaidSection.style.display = 'none';
            } else if (billStatus.value === 'unpaid') {
                paid = 0;
                unpaid = total;
                amountPaidSection.style.display = 'none';
            } else if (billStatus.value === 'partial') {
                amountPaidSection.style.display = '';
                paid = Math.round((parseFloat(amountPaidInput.value) || 0) * 100) / 100;
                unpaid = Math.round((total - paid) * 100) / 100;
                
                // Ensure unpaid doesn't go negative
                if (unpaid < 0) unpaid = 0;
                
                // If paid is more than total, cap it
                if (paid > total) {
                    paid = total;
                    unpaid = 0;
                    amountPaidInput.value = total.toFixed(2);
                }
            }
            
            // Update display with 2 decimal places
            paidAmountDisplay.textContent = paid.toFixed(2);
            unpaidAmountDisplay.textContent = unpaid.toFixed(2);
            calculatedPaidAmount.value = paid.toFixed(2);
            calculatedUnpaidAmount.value = unpaid.toFixed(2);
        }

        // Add event listeners
        billGstType.addEventListener('change', updateGSTSectionVisibility);
        billStatus.addEventListener('change', updatePaymentFields);
        amountPaidInput.addEventListener('input', updatePaymentFields);
        
        // Initial calls
        updateGSTSectionVisibility();
        updatePaymentFields();
    });

    document.getElementById('create-bill-form').addEventListener('submit', function(e) {
        const billTotal = parseFloat(document.getElementById('bill-total').textContent);
        const paidAmount = parseFloat(document.getElementById('calculated_paid_amount').value);
        const unpaidAmount = parseFloat(document.getElementById('calculated_unpaid_amount').value);
        
        // Verify payment amounts match total
        if (Math.abs((paidAmount + unpaidAmount) - billTotal) > 0.01) {
            alert('Error: Paid + Unpaid amounts do not match the total bill amount.');
            e.preventDefault();
            return false;
        }
        
        // Verify at least one product was added
        if (document.querySelectorAll('.product-row').length === 0) {
            alert('Please add at least one product to the bill.');
            e.preventDefault();
            return false;
        }
        
        return true;
    });
</script>
<script>feather.replace()</script>
{% endblock %}