{% extends 'shopkeeper/s_base.html' %}
{% block title %}Create Bill | MyBillingApp{% endblock %}
{% block content %}
<link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css">
<script src="https://unpkg.com/feather-icons"></script>

<style>
    .product-item {
        transition: all 0.3s ease;
    }
    
    .product-item:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .remove-product {
        transition: opacity 0.3s ease;
    }
    
    .product-item:hover .remove-product {
        opacity: 1;
    }
    
    @media (max-width: 768px) {
        .product-grid {
            grid-template-columns: 1fr;
        }
        
        .product-input {
            margin-bottom: 0.75rem;
        }
    }
    
    /* Custom styles for the create bill page */
    .product-search-container {
        position: relative;
    }
    
    #product-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 50;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .product-suggestion:hover,
    .new-product-suggestion:hover {
        background-color: #f9fafb;
    }
    
    .product-row:hover {
        background-color: #f9fafb;
    }
    
    /* Custom scrollbar for suggestions */
    #product-suggestions::-webkit-scrollbar {
        width: 6px;
    }
    
    #product-suggestions::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    #product-suggestions::-webkit-scrollbar-thumb {
        background: #ed6a3e;
        border-radius: 3px;
    }
    
    #product-suggestions::-webkit-scrollbar-thumb:hover {
        background: #d45f34;
    }
</style>

<div class="p-4 md:p-8">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-6 md:mb-8 space-y-4 md:space-y-0">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 flex items-center">
                <i data-feather="plus-circle" class="w-6 h-6 md:w-8 md:h-8 mr-3 text-[#ed6a3e]"></i>
                Create New Bill
            </h1>
            <p class="text-gray-600 text-sm md:text-base mt-1">Generate a new bill for your customer</p>
        </div>
        <div class="flex items-center space-x-2 md:space-x-4">
            <a href="{{ url_for('shopkeeper.manage_bills') }}" 
               class="flex items-center space-x-2 bg-gray-100 hover:bg-gray-200 px-3 md:px-4 py-2 rounded-lg transition duration-300 text-sm md:text-base">
                <i data-feather="file-text" class="w-4 h-4"></i>
                <span class="hidden md:inline">Manage Bills</span>
                <span class="md:hidden">Bills</span>
            </a>
            <a href="{{ url_for('shopkeeper.dashboard') }}" 
               class="flex items-center space-x-2 bg-gray-100 hover:bg-gray-200 px-3 md:px-4 py-2 rounded-lg transition duration-300 text-sm md:text-base">
                <i data-feather="home" class="w-4 h-4"></i>
                <span class="hidden md:inline">Dashboard</span>
                <span class="md:hidden">Home</span>
            </a>
        </div>
    </div>

    <!-- Bill Form -->
    <form id="create-bill-form" method="POST" action="{{ url_for('shopkeeper.generate_bill_pdf') }}" class="space-y-6">
        <!-- Customer Details Section -->
        <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 border border-gray-200">
            <div class="flex items-center mb-4">
                <i data-feather="user" class="w-5 h-5 text-[#ed6a3e] mr-2"></i>
                <h2 class="text-lg md:text-xl font-bold text-gray-800">Customer Details</h2>
            </div>
            
            <!-- Customer Selection -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Customer Type</label>
                <div class="flex flex-col sm:flex-row gap-4">
                    <label class="flex items-center">
                        <input type="radio" name="customer_type" value="existing" class="mr-2" onchange="toggleCustomerFields()">
                        <span class="text-sm">Existing Customer</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="customer_type" value="new" class="mr-2" checked onchange="toggleCustomerFields()">
                        <span class="text-sm">New/Guest Customer</span>
                    </label>
                </div>
            </div>

            <!-- Existing Customer Selection -->
            <div id="existing-customer-section" class="hidden mb-4">
                <label for="existing_customer" class="block text-sm font-medium text-gray-700 mb-2">
                    Select Customer <span class="text-red-500">*</span>
                </label>
                <select id="existing_customer" name="existing_customer_id" 
                        class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent transition duration-200 text-sm md:text-base"
                        onchange="fillCustomerDetails()">
                    <option value="">Select a customer...</option>
                </select>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 gap-4">
                <div>
                    <label for="customer_name" class="block text-sm font-medium text-gray-700 mb-2">
                        Customer Name <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="customer_name" id="customer_name" required 
                           placeholder="Enter customer name"
                           class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent transition duration-200 text-sm md:text-base">
                </div>
                
                <div>
                    <label for="customer_contact" class="block text-sm font-medium text-gray-700 mb-2">Customer Contact</label>
                    <input type="tel" 
                           name="customer_contact" 
                           id="customer_contact"
                           pattern="^[6-9]\d{9}$"
                           maxlength="10"
                           placeholder="10 digit mobile number"
                           title="Please enter a valid 10 digit mobile number"
                           class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent transition duration-200 text-sm md:text-base"
                           oninput="this.value = this.value.replace(/[^0-9]/g, '').substring(0, 10);">
                </div>
                
                <div>
                    <label for="customer_address" class="block text-sm font-medium text-gray-700 mb-2">Customer Address</label>
                    <input type="text" name="customer_address" id="customer_address"
                           placeholder="Enter address"
                           class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent transition duration-200 text-sm md:text-base">
                </div>
                
                <div>
                    <label for="customer_gstin" class="block text-sm font-medium text-gray-700 mb-2">Customer GSTIN</label>
                    <input type="text" name="customer_gstin" id="customer_gstin"
                           placeholder="Enter GSTIN"
                           class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent transition duration-200 text-sm md:text-base">
                </div>
            </div>

            <!-- Payment Status for Existing Customers -->
            <div id="payment-status-section" class="hidden mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Payment Status</label>
                <div class="flex flex-col sm:flex-row gap-4">
                    <label class="flex items-center">
                        <input type="radio" name="payment_status" value="Paid" class="mr-2" checked>
                        <span class="text-sm">Paid</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="payment_status" value="Partial" class="mr-2">
                        <span class="text-sm">Partial Payment</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="payment_status" value="Unpaid" class="mr-2">
                        <span class="text-sm">Credit (Unpaid)</span>
                    </label>
                </div>
                
                <div id="partial-payment-section" class="hidden mt-3">
                    <label for="paid_amount" class="block text-sm font-medium text-gray-700 mb-2">Amount Paid</label>
                    <input type="number" name="paid_amount" id="paid_amount" step="0.01" min="0"
                           placeholder="Enter amount paid"
                           class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent transition duration-200 text-sm md:text-base">
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                <div>
                    <label for="bill-date" class="block text-sm font-medium text-gray-700 mb-2">
                        Bill Date & Time <span class="text-red-500">*</span>
                    </label>
                    <input type="datetime-local" name="bill_date" id="bill-date"
                           class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent transition duration-200 text-sm md:text-base"
                           value="{{ now.strftime('%Y-%m-%dT%H:%M') }}" required>
                </div>
                
                <div>
                    <label for="bill_gst_type" class="block text-sm font-medium text-gray-700 mb-2">GST Type</label>
                    <select name="bill_gst_type" id="bill_gst_type"
                            class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent transition duration-200 text-sm md:text-base">
                        <option value="GST">GST</option>
                        <option value="Non-GST">Non-GST</option>
                    </select>
                </div>
                
                <div id="gst-mode-section">
                    <label for="gst_mode" class="block text-sm font-medium text-gray-700 mb-2">GST Mode</label>
                    <select name="gst_mode" id="gst_mode"
                            class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent transition duration-200 text-sm md:text-base">
                        <option value="exclusive">GST Exclusive (add GST on top)</option>
                        <option value="inclusive">GST Inclusive (price includes GST)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Products Section -->
        <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 border border-gray-200">
            <div class="flex items-center mb-4">
                <i data-feather="package" class="w-5 h-5 text-[#ed6a3e] mr-2"></i>
                <h2 class="text-lg md:text-xl font-bold text-gray-800">Products</h2>
            </div>
            
            <!-- Product Search -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Search & Add Products</label>
                <div class="product-search-container relative">
                    <input type="text" id="product-search" 
                           placeholder="Search products by name or add new product..."
                           class="w-full pl-10 pr-4 py-2 md:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent transition duration-200 text-sm md:text-base">
                    <i data-feather="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"></i>
                    <div id="product-suggestions" class="bg-white border border-gray-300 rounded-lg mt-1 shadow-lg hidden"></div>
                </div>
            </div>

            <!-- Desktop Table View -->
            <div class="hidden lg:block border border-gray-200 rounded-lg overflow-hidden">
                <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                    <div class="grid grid-cols-12 gap-3 items-center text-sm font-medium text-gray-700">
                        <div class="col-span-2">Product Name</div>
                        <div class="col-span-2 text-center">Available Stock</div>
                        <div class="col-span-1 text-center">Qty</div>
                        <div class="col-span-2 text-center">Price/Unit</div>
                        <div class="col-span-1 text-center">Discount %</div>
                        <div class="col-span-2 text-center gst-col">GST Rate %</div>
                        <div class="col-span-1 text-center">Total</div>
                        <div class="col-span-1 text-center">Action</div>
                    </div>
                </div>
                <div id="product-rows" class="divide-y divide-gray-200">
                    <!-- Product rows will be added here -->
                    <div id="no-products-message" class="px-4 py-8 text-center text-gray-500">
                        <i data-feather="package" class="w-12 h-12 mx-auto mb-3 text-gray-300"></i>
                        <p class="text-lg font-medium mb-2">No products added yet</p>
                        <p class="text-sm">Search for products above or click "Add Your First Product" to get started</p>
                    </div>
                </div>
            </div>

            <!-- Mobile Product Cards -->
            <div class="lg:hidden" id="mobile-products">
                <div id="mobile-no-products" class="text-center py-8 bg-gray-50 rounded-lg">
                    <i data-feather="package" class="w-12 h-12 text-gray-300 mx-auto mb-3"></i>
                    <p class="text-lg font-medium text-gray-600 mb-2">No products added yet</p>
                    <p class="text-sm text-gray-500 mb-4">Search for products above or add your first product</p>
                </div>
            </div>

            <button type="button" id="add-product-btn"
                    class="mt-4 w-full md:w-auto bg-[#ed6a3e] text-white px-6 py-3 rounded-lg shadow hover:bg-orange-700 transition duration-300 flex items-center justify-center">
                <i data-feather="plus" class="mr-2 w-4 h-4"></i>
                <span>Add Your First Product</span>
            </button>
        </div>

        <!-- Bill Summary Section -->
        <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 border border-gray-200">
            <div class="flex items-center mb-4">
                <i data-feather="calculator" class="w-5 h-5 text-[#ed6a3e] mr-2"></i>
                <h2 class="text-lg md:text-xl font-bold text-gray-800">Bill Summary</h2>
            </div>
            
            <div class="flex flex-col xl:flex-row gap-6">
                <!-- Payment Details -->
                <div class="flex-1 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="bill_status" class="block text-sm font-medium text-gray-700 mb-2">Bill Status</label>
                            <select name="bill_status" id="bill_status"
                                    class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent transition duration-200 text-sm md:text-base">
                                <option value="paid">Paid</option>
                                <option value="unpaid">Unpaid</option>
                                <option value="partial">Partial</option>
                            </select>
                        </div>
                        
                        <div id="amount-paid-section" style="display:none;">
                            <label for="amount_paid" class="block text-sm font-medium text-gray-700 mb-2">Amount Paid</label>
                            <input type="number" min="0" step="0.01" name="amount_paid" id="amount_paid"
                                   class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent transition duration-200 text-sm md:text-base">
                        </div>
                    </div>
                </div>
                
                <!-- Total Summary -->
                <div class="xl:w-80">
                    <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-4 md:p-6 space-y-3">
                        <div class="flex justify-between items-center text-xl md:text-2xl font-bold text-[#ed6a3e]">
                            <span>Total Amount:</span>
                            <span>₹<span id="bill-total">0.00</span></span>
                        </div>
                        <div class="pt-3 border-t border-gray-200 space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-green-600 font-medium">Paid Amount:</span>
                                <span class="text-green-600 font-medium">₹<span id="paid-amount-display">0.00</span></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-red-600 font-medium">Unpaid Amount:</span>
                                <span class="text-red-600 font-medium">₹<span id="unpaid-amount-display">0.00</span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <input type="hidden" name="calculated_paid_amount" id="calculated_paid_amount">
            <input type="hidden" name="calculated_unpaid_amount" id="calculated_unpaid_amount">
        </div>

        <!-- Action Buttons -->
        <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 border border-gray-200">
            <div class="flex flex-col sm:flex-row gap-3 md:gap-4">
                <button type="submit" name="action" value="save"
                        class="flex-1 bg-[#ed6a3e] text-white px-4 md:px-6 py-3 rounded-lg shadow hover:bg-orange-700 transition duration-300 flex items-center justify-center text-sm md:text-base font-medium">
                    <i data-feather="save" class="mr-2 w-4 h-4"></i>
                    <span>Save Bill</span>
                </button>
                
                <button type="submit" name="action" value="generate_pdf"
                        class="flex-1 bg-gray-600 text-white px-4 md:px-6 py-3 rounded-lg shadow hover:bg-gray-700 transition duration-300 flex items-center justify-center text-sm md:text-base font-medium">
                    <i data-feather="file-text" class="mr-2 w-4 h-4"></i>
                    <span>Generate PDF</span>
                </button>
                
                <a href="{{ url_for('shopkeeper.dashboard') }}" 
                   class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 md:px-6 py-3 rounded-lg transition duration-300 flex items-center justify-center text-center text-sm md:text-base font-medium">
                    <i data-feather="x" class="mr-2 w-4 h-4"></i>
                    <span>Cancel</span>
                </a>
            </div>
        </div>
    </form>
</div>
<script type="text/javascript">
    const PRODUCTS = {{ products_js| tojson }};
</script>
<script src="/static/js/create_bill.js"></script>
<script>
    feather.replace();
    
    document.addEventListener('DOMContentLoaded', function () {
        const gstModeSection = document.getElementById('gst-mode-section');
        const billGstType = document.getElementById('bill_gst_type');
        const billStatus = document.getElementById('bill_status');
        const amountPaidSection = document.getElementById('amount-paid-section');
        const amountPaidInput = document.getElementById('amount_paid');
        const billTotal = document.getElementById('bill-total');
        const paidAmountDisplay = document.getElementById('paid-amount-display');
        const unpaidAmountDisplay = document.getElementById('unpaid-amount-display');
        const calculatedPaidAmount = document.getElementById('calculated_paid_amount');
        const calculatedUnpaidAmount = document.getElementById('calculated_unpaid_amount');

        function updateGSTSectionVisibility() {
            if (billGstType.value === 'GST') {
                gstModeSection.style.display = '';
                document.querySelectorAll('.gst-col').forEach(el => el.style.display = '');
            } else {
                gstModeSection.style.display = 'none';
                document.querySelectorAll('.gst-col').forEach(el => el.style.display = 'none');
            }
        }

        function updatePaymentFields() {
            const total = parseFloat(billTotal.textContent) || 0;
            let paid = 0, unpaid = 0;
            if (billStatus.value === 'paid') {
                paid = total;
                unpaid = 0;
                amountPaidSection.style.display = 'none';
                amountPaidInput.value = total.toFixed(2);
            } else if (billStatus.value === 'unpaid') {
                paid = 0;
                unpaid = total;
                amountPaidSection.style.display = 'none';
                amountPaidInput.value = '0.00';
            } else if (billStatus.value === 'partial') {
                amountPaidSection.style.display = '';
                paid = parseFloat(amountPaidInput.value);
                unpaid = total - paid;
                if (unpaid < 0) unpaid = 0;
                if (paid > total) { paid = total; unpaid = 0; amountPaidInput.value = total.toFixed(2); }
            }

            paidAmountDisplay.textContent = paid.toFixed(2);
            unpaidAmountDisplay.textContent = unpaid.toFixed(2);
            calculatedPaidAmount.value = paid.toFixed(2);
            calculatedUnpaidAmount.value = unpaid.toFixed(2);
        }

        billGstType.addEventListener('change', updateGSTSectionVisibility);
        billStatus.addEventListener('change', updatePaymentFields);
        amountPaidInput.addEventListener('input', updatePaymentFields);

        updateGSTSectionVisibility();
        updatePaymentFields();

        // Auto update paid/unpaid when total changes and bill status is paid
        const billTotalObserver = new MutationObserver(function() {
            if (billStatus.value === 'paid') {
                updatePaymentFields();
            }
        });
        billTotalObserver.observe(billTotal, { childList: true });
    });

    // Form Validation
    document.getElementById('create-bill-form').addEventListener('submit', function(e) {
        const billTotal = parseFloat(document.getElementById('bill-total').textContent);
        const paidAmount = parseFloat(document.getElementById('calculated_paid_amount').value);
        const unpaidAmount = parseFloat(document.getElementById('calculated_unpaid_amount').value);
        const productRowsCount = document.querySelectorAll('.product-row').length;
        
        // Check if we have any non-blank product rows
        const nonBlankRows = document.querySelectorAll('.product-row:not(.initial-blank-row)');
        const hasBlankRowOnly = productRowsCount === 1 && document.querySelector('.initial-blank-row');

        if (productRowsCount === 0 || hasBlankRowOnly || nonBlankRows.length === 0) {
            alert('Please add at least one product to the bill.');
            e.preventDefault();
            return false;
        }

        if (Math.abs((paidAmount + unpaidAmount) - billTotal) > 0.01) {
            alert('Error: Paid + Unpaid amounts do not match the total bill amount.');
            e.preventDefault();
            return false;
        }
        
        return true;
    });

    // Initialize feather icons
    setTimeout(() => feather.replace(), 100);

    // Customer management functions
    let customersData = [];

    // Load customers on page load
    function loadCustomers() {
        fetch('/shopkeeper/get_customers_list')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    customersData = data.customers;
                    populateCustomerDropdown();
                }
            })
            .catch(error => console.error('Error loading customers:', error));
    }

    function populateCustomerDropdown() {
        const dropdown = document.getElementById('existing_customer');
        dropdown.innerHTML = '<option value="">Select a customer...</option>';
        
        customersData.forEach(customer => {
            const option = document.createElement('option');
            option.value = customer.customer_id;
            option.textContent = `${customer.name} - ${customer.phone}`;
            option.dataset.customer = JSON.stringify(customer);
            dropdown.appendChild(option);
        });
    }

    function toggleCustomerFields() {
        const customerType = document.querySelector('input[name="customer_type"]:checked').value;
        const existingSection = document.getElementById('existing-customer-section');
        const paymentStatusSection = document.getElementById('payment-status-section');
        
        if (customerType === 'existing') {
            existingSection.classList.remove('hidden');
            paymentStatusSection.classList.remove('hidden');
            document.getElementById('existing_customer').required = true;
        } else {
            existingSection.classList.add('hidden');
            paymentStatusSection.classList.add('hidden');
            document.getElementById('existing_customer').required = false;
            clearCustomerFields();
        }
    }

    function fillCustomerDetails() {
        const dropdown = document.getElementById('existing_customer');
        const selectedOption = dropdown.options[dropdown.selectedIndex];
        
        if (selectedOption.value) {
            const customer = JSON.parse(selectedOption.dataset.customer);
            document.getElementById('customer_name').value = customer.name;
            document.getElementById('customer_contact').value = customer.phone;
            document.getElementById('customer_address').value = customer.address || '';
            // We can add email field if needed
        } else {
            clearCustomerFields();
        }
    }

    function clearCustomerFields() {
        document.getElementById('customer_name').value = '';
        document.getElementById('customer_contact').value = '';
        document.getElementById('customer_address').value = '';
        document.getElementById('customer_gstin').value = '';
    }

    // Show/hide partial payment field
    document.addEventListener('change', function(e) {
        if (e.target.name === 'payment_status') {
            const partialSection = document.getElementById('partial-payment-section');
            if (e.target.value === 'Partial') {
                partialSection.classList.remove('hidden');
                document.getElementById('paid_amount').required = true;
            } else {
                partialSection.classList.add('hidden');
                document.getElementById('paid_amount').required = false;
            }
        }
    });

    // Load customers when page loads
    loadCustomers();
</script>
{% endblock %}