{% extends 'shopkeeper/s_base.html' %}
{% block title %}Create Bill | MyBillingApp{% endblock %}{% block content %}
<link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css">
<script src="https://unpkg.com/feather-icons"></script>

<style>
    .product-item {
        transition: all 0.3s ease;
    }
    
    .product-item:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .remove-product {
        transition: opacity 0.3s ease;
    }
    
    .product-item:hover .remove-product {
        opacity: 1;
    }
    
    @media (max-width: 768px) {
        .product-grid {
            grid-template-columns: 1fr;
        }
        
        .product-input {
            margin-bottom: 0.75rem;
        }
        
        /* Mobile product cards styling */
        .mobile-product-card {
            overflow: visible;
        }
        
        .mobile-product-card input {
            font-size: 14px;
        }
    }
        
        .mobile-product-card label {
            font-size: 12px;
            font-weight: 600;
        }
    }
    
    /* Custom styles for the create bill page */
    .product-search-container, .customer-search-container {
        position: relative;
    }
    
    #product-suggestions, #customer_suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 50;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .product-suggestion:hover,
    .new-product-suggestion:hover,
    .customer-suggestion:hover,
    .new-customer-suggestion:hover {
        background-color: #f9fafb;
    }
    
    .product-row:hover {
        background-color: #f9fafb;
    }
    
    /* Custom scrollbar for suggestions */
    #product-suggestions::-webkit-scrollbar {
        width: 6px;
    }
    
    #product-suggestions::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    #product-suggestions::-webkit-scrollbar-thumb {
        background: #ed6a3e;
        border-radius: 3px;
    }
    
    #product-suggestions::-webkit-scrollbar-thumb:hover {
        background: #d45f34;
    }
</style>

<div class="p-4 md:p-8">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-6 md:mb-8 space-y-4 md:space-y-0">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 flex items-center">
                <i data-feather="plus-circle" class="w-6 h-6 md:w-8 md:h-8 mr-3 text-[#ed6a3e]"></i>
                Create New Bill
            </h1>
            <p class="text-gray-600 text-sm md:text-base mt-1">Generate a new bill for your customer</p>
        </div>
        <div class="flex items-center space-x-2 md:space-x-4">
            <a href="{{ url_for('shopkeeper.manage_bills') }}" 
               class="flex items-center space-x-2 bg-gray-100 hover:bg-gray-200 px-3 md:px-4 py-2 rounded-lg transition duration-300 text-sm md:text-base">
                <i data-feather="file-text" class="w-4 h-4"></i>
                <span class="hidden md:inline">Manage Bills</span>
                <span class="md:hidden">Bills</span>
            </a>
            <a href="{{ url_for('shopkeeper.dashboard') }}" 
               class="flex items-center space-x-2 bg-gray-100 hover:bg-gray-200 px-3 md:px-4 py-2 rounded-lg transition duration-300 text-sm md:text-base">
                <i data-feather="home" class="w-4 h-4"></i>
                <span class="hidden md:inline">Dashboard</span>
                <span class="md:hidden">Home</span>
            </a>
        </div>
    </div>

    <!-- Bill Form -->
    <form id="create-bill-form" method="POST" action="{{ url_for('shopkeeper.generate_bill_pdf') }}" class="space-y-6">
        <!-- Customer Details Section -->
        <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 border border-gray-200">
            <div class="flex items-center mb-4">
                <i data-feather="user" class="w-5 h-5 text-[#ed6a3e] mr-2"></i>
                <h2 class="text-lg md:text-xl font-bold text-gray-800">Customer Details</h2>
            </div>
            
            <!-- Customer Selection -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Customer Type</label>
                <div class="flex flex-col sm:flex-row gap-4">
                    <label class="flex items-center">
                        <input type="radio" name="customer_type" value="existing" class="mr-2" onchange="toggleCustomerFields()">
                        <span class="text-sm">Existing Customer</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="customer_type" value="new" class="mr-2" checked onchange="toggleCustomerFields()">
                        <span class="text-sm">New/Guest Customer</span>
                    </label>
                </div>
            </div>

            <!-- Save as Customer Toggle (only for new/guest customers) -->
            <div id="save-customer-toggle" class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <label for="save_as_customer" class="flex items-center cursor-pointer">
                            <input type="checkbox" 
                                   id="save_as_customer" 
                                   name="save_as_customer" 
                                   value="1" 
                                   class="w-4 h-4 text-[#ed6a3e] bg-gray-100 border-gray-300 rounded focus:ring-[#ed6a3e] focus:ring-2">
                            <span class="ml-2 text-sm font-medium text-gray-700">Save customer details to my customer list</span>
                        </label>
                    </div>
                    <div class="ml-3">
                        <button type="button" 
                                class="text-blue-600 hover:text-blue-800 text-xs"
                                onclick="showSaveCustomerHelp()"
                                title="Click for more information">
                            <i data-feather="help-circle" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                <div id="save-customer-help" class="hidden mt-2 text-xs text-gray-600">
                    <p>When enabled, this customer's details will be saved to your customer database for future billing. If disabled, the bill will be created but no customer record will be saved. To save the credit/unpaid data please select the buttons.</p>
                </div>
            </div>

            <!-- Existing Customer Selection -->
            <div id="existing-customer-section" class="hidden mb-4">
                <label for="customer_search" class="block text-sm font-medium text-gray-700 mb-2">
                    Select Customer <span class="text-red-500">*</span>
                </label>
                <div class="customer-search-container relative">
                    <input type="text" id="customer_search" 
                           placeholder="Search customers by name or phone number..."
                           class="w-full pl-10 pr-4 py-2 md:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent transition duration-200 text-sm md:text-base">
                    <i data-feather="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"></i>
                    <div id="customer_suggestions" class="bg-white border border-gray-300 rounded-lg mt-1 shadow-lg hidden z-50"></div>
                    <input type="hidden" id="existing_customer" name="existing_customer_id" value="">
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 gap-4">
                <div>
                    <label for="customer_name" class="block text-sm font-medium text-gray-700 mb-2">
                        Customer Name <span class="text-red-500">*</span>
                    </label>
                    <input type="text" name="customer_name" id="customer_name" required 
                           placeholder="Enter customer name"
                           class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent transition duration-200 text-sm md:text-base">
                </div>
                
                <div>
                    <label for="customer_contact" class="block text-sm font-medium text-gray-700 mb-2">Customer Contact</label>
                    <input type="tel" 
                           name="customer_contact" 
                           id="customer_contact"
                           pattern="^[6-9]\d{9}$"
                           maxlength="10"
                           placeholder="10 digit mobile number"
                           title="Please enter a valid 10 digit mobile number"
                           class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent transition duration-200 text-sm md:text-base"
                           oninput="this.value = this.value.replace(/[^0-9]/g, '').substring(0, 10);">
                </div>
                
                <div>
                    <label for="customer_address" class="block text-sm font-medium text-gray-700 mb-2">Customer Address</label>
                    <input type="text" name="customer_address" id="customer_address"
                           placeholder="Enter address"
                           class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent transition duration-200 text-sm md:text-base">
                </div>
                
                <div>
                    <label for="customer_gstin" class="block text-sm font-medium text-gray-700 mb-2">Customer GSTIN</label>
                    <input type="text" name="customer_gstin" id="customer_gstin"
                           placeholder="Enter GSTIN"
                           class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent transition duration-200 text-sm md:text-base">
                </div>
            </div>

            <!-- Payment Status for Existing Customers -->
            <div id="payment-status-section" class="hidden mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Payment Status</label>
                <div class="flex flex-col sm:flex-row gap-4">
                    <label class="flex items-center">
                        <input type="radio" name="payment_status" value="Paid" class="mr-2" checked>
                        <span class="text-sm">Paid</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="payment_status" value="Partial" class="mr-2">
                        <span class="text-sm">Partial Payment</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="payment_status" value="Unpaid" class="mr-2">
                        <span class="text-sm">Credit (Unpaid)</span>
                    </label>
                </div>
                
                <div id="partial-payment-section" class="hidden mt-3">
                    <label for="paid_amount" class="block text-sm font-medium text-gray-700 mb-2">Amount Paid</label>
                    <input type="number" name="paid_amount" id="paid_amount" step="0.01" min="0"
                           placeholder="Enter amount paid"
                           class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent transition duration-200 text-sm md:text-base">
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                <div>
                    <label for="bill-date" class="block text-sm font-medium text-gray-700 mb-2">
                        Bill Date & Time <span class="text-red-500">*</span>
                    </label>
                    <input type="datetime-local" name="bill_date" id="bill-date"
                           class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent transition duration-200 text-sm md:text-base"
                           value="{{ now.strftime('%Y-%m-%dT%H:%M') }}" required>
                </div>
                
                <div>
                    <label for="bill_gst_type" class="block text-sm font-medium text-gray-700 mb-2">GST Type</label>
                    <select name="bill_gst_type" id="bill_gst_type"
                            class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent transition duration-200 text-sm md:text-base">
                        <option value="GST">GST</option>
                        <option value="Non-GST">Non-GST</option>
                    </select>
                </div>
                
                <div id="gst-mode-section">
                    <label for="gst_mode" class="block text-sm font-medium text-gray-700 mb-2">GST Mode</label>
                    <select name="gst_mode" id="gst_mode"
                            class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent transition duration-200 text-sm md:text-base">
                        <option value="exclusive">GST Exclusive (add GST on top)</option>
                        <option value="inclusive">GST Inclusive (price includes GST)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Products Section -->
        <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 border border-gray-200">
            <div class="flex items-center mb-4">
                <i data-feather="package" class="w-5 h-5 text-[#ed6a3e] mr-2"></i>
                <h2 class="text-lg md:text-xl font-bold text-gray-800">Products</h2>
            </div>
            
            <!-- Product Search -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Search & Add Products</label>
                <div class="product-search-container relative">
                    <input type="text" id="product-search" 
                           placeholder="Search products by name or add new product..."
                           class="w-full pl-10 pr-4 py-2 md:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent transition duration-200 text-sm md:text-base">
                    <i data-feather="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"></i>
                    <div id="product-suggestions" class="bg-white border border-gray-300 rounded-lg mt-1 shadow-lg hidden"></div>
                </div>
            </div>

            <!-- Desktop Table View -->
            <div class="hidden lg:block border border-gray-200 rounded-lg overflow-hidden">
                <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                    <div class="grid grid-cols-13 gap-3 items-center text-sm font-medium text-gray-700">
                        <div class="col-span-2">Product Name</div>
                        <div class="col-span-2 text-center">Available Stock</div>
                        <div class="col-span-1 text-center">Qty</div>
                        <div class="col-span-2 text-center">Price/Unit</div>
                        <div class="col-span-1 text-center">HSN Code</div>
                        <div class="col-span-1 text-center">Discount %</div>
                        <div class="col-span-2 text-center gst-col">GST Rate %</div>
                        <div class="col-span-1 text-center">Total</div>
                        <div class="col-span-1 text-center">Action</div>
                    </div>
                </div>
                <div id="product-rows" class="divide-y divide-gray-200">
                    <!-- Product rows will be added here -->
                    <div id="no-products-message" class="px-4 py-8 text-center text-gray-500">
                        <i data-feather="package" class="w-12 h-12 mx-auto mb-3 text-gray-300"></i>
                        <p class="text-lg font-medium mb-2">No products added yet</p>
                        <p class="text-sm">Search for products above or click "Add Product" to get started</p>
                    </div>
                </div>
            </div>

            <!-- Mobile Product Cards -->
            <div class="lg:hidden" id="mobile-products">
                <div id="mobile-no-products" class="text-center py-8 bg-gray-50 rounded-lg">
                    <i data-feather="package" class="w-12 h-12 text-gray-300 mx-auto mb-3"></i>
                    <p class="text-lg font-medium text-gray-600 mb-2">No products added yet</p>
                    <p class="text-sm text-gray-500 mb-4">Search for products above or Add Product</p>
                </div>
            </div>

            <button type="button" id="add-product-btn"
                    class="mt-4 w-full md:w-auto bg-[#ed6a3e] text-white px-6 py-3 rounded-lg shadow hover:bg-orange-700 transition duration-300 flex items-center justify-center">
                <i data-feather="plus" class="mr-2 w-4 h-4"></i>
                <span>Add Product</span>
            </button>
        </div>

        <!-- Bill Summary Section -->
        <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 border border-gray-200">
            <div class="flex items-center mb-4">
                <i data-feather="calculator" class="w-5 h-5 text-[#ed6a3e] mr-2"></i>
                <h2 class="text-lg md:text-xl font-bold text-gray-800">Bill Summary</h2>
            </div>
            
            <div class="flex flex-col xl:flex-row gap-6">
                <!-- Payment Details -->
                <div class="flex-1 space-y-4">
                    <!-- Payment details section removed - now using radio buttons only -->
                
                <!-- Total Summary -->
                <div class="xl:w-80">
                    <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-4 md:p-6 space-y-3">
                        <div class="flex justify-between items-center text-xl md:text-2xl font-bold text-[#ed6a3e]">
                            <span>Total Amount:</span>
                            <span>₹<span id="bill-total">0.00</span></span>
                        </div>
                        <div class="pt-3 border-t border-gray-200 space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-green-600 font-medium">Paid Amount:</span>
                                <span class="text-green-600 font-medium">₹<span id="paid-amount-display">0.00</span></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-red-600 font-medium">Unpaid Amount:</span>
                                <span class="text-red-600 font-medium">₹<span id="unpaid-amount-display">0.00</span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <input type="hidden" name="calculated_paid_amount" id="calculated_paid_amount">
            <input type="hidden" name="calculated_unpaid_amount" id="calculated_unpaid_amount">
        </div>

        <!-- Action Buttons -->
        <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 border border-gray-200">
            <div class="flex flex-col sm:flex-row gap-3 md:gap-4">
                <button type="submit" name="action" value="save"
                        class="flex-1 bg-[#ed6a3e] text-white px-4 md:px-6 py-3 rounded-lg shadow hover:bg-orange-700 transition duration-300 flex items-center justify-center text-sm md:text-base font-medium">
                    <i data-feather="save" class="mr-2 w-4 h-4"></i>
                    <span>Save Bill</span>
                </button>
                
                <button type="submit" name="action" value="generate_pdf"
                        class="flex-1 bg-gray-600 text-white px-4 md:px-6 py-3 rounded-lg shadow hover:bg-gray-700 transition duration-300 flex items-center justify-center text-sm md:text-base font-medium">
                    <i data-feather="file-text" class="mr-2 w-4 h-4"></i>
                    <span>Generate PDF</span>
                </button>
                
                <a href="{{ url_for('shopkeeper.dashboard') }}" 
                   class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 md:px-6 py-3 rounded-lg transition duration-300 flex items-center justify-center text-center text-sm md:text-base font-medium">
                    <i data-feather="x" class="mr-2 w-4 h-4"></i>
                    <span>Cancel</span>
                </a>
            </div>
        </div>
    </form>
</div>
<script type="text/javascript">
    const PRODUCTS = {{ products_js| tojson }};
</script>
<script src="/static/js/create_bill.js"></script>
<script>
    feather.replace();
    
    document.addEventListener('DOMContentLoaded', function () {
        const gstModeSection = document.getElementById('gst-mode-section');
        const billGstType = document.getElementById('bill_gst_type');
        // Removed billStatus and amountPaidSection - using radio buttons only
        const billTotal = document.getElementById('bill-total');
        const paidAmountDisplay = document.getElementById('paid-amount-display');
        const unpaidAmountDisplay = document.getElementById('unpaid-amount-display');
        const calculatedPaidAmount = document.getElementById('calculated_paid_amount');
        const calculatedUnpaidAmount = document.getElementById('calculated_unpaid_amount');
        const paymentStatusRadios = document.querySelectorAll('input[name="payment_status"]');
        const partialPaymentSection = document.getElementById('partial-payment-section');
        const paidAmountRadioInput = document.getElementById('paid_amount');

        function updateGSTSectionVisibility() {
            if (billGstType.value === 'GST') {
                gstModeSection.style.display = '';
                document.querySelectorAll('.gst-col').forEach(el => el.style.display = '');
            } else {
                gstModeSection.style.display = 'none';
                document.querySelectorAll('.gst-col').forEach(el => el.style.display = 'none');
            }
        }

        function updatePaymentFields() {
            const total = parseFloat(billTotal.textContent) || 0;
            let paid = 0, unpaid = 0;

            // Only handling radio buttons now (existing customers)
            const selectedPaymentStatus = document.querySelector('input[name="payment_status"]:checked').value;

            if (selectedPaymentStatus === 'Paid') {
                paid = total;
                unpaid = 0;
                paidAmountRadioInput.value = total.toFixed(2);
            } else if (selectedPaymentStatus === 'Unpaid') {
                paid = 0;
                unpaid = total;
                paidAmountRadioInput.value = '0.00';
            } else if (selectedPaymentStatus === 'Partial') {
                paid = parseFloat(paidAmountRadioInput.value) || 0;
                unpaid = total - paid;
                if (unpaid < 0) unpaid = 0;
                if (paid > total) {
                    paid = total;
                    unpaid = 0;
                    paidAmountRadioInput.value = total.toFixed(2);
                }
            }

            paidAmountDisplay.textContent = paid.toFixed(2);
            unpaidAmountDisplay.textContent = unpaid.toFixed(2);
            calculatedPaidAmount.value = paid.toFixed(2);
            calculatedUnpaidAmount.value = unpaid.toFixed(2);
        }

        billGstType.addEventListener('change', updateGSTSectionVisibility);
        // Removed billStatus and amountPaidInput listeners - using radio buttons only

        // Add listeners for payment status radio buttons
        paymentStatusRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                // Show/hide partial payment section for radio buttons
                if (this.value === 'Partial') {
                    partialPaymentSection.classList.remove('hidden');
                    paidAmountRadioInput.required = true;
                } else {
                    partialPaymentSection.classList.add('hidden');
                    paidAmountRadioInput.required = false;
                }
                updatePaymentFields();
            });
        });
        
        // Add listener for radio button partial amount input
        paidAmountRadioInput.addEventListener('input', updatePaymentFields);

        updateGSTSectionVisibility();
        updatePaymentFields();

        // Auto update paid/unpaid when total changes
        const billTotalObserver = new MutationObserver(function() {
            updatePaymentFields();
        });
        billTotalObserver.observe(billTotal, { childList: true });
    });

    // Form Validation
    document.getElementById('create-bill-form').addEventListener('submit', function(e) {
        const billTotal = parseFloat(document.getElementById('bill-total').textContent);
        const paidAmount = parseFloat(document.getElementById('calculated_paid_amount').value);
        const unpaidAmount = parseFloat(document.getElementById('calculated_unpaid_amount').value);
        const productRowsCount = document.querySelectorAll('.product-row').length;
        
        // Check if we have any non-blank product rows
        const nonBlankRows = document.querySelectorAll('.product-row:not(.initial-blank-row)');
        const hasBlankRowOnly = productRowsCount === 1 && document.querySelector('.initial-blank-row');

        if (productRowsCount === 0 || hasBlankRowOnly || nonBlankRows.length === 0) {
            showError('Please add at least one product to the bill.');
            e.preventDefault();
            return false;
        }

        if (Math.abs((paidAmount + unpaidAmount) - billTotal) > 0.01) {
            showError('Error: Paid + Unpaid amounts do not match the total bill amount.');
            e.preventDefault();
            return false;
        }
        
        return true;
    });

    // Initialize feather icons
    setTimeout(() => feather.replace(), 100);

    // Customer management functions
    let customersData = [];

    // Load customers on page load
    function loadCustomers() {
        fetch('/shopkeeper/get_customers_list')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    customersData = data.customers;
                    populateCustomerDropdown();
                }
            })
            .catch(error => console.error('Error loading customers:', error));
    }

    function populateCustomerDropdown() {
        // This function is now mainly for backwards compatibility
        // Customer search will handle the suggestions dynamically
        setupCustomerSearch();
    }

    function setupCustomerSearch() {
        const customerSearch = document.getElementById('customer_search');
        const customerSuggestions = document.getElementById('customer_suggestions');
        let searchTimeout;

        if (!customerSearch || !customerSuggestions) return;

        // Customer search functionality
        customerSearch.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.toLowerCase().trim();
            
            if (query.length < 1) {
                customerSuggestions.classList.add('hidden');
                // Clear hidden field when search is empty
                document.getElementById('existing_customer').value = '';
                return;
            }

            searchTimeout = setTimeout(() => {
                showCustomerSuggestions(query);
            }, 300);
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!customerSearch.contains(e.target) && !customerSuggestions.contains(e.target)) {
                customerSuggestions.classList.add('hidden');
            }
        });
    }

    function showCustomerSuggestions(query) {
        const customerSuggestions = document.getElementById('customer_suggestions');
        const matchedCustomers = customersData.filter(customer => 
            customer.name.toLowerCase().includes(query) || 
            customer.phone.toLowerCase().includes(query)
        );

        let html = '';
        
        // Show matched customers
        matchedCustomers.forEach(customer => {
            html += `
                <div class="px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 customer-suggestion" 
                     data-customer='${JSON.stringify(customer)}'>
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-medium text-gray-800">${customer.name}</p>
                            <p class="text-sm text-gray-500">${customer.phone}${customer.address ? ' | ' + customer.address : ''}</p>
                        </div>
                        <div class="text-sm text-[#ed6a3e] font-medium">
                            <i data-feather="user-check" class="w-4 h-4 inline"></i>
                        </div>
                    </div>
                </div>
            `;
        });

        // Add option for new customer if no exact match
        const exactNameMatch = matchedCustomers.find(c => c.name.toLowerCase() === query);
        const exactPhoneMatch = matchedCustomers.find(c => c.phone === query);
        if (!exactNameMatch && !exactPhoneMatch && query.length > 0) {
            // Check if query looks like a phone number (10 digits starting with 6-9)
            const isPhoneNumber = /^[6-9]\d{9}$/.test(query);
            const suggestionText = isPhoneNumber ? 
                `+ Add new customer with phone: "${query}"` : 
                `+ Add new customer: "${query}"`;
            
            html += `
                <div class="px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 new-customer-suggestion bg-blue-50" 
                     data-name="${query}" data-is-phone="${isPhoneNumber}">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-medium text-blue-800">${suggestionText}</p>
                            <p class="text-sm text-blue-600">Click to create new customer</p>
                        </div>
                        <div class="text-sm text-blue-600 font-medium">
                            <i data-feather="user-plus" class="w-4 h-4 inline"></i>
                        </div>
                    </div>
                </div>
            `;
        }

        if (html) {
            customerSuggestions.innerHTML = html;
            customerSuggestions.classList.remove('hidden');
            
            // Reinitialize feather icons for the suggestions
            feather.replace();
            
            // Add click handlers for existing customers
            customerSuggestions.querySelectorAll('.customer-suggestion').forEach(item => {
                item.addEventListener('click', function() {
                    const customerData = JSON.parse(this.dataset.customer);
                    selectCustomer(customerData);
                    document.getElementById('customer_search').value = customerData.name;
                    customerSuggestions.classList.add('hidden');
                });
            });

            // Add click handlers for new customers
            customerSuggestions.querySelectorAll('.new-customer-suggestion').forEach(item => {
                item.addEventListener('click', function() {
                    const customerName = this.dataset.name;
                    const isPhone = this.dataset.isPhone === 'true';
                    createNewCustomerFromSearch(customerName, isPhone);
                    customerSuggestions.classList.add('hidden');
                });
            });
        } else {
            customerSuggestions.classList.add('hidden');
        }
    }

    function selectCustomer(customerData) {
        // Fill the hidden field
        document.getElementById('existing_customer').value = customerData.customer_id;
        
        // Fill customer details in the form
        document.getElementById('customer_name').value = customerData.name;
        document.getElementById('customer_contact').value = customerData.phone;
        document.getElementById('customer_address').value = customerData.address || '';
        document.getElementById('customer_gstin').value = customerData.gstin || '';
    }

    function createNewCustomerFromSearch(searchValue, isPhone) {
        // Switch to new customer mode
        const newCustomerRadio = document.querySelector('input[name="customer_type"][value="new"]');
        if (newCustomerRadio) {
            newCustomerRadio.checked = true;
            toggleCustomerFields();
        }
        
        // Clear the customer search and hide the existing customer section
        document.getElementById('customer_search').value = '';
        document.getElementById('existing_customer').value = '';
        
        // Pre-fill the appropriate field
        if (isPhone) {
            document.getElementById('customer_contact').value = searchValue;
        } else {
            document.getElementById('customer_name').value = searchValue;
        }
        
        // Focus on the next empty field
        if (isPhone) {
            document.getElementById('customer_name').focus();
        } else {
            document.getElementById('customer_contact').focus();
        }
    }

    function toggleCustomerFields() {
        const customerType = document.querySelector('input[name="customer_type"]:checked').value;
        const existingSection = document.getElementById('existing-customer-section');
        const paymentStatusSection = document.getElementById('payment-status-section');
        const saveCustomerToggle = document.getElementById('save-customer-toggle');
        const saveAsCustomer = document.getElementById('save_as_customer');
        
        if (customerType === 'existing') {
            existingSection.classList.remove('hidden');
            paymentStatusSection.classList.remove('hidden');
            saveCustomerToggle.classList.add('hidden');
            document.getElementById('existing_customer').required = true;
            // Uncheck and disable save as customer for existing customers
            saveAsCustomer.checked = false;
        } else {
            existingSection.classList.add('hidden');
            saveCustomerToggle.classList.remove('hidden');
            document.getElementById('existing_customer').required = false;
            clearCustomerFields();
            // Show/hide payment status based on save-customer toggle for new customers
            togglePaymentStatusForNewCustomer();
        }
    }
    
    function togglePaymentStatusForNewCustomer() {
        const customerType = document.querySelector('input[name="customer_type"]:checked').value;
        const saveAsCustomer = document.getElementById('save_as_customer');
        const paymentStatusSection = document.getElementById('payment-status-section');
        const partialPaymentSection = document.getElementById('partial-payment-section');
        const paidAmountRadioInput = document.getElementById('paid_amount');
        const paidAmountDisplay = document.getElementById('paid-amount-display');
        const unpaidAmountDisplay = document.getElementById('unpaid-amount-display');
        const calculatedPaidAmount = document.getElementById('calculated_paid_amount');
        const calculatedUnpaidAmount = document.getElementById('calculated_unpaid_amount');
        const billTotal = parseFloat(document.getElementById('bill-total').textContent) || 0;

        if (customerType === 'new' && saveAsCustomer.checked) {
            paymentStatusSection.classList.remove('hidden');

            // Determine selected payment status and apply same logic as radio change
            const selected = document.querySelector('input[name="payment_status"]:checked');
            const selectedValue = selected ? selected.value : 'Paid';

            if (selectedValue === 'Paid') {
                partialPaymentSection.classList.add('hidden');
                paidAmountRadioInput.required = false;
                const paid = billTotal;
                const unpaid = 0;
                paidAmountRadioInput.value = paid.toFixed(2);
                paidAmountDisplay.textContent = paid.toFixed(2);
                unpaidAmountDisplay.textContent = unpaid.toFixed(2);
                calculatedPaidAmount.value = paid.toFixed(2);
                calculatedUnpaidAmount.value = unpaid.toFixed(2);
            } else if (selectedValue === 'Unpaid') {
                partialPaymentSection.classList.add('hidden');
                paidAmountRadioInput.required = false;
                const paid = 0;
                const unpaid = billTotal;
                paidAmountRadioInput.value = '0.00';
                paidAmountDisplay.textContent = paid.toFixed(2);
                unpaidAmountDisplay.textContent = unpaid.toFixed(2);
                calculatedPaidAmount.value = paid.toFixed(2);
                calculatedUnpaidAmount.value = unpaid.toFixed(2);
            } else { // Partial
                partialPaymentSection.classList.remove('hidden');
                paidAmountRadioInput.required = true;
                const paid = parseFloat(paidAmountRadioInput.value) || 0;
                let unpaid = billTotal - paid;
                if (unpaid < 0) unpaid = 0;
                if (paid > billTotal) {
                    paidAmountRadioInput.value = billTotal.toFixed(2);
                    paid = billTotal;
                    unpaid = 0;
                }
                paidAmountDisplay.textContent = paid.toFixed(2);
                unpaidAmountDisplay.textContent = unpaid.toFixed(2);
                calculatedPaidAmount.value = paid.toFixed(2);
                calculatedUnpaidAmount.value = unpaid.toFixed(2);
            }
        } else if (customerType === 'new') {
            // Hide payment options for new customer when toggle off
            paymentStatusSection.classList.add('hidden');
            partialPaymentSection.classList.add('hidden');
            paidAmountRadioInput.required = false;
            // Reset amounts to Paid default
            const paid = billTotal;
            const unpaid = 0;
            paidAmountRadioInput.value = paid.toFixed(2);
            paidAmountDisplay.textContent = paid.toFixed(2);
            unpaidAmountDisplay.textContent = unpaid.toFixed(2);
            calculatedPaidAmount.value = paid.toFixed(2);
            calculatedUnpaidAmount.value = unpaid.toFixed(2);
        }
    }

    function showSaveCustomerHelp() {
        const helpDiv = document.getElementById('save-customer-help');
        helpDiv.classList.toggle('hidden');
    }

    function fillCustomerDetails() {
        // This function is now handled by selectCustomer() when using search
        // Keep this for backwards compatibility if needed
        const hiddenField = document.getElementById('existing_customer');
        if (hiddenField.value) {
            const customer = customersData.find(c => c.customer_id == hiddenField.value);
            if (customer) {
                selectCustomer(customer);
            }
        } else {
            clearCustomerFields();
        }
    }

    function clearCustomerFields() {
        document.getElementById('customer_name').value = '';
        document.getElementById('customer_contact').value = '';
        document.getElementById('customer_address').value = '';
        document.getElementById('customer_gstin').value = '';
        
        // Clear search field and hidden field
        const customerSearch = document.getElementById('customer_search');
        const existingCustomer = document.getElementById('existing_customer');
        const customerSuggestions = document.getElementById('customer_suggestions');
        
        if (customerSearch) customerSearch.value = '';
        if (existingCustomer) existingCustomer.value = '';
        if (customerSuggestions) customerSuggestions.classList.add('hidden');
    }

    // Load customers when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadCustomers();
        feather.replace();
        
        // Add event listener for save-as-customer checkbox
        const saveAsCustomerCheckbox = document.getElementById('save_as_customer');
        if (saveAsCustomerCheckbox) {
            saveAsCustomerCheckbox.addEventListener('change', function() {
                togglePaymentStatusForNewCustomer();
            });
        }
    });

    // Custom notification functions
    function showSuccess(message) {
        showNotification(message, 'success');
    }

    function showError(message) {
        showNotification(message, 'error');
    }

    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;
        
        if (type === 'success') {
            notification.className += ' bg-green-500 text-white';
            notification.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>${message}</span>
                </div>`;
        } else {
            notification.className += ' bg-red-500 text-white';
            notification.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                    </svg>
                    <span>${message}</span>
                </div>`;
        }
        
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => {
            notification.classList.remove('translate-x-full');
        }, 100);
        
        // Auto remove after 4 seconds
        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 4000);
    }
</script>
{% endblock %}