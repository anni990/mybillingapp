{% extends 'shopkeeper/s_base.html' %}
{% block title %}Scan Purchase Bill | MyBillingApp{% endblock %}
{% block shop_name %} {{ shop_name }} {% endblock %}
{% block content %}
<link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css">
<script src="https://unpkg.com/feather-icons"></script>

<style>
    .tab-pane {
        display: none;
    }
    .tab-pane.active {
        display: block;
    }
    
    .product-search-container {
        position: relative;
    }
    
    #product-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 50;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .product-suggestion:hover,
    .new-product-suggestion:hover {
        background-color: #f9fafb;
    }
    
    .product-row:hover {
        background-color: #f9fafb;
    }
    
    /* Flash message animations */
    .flash-message {
        animation: slideInDown 0.3s ease-out;
    }
    
    @keyframes slideInDown {
        from {
            opacity: 0;
            transform: translate3d(0, -100%, 0);
        }
        to {
            opacity: 1;
            transform: translate3d(0, 0, 0);
        }
    }
    
    /* Notification container styling */
    #notification-container {
        pointer-events: none;
    }
    
    #notification-container > * {
        pointer-events: auto;
    }
    
    /* Form validation styling */
    .input-error {
        border-color: #ef4444 !important;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }
    
    .input-success {
        border-color: #10b981 !important;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    
    /* Loading button animation */
    button:disabled {
        cursor: not-allowed;
        opacity: 0.7;
    }
</style>

<div class="p-4 md:p-8">
    <!-- Flash Messages -->
    <div id="flash-messages" class="mb-6">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message {{ 'bg-green-50 border-green-200 text-green-800' if category == 'success' else 'bg-red-50 border-red-200 text-red-800' if category == 'error' else 'bg-blue-50 border-blue-200 text-blue-800' }} border rounded-lg p-4 mb-4 flex items-center justify-between">
                        <div class="flex items-center">
                            {% if category == 'success' %}
                                <i data-feather="check-circle" class="w-5 h-5 mr-3"></i>
                            {% elif category == 'error' %}
                                <i data-feather="x-circle" class="w-5 h-5 mr-3"></i>
                            {% else %}
                                <i data-feather="info" class="w-5 h-5 mr-3"></i>
                            {% endif %}
                            <span class="font-medium">{{ message }}</span>
                        </div>
                        <button onclick="this.parentElement.remove()" class="ml-4 hover:opacity-70 transition-opacity">
                            <i data-feather="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- Notification Container for Dynamic Messages -->
    <div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Header Section -->
    <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-6 md:mb-8 space-y-4 md:space-y-0 sm:-mt-5 lg:-mt-8">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 flex items-center">
                <i data-feather="camera" class="w-6 h-6 md:w-8 md:h-8 mr-3 text-[#ed6a3e]"></i>
                Scan Purchase Bill
            </h1>
            <p class="text-gray-600 text-sm md:text-base mt-1">Upload and process your purchase bills or enter manually</p>
        </div>
        <div class="flex items-center space-x-2 md:space-x-4">
            <a href="{{ url_for('shopkeeper.purchase_bills') }}" 
               class="flex items-center space-x-2 bg-blue-100 hover:bg-blue-200 text-blue-600 font-bold px-3 md:px-4 py-2 rounded-lg transition duration-300 text-sm md:text-base">
                <i data-feather="list" class="w-4 h-4"></i>
                <span class="hidden md:inline">All Purchase Bills</span>
                <span class="md:hidden">Bills</span>
            </a>
            <!-- <a href="{{ url_for('shopkeeper.dashboard') }}" 
               class="flex items-center space-x-2 bg-gray-100 hover:bg-gray-200 px-3 md:px-4 py-2 rounded-lg transition duration-300 text-sm md:text-base">
                <i data-feather="home" class="w-4 h-4"></i>
                <span class="hidden md:inline">Dashboard</span>
                <span class="md:hidden">Home</span>
            </a> -->
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="bg-white rounded-xl shadow-lg mb-6 border border-gray-200">
        <div class="flex border-b border-gray-200">
            <button id="upload-tab" class="flex-1 px-4 py-3 md:px-6 md:py-4 text-center font-medium text-sm md:text-base transition duration-300 bg-[#ed6a3e] text-white rounded-tl-xl">
                <i data-feather="upload" class="w-4 h-4 md:w-5 md:h-5 inline mr-2"></i>
                Upload Purchase Bill
            </button>
            <button id="manual-tab" class="flex-1 px-4 py-3 md:px-6 md:py-4 text-center font-medium text-sm md:text-base transition duration-300 text-gray-600 rounded-tr-xl">
                <i data-feather="edit" class="w-4 h-4 md:w-5 md:h-5 inline mr-2"></i>
                Manual Entry
            </button>
        </div>
    </div>

    <!-- Tab Content Container -->
    <div id="tab-content">
        
        <!-- Upload Tab Content -->
        <div id="upload-content" class="tab-pane active">
            <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-6 border border-gray-200">
                <div class="flex items-center mb-4">
                    <i data-feather="upload" class="w-5 h-5 text-[#ed6a3e] mr-2"></i>
                    <h2 class="text-lg md:text-xl font-bold text-gray-800">Upload Purchase Bill</h2>
                </div>
                
                <p class="text-gray-600 mb-6">Choose how you want to upload your purchase bill for AI processing:</p>

                <!-- Working button -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <!-- Upload file device -->
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border border-blue-200">
                        <button id="upload-from-device" class="w-full group  cursor-pointer">
                            <div class="flex flex-col items-center text-center">
                                <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mb-4 group-hover:bg-blue-600 transition duration-300">
                                    <i class="fas fa-upload text-white text-2xl"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-blue-800 mb-2">Upload from Device</h3>
                                <p class="text-sm text-blue-600">Select PDF, JPG, JPEG, or PNG files from your device</p>
                            </div>
                        </button>
                    </div>

                    <!-- Upload with Camera -->
                    <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border border-green-200">
                        <button id="scan-with-camera" class="w-full group cursor-pointer">
                            <div class="flex flex-col items-center text-center">
                                <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mb-4 group-hover:bg-green-600 transition duration-300">
                                    <i class="fas fa-camera text-white text-2xl"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-green-800 mb-2">Scan with Camera</h3>
                                <p class="text-sm text-green-600">Use your device camera to capture the bill directly</p>
                            </div>
                        </button>
                    </div>
                </div>


                <!-- Hidden file input -->
                <input type="file" id="bill-file-input" accept=".pdf,.jpg,.jpeg,.png" style="display: none;">

                <!-- Camera section (initially hidden) -->
                <div id="camera-section" class="hidden bg-gray-50 rounded-xl p-6 border border-gray-200">
                    <div class="text-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Camera Preview</h3>
                        <p class="text-sm text-gray-600">Position your purchase bill in the camera view and capture</p>
                    </div>
                    <video id="camera-preview" class="w-full max-w-md mx-auto rounded-lg mb-4 border-2 border-gray-300" autoplay playsinline></video>
                    <canvas id="camera-canvas" style="display: none;"></canvas>
                    <div class="flex justify-center space-x-3">
                        <button id="capture-photo" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg transition duration-300 font-medium">
                            <i class="fas fa-camera w-4 h-4 inline mr-2"></i>
                            Capture Photo
                        </button>
                        <button id="cancel-camera" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg transition duration-300 font-medium">
                            <i class="fas fa-times w-4 h-4 inline mr-2"></i>
                            Cancel
                        </button>
                    </div>
                </div>

                <!-- File Preview & Processing Section -->
                <div id="file-preview-section" class="hidden">
                    <!-- File Ready Status -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-3 text-xl"></i>
                            <div>
                                <p class="text-sm font-medium text-green-800">File Ready for AI Processing</p>
                                <p class="text-xs text-green-600" id="file-name-display"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Preview Area -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- File Preview -->
                        <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                            <h3 class="text-md font-semibold text-gray-800 mb-3">File Preview</h3>
                            
                            <!-- Image Preview -->
                            <div id="image-preview" class="hidden">
                                <img id="preview-image" class="w-full h-auto max-h-80 object-contain rounded-lg border border-gray-300 bg-white" alt="Bill Preview">
                            </div>

                            <!-- PDF Preview -->
                            <div id="pdf-preview" class="hidden text-center py-8">
                                <i class="fas fa-file-pdf text-red-500 text-6xl mb-4"></i>
                                <p class="text-sm text-gray-600" id="pdf-name">PDF Ready for Processing</p>
                            </div>
                        </div>

                        <!-- Processing Options -->
                        <div class="space-y-4">
                            <div class="bg-white rounded-xl p-4 border border-gray-200">
                                <h3 class="text-md font-semibold text-gray-800 mb-3">AI Processing</h3>
                                <p class="text-sm text-gray-600 mb-4">Our AI will extract vendor details, items, and automatically update your inventory.</p>
                                
                                <button id="process-with-ai" class="w-full bg-[#ed6a3e] hover:bg-orange-700 text-white px-4 py-3 rounded-lg transition duration-300 font-medium">
                                    <i data-feather="zap" class="w-4 h-4 inline mr-2"></i>
                                    Process with AI
                                </button>
                                
                                <button id="change-file" class="w-full mt-2 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition duration-300 text-sm">
                                    <i data-feather="refresh-cw" class="w-4 h-4 inline mr-2"></i>
                                    Change File
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Processing Status -->
                <div id="processing-status" class="hidden">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                        <div class="flex items-center justify-center mb-3">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mr-3"></div>
                            <p class="text-sm font-medium text-blue-800">Processing with AI...</p>
                        </div>
                        <p class="text-xs text-blue-600">This may take a few seconds. Please wait.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manual Entry Tab Content -->
        <div id="manual-content" class="tab-pane">
            <form method="POST" action="{{ url_for('shopkeeper.manual_purchase_bill') }}" class="space-y-6">
                <!-- Vendor Details Section -->
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 border border-gray-200">
                    <div class="flex items-center mb-4">
                        <i data-feather="user" class="w-5 h-5 text-pink-600 mr-2"></i>
                        <h2 class="text-lg md:text-xl font-bold text-gray-800">Vendor Details</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Vendor Name <span class="text-red-600">*</span></label>
                            <input type="text" name="vendor_name" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                            <input type="tel" name="vendor_phone"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">GST Number</label>
                            <input type="text" name="vendor_gst_number" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" name="vendor_email" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                            <textarea name="vendor_address" rows="2"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Bill Details Section -->
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 border border-gray-200">
                    <div class="flex items-center mb-4">
                        <i data-feather="file-text" class="w-5 h-5 text-violet-600 mr-2"></i>
                        <h2 class="text-lg md:text-xl font-bold text-gray-800">Bill Details</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Invoice Number</label>
                            <input type="text" name="invoice_number" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Bill Date</label>
                            <input type="date" name="bill_date" value="{{ now.strftime('%Y-%m-%d') }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent">
                        </div>
                    </div>
                </div>

                <!-- Products Section -->
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 border border-gray-200">
                    <div class="flex items-center mb-4">
                        <i data-feather="package" class="w-5 h-5 text-blue-600 mr-2"></i>
                        <h2 class="text-lg md:text-xl font-bold text-gray-800">Products Purchased</h2>
                    </div>
                    
                    <!-- Product Search -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Search & Add Products</label>
                        <div class="product-search-container relative">
                            <input type="text" id="product-search" placeholder="Type product name to search..." 
                                   class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#ed6a3e] focus:border-transparent">
                            <i data-feather="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"></i>
                            <div id="product-suggestions" class="hidden bg-white border border-gray-200 rounded-lg shadow-lg mt-1"></div>
                        </div>
                    </div>

                    <!-- Desktop Table View -->
                    <div class="hidden lg:block border border-gray-200 rounded-lg overflow-hidden">
                        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                            <div class="grid grid-cols-12 gap-3 text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <div class="col-span-3">Product Name</div>
                                <div class="col-span-1">Qty</div>
                                <div class="col-span-2">Price</div>
                                <div class="col-span-2">HSN Code</div>
                                <div class="col-span-2">GST Rate (%)</div>
                                <div class="col-span-1">Total</div>
                                <div class="col-span-1">Action</div>
                            </div>
                        </div>
                        <div id="product-rows" class="divide-y divide-gray-200">
                            <div id="no-products-message" class="px-4 py-8 text-center text-gray-500">
                                <i data-feather="package" class="w-8 h-8 mx-auto mb-2"></i>
                                <p>No products added yet. Use the search above to add products.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Mobile Product Cards -->
                    <div class="lg:hidden" id="mobile-products">
                        <div id="mobile-no-products" class="text-center py-8 bg-gray-50 rounded-lg">
                            <i data-feather="package" class="w-8 h-8 mx-auto mb-2 text-gray-400"></i>
                            <p class="text-gray-500">No products added yet. Use the search above to add products.</p>
                        </div>
                    </div>

                    <button type="button" id="add-product-btn"
                            class="mt-4 w-full md:w-auto bg-blue-100 text-blue-600 hover:bg-blue-200 px-6 py-3 rounded-lg shadow transition duration-300 flex items-center justify-center">
                        <i data-feather="plus" class="mr-2 w-4 h-4"></i>
                        <span>Add Product</span>
                    </button>
                </div>

                <!-- Bill Summary Section -->
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 border border-gray-200">
                    <div class="flex items-center mb-4">
                        <i data-feather="book-open" class="w-5 h-5 text-indigo-600 mr-2"></i>
                        <h2 class="text-lg md:text-xl font-bold text-gray-800">Purchase Summary</h2>
                    </div>
                    
                    <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-4 md:p-6 space-y-3">
                        <div class="flex justify-between items-center text-xl md:text-2xl font-bold text-[#ed6a3e]">
                            <span>Total Amount:</span>
                            <span>₹<span id="bill-total">0.00</span></span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 border border-gray-200 mt-8">
                    <div class="flex flex-col sm:flex-row gap-3 md:gap-4">
                        <button type="submit"
                                class="flex-1 bg-green-100 hover:bg-green-200 text-green-600 px-6 py-3 rounded-lg shadow transition duration-300 flex items-center justify-center font-medium">
                            <i data-feather="save" class="mr-2 w-4 h-4"></i>
                            <span>Save Purchase Bill</span>
                        </button>
                        
                        <button type="button" id="cancel-manual-entry" 
                               class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-lg shadow transition duration-300 flex items-center justify-center font-medium">
                            <i data-feather="x" class="mr-2 w-4 h-4"></i>
                            <span>Cancel</span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script type="text/javascript">
    const PRODUCTS = {{ products_js| tojson }};
</script>

<script>
    feather.replace();
    
    let selectedFile = null;
    let currentStream = null;
    
    document.addEventListener('DOMContentLoaded', function () {
        // Tab functionality
        const uploadTab = document.getElementById('upload-tab');
        const manualTab = document.getElementById('manual-tab');
        const uploadContent = document.getElementById('upload-content');
        const manualContent = document.getElementById('manual-content');

        uploadTab.addEventListener('click', () => {
            uploadTab.classList.add('bg-[#ed6a3e]', 'text-white');
            uploadTab.classList.remove('text-gray-600');
            manualTab.classList.remove('bg-[#ed6a3e]', 'text-white');
            manualTab.classList.add('text-gray-600');
            
            uploadContent.classList.add('active');
            manualContent.classList.remove('active');
        });

        manualTab.addEventListener('click', () => {
            manualTab.classList.add('bg-[#ed6a3e]', 'text-white');
            manualTab.classList.remove('text-gray-600');
            uploadTab.classList.remove('bg-[#ed6a3e]', 'text-white');
            uploadTab.classList.add('text-gray-600');
            
            manualContent.classList.add('active');
            uploadContent.classList.remove('active');
            
            // Initialize manual entry functionality
            setTimeout(() => {
                initializeProductSearch();
                initializeBillCalculations();
                feather.replace();
            }, 100);
        });

        // File upload functionality
        const uploadBtn = document.getElementById('upload-from-device');
        const cameraBtn = document.getElementById('scan-with-camera');
        const fileInput = document.getElementById('bill-file-input');
        const cameraSection = document.getElementById('camera-section');
        const cameraPreview = document.getElementById('camera-preview');
        const cameraCanvas = document.getElementById('camera-canvas');
        const captureBtn = document.getElementById('capture-photo');
        const cancelCameraBtn = document.getElementById('cancel-camera');
        const filePreviewSection = document.getElementById('file-preview-section');
        const processBtn = document.getElementById('process-with-ai');
        const changeFileBtn = document.getElementById('change-file');
        const processingStatus = document.getElementById('processing-status');

        // Upload from device
        uploadBtn.addEventListener('click', () => {
            fileInput.click();
        });

        // File selection handler
        fileInput.addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                selectedFile = e.target.files[0];
                showFilePreview(selectedFile);
            }
        });

        // Camera functionality
        cameraBtn.addEventListener('click', async () => {
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                cameraPreview.srcObject = currentStream;
                cameraSection.classList.remove('hidden');
            } catch (error) {
                console.error('Camera access denied:', error);
                showNotification('Camera access denied. Please check permissions.', 'error');
            }
        });

        // Capture photo
        captureBtn.addEventListener('click', () => {
            const canvas = cameraCanvas;
            const context = canvas.getContext('2d');
            
            canvas.width = cameraPreview.videoWidth;
            canvas.height = cameraPreview.videoHeight;
            
            context.drawImage(cameraPreview, 0, 0);
            
            canvas.toBlob((blob) => {
                selectedFile = new File([blob], 'camera-capture.jpg', { type: 'image/jpeg' });
                stopCamera();
                showFilePreview(selectedFile);
            }, 'image/jpeg', 0.8);
        });

        // Cancel camera
        cancelCameraBtn.addEventListener('click', stopCamera);

        // Process with AI
        processBtn.addEventListener('click', async () => {
            if (!selectedFile) return;
            
            const formData = new FormData();
            formData.append('bill_file', selectedFile);
            
            // Show processing status
            filePreviewSection.classList.add('hidden');
            processingStatus.classList.remove('hidden');
            
            try {
                const response = await fetch('{{ url_for("shopkeeper.process_scanned_purchase_bill") }}', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                processingStatus.classList.add('hidden');
                
                if (result.success) {
                    showNotification('Purchase bill processed successfully! Stock has been updated.', 'success');
                    setTimeout(() => {
                        window.location.href = '{{ url_for("shopkeeper.purchase_bills") }}';
                    }, 2000);
                } else {
                    showNotification('Error: ' + result.message, 'error');
                    filePreviewSection.classList.remove('hidden');
                }
            } catch (error) {
                processingStatus.classList.add('hidden');
                filePreviewSection.classList.remove('hidden');
                showNotification('Error processing file. Please try again.', 'error');
            }
        });

        // Change file button
        changeFileBtn.addEventListener('click', () => {
            selectedFile = null;
            filePreviewSection.classList.add('hidden');
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('pdf-preview').classList.add('hidden');
        });

        // Cancel manual entry button
        document.getElementById('cancel-manual-entry')?.addEventListener('click', () => {
            showConfirmDialog(
                'Are you sure you want to cancel?', 
                'All entered data will be lost.', 
                () => {
                    window.location.href = '{{ url_for("shopkeeper.purchase_bills") }}';
                }
            );
        });

        // Form submission validation
        const manualForm = document.querySelector('#manual-content form');
        if (manualForm) {
            manualForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Validate vendor name
                const vendorName = this.querySelector('input[name="vendor_name"]').value.trim();
                if (!vendorName) {
                    showNotification('Vendor name is required.', 'error');
                    this.querySelector('input[name="vendor_name"]').focus();
                    return;
                }
                
                // Validate products
                const productNames = Array.from(this.querySelectorAll('input[name="product_name[]"]'));
                const validProducts = productNames.filter(input => input.value.trim());
                
                if (validProducts.length === 0) {
                    showNotification('At least one product is required.', 'error');
                    return;
                }
                
                // Validate product details
                let hasValidationError = false;
                validProducts.forEach((productInput, index) => {
                    const productRow = productInput.closest('.product-row') || productInput.closest('.mobile-product-card');
                    const quantity = productRow.querySelector('input[name="quantity[]"]').value;
                    const price = productRow.querySelector('input[name="price[]"]').value;
                    
                    if (!quantity || quantity <= 0) {
                        showNotification(`Product ${index + 1}: Quantity must be greater than 0.`, 'error');
                        productRow.querySelector('input[name="quantity[]"]').focus();
                        hasValidationError = true;
                        return;
                    }
                    
                    if (!price || price < 0) {
                        showNotification(`Product ${index + 1}: Price must be 0 or greater.`, 'error');
                        productRow.querySelector('input[name="price[]"]').focus();
                        hasValidationError = true;
                        return;
                    }
                });
                
                if (hasValidationError) return;
                
                // Show loading state
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = `
                    <div class="flex items-center justify-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                        Saving...
                    </div>
                `;
                
                // Submit the form
                this.submit();
            });
        }

        // Stop camera function
        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            cameraSection.classList.add('hidden');
        }

        // Show file preview
        function showFilePreview(file) {
            document.getElementById('file-name-display').textContent = file.name;
            
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview-image').src = e.target.result;
                    document.getElementById('image-preview').classList.remove('hidden');
                    document.getElementById('pdf-preview').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            } else if (file.type === 'application/pdf') {
                document.getElementById('pdf-name').textContent = file.name;
                document.getElementById('pdf-preview').classList.remove('hidden');
                document.getElementById('image-preview').classList.add('hidden');
            }
            
            filePreviewSection.classList.remove('hidden');
        }
        
        // Re-initialize feather icons
        setTimeout(() => feather.replace(), 100);
    });

    // Product search and management functions
    function initializeProductSearch() {
        const productSearch = document.getElementById('product-search');
        const productSuggestions = document.getElementById('product-suggestions');
        let searchTimeout;

        if (!productSearch) return;

        productSearch.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.toLowerCase().trim();
            
            if (query.length < 1) {
                productSuggestions.classList.add('hidden');
                return;
            }

            searchTimeout = setTimeout(() => {
                showProductSuggestions(query);
            }, 300);
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!productSearch.contains(e.target) && !productSuggestions.contains(e.target)) {
                productSuggestions.classList.add('hidden');
            }
        });

        // Add product button handler
        document.getElementById('add-product-btn')?.addEventListener('click', function() {
            addProductRow({ name: '', price: 0, gst_rate: 0, hsn_code: '' }, true);
        });
    }

    function showProductSuggestions(query) {
        const productSuggestions = document.getElementById('product-suggestions');
        const matchedProducts = PRODUCTS.filter(product => 
            product.name.toLowerCase().includes(query)
        );

        let html = '';
        
        // Show matched products
        matchedProducts.forEach(product => {
            html += `
                <div class="px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 product-suggestion" 
                     data-product='${JSON.stringify(product)}'>
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-medium text-gray-900">${product.name}</div>
                            <div class="text-sm text-gray-500">₹${product.price} | Stock: ${product.stock} | GST: ${product.gst_rate}%</div>
                        </div>
                        <i data-feather="plus" class="w-4 h-4 text-blue-600"></i>
                    </div>
                </div>
            `;
        });

        // Add option for new product
        const exactMatch = matchedProducts.find(p => p.name.toLowerCase() === query);
        if (!exactMatch && query.length > 0) {
            html += `
                <div class="px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 new-product-suggestion bg-blue-50" 
                     data-name="${query}">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-medium text-blue-900">Create "${query}"</div>
                            <div class="text-sm text-blue-600">Add as new product</div>
                        </div>
                        <i data-feather="plus-circle" class="w-4 h-4 text-blue-600"></i>
                    </div>
                </div>
            `;
        }

        if (html) {
            productSuggestions.innerHTML = html;
            productSuggestions.classList.remove('hidden');
            
            // Reinitialize feather icons
            feather.replace();
            
            // Add click handlers
            productSuggestions.querySelectorAll('.product-suggestion').forEach(item => {
                item.addEventListener('click', function() {
                    const productData = JSON.parse(this.dataset.product);
                    addProductRow(productData);
                    document.getElementById('product-search').value = '';
                    productSuggestions.classList.add('hidden');
                });
            });

            productSuggestions.querySelectorAll('.new-product-suggestion').forEach(item => {
                item.addEventListener('click', function() {
                    const productName = this.dataset.name;
                    addProductRow({ name: productName, price: 0, gst_rate: 0, hsn_code: '' }, true);
                    document.getElementById('product-search').value = '';
                    productSuggestions.classList.add('hidden');
                });
            });
        } else {
            productSuggestions.classList.add('hidden');
        }
    }

    let productCounter = 0;

    function addProductRow(product, isNew = false) {
        productCounter++;
        const productId = `product_${productCounter}`;
        
        // Hide no products message
        document.getElementById('no-products-message')?.classList.add('hidden');
        document.getElementById('mobile-no-products')?.classList.add('hidden');
        
        // Desktop row
        const desktopRow = document.createElement('div');
        desktopRow.className = 'px-4 py-3 product-row';
        desktopRow.dataset.productId = productId;
        desktopRow.innerHTML = `
            <div class="grid grid-cols-12 gap-3 items-center">
                <div class="col-span-3">
                    <input type="text" name="product_name[]" value="${product.name}" required 
                           class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                </div>
                <div class="col-span-1">
                    <input type="number" name="quantity[]" min="1" value="1" required 
                           class="w-full px-2 py-1 border border-gray-300 rounded text-sm quantity-input">
                </div>
                <div class="col-span-2">
                    <input type="number" name="price[]" step="0.01" min="0" value="${product.price || 0}" required 
                           class="w-full px-2 py-1 border border-gray-300 rounded text-sm price-input">
                </div>
                <div class="col-span-2">
                    <input type="text" name="hsn_code[]" value="${product.hsn_code || ''}"
                           class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                </div>
                <div class="col-span-2">
                    <input type="number" name="gst_rate[]" step="0.01" min="0" max="100" value="${product.gst_rate || 0}"
                           class="w-full px-2 py-1 border border-gray-300 rounded text-sm gst-rate-input">
                </div>
                <div class="col-span-1 text-center">
                    <span class="line-total text-sm font-medium text-gray-700">₹0.00</span>
                </div>
                <div class="col-span-1 text-center">
                    <button type="button" onclick="removeProductRow('${productId}')" 
                            class="text-red-600 hover:text-red-900 transition duration-200">
                        <i data-feather="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        `;
        
        document.getElementById('product-rows').appendChild(desktopRow);
        
        // Mobile card
        const mobileCard = document.createElement('div');
        mobileCard.className = 'mobile-product-card bg-white border border-gray-200 rounded-lg p-4 mb-4';
        mobileCard.dataset.productId = productId;
        mobileCard.innerHTML = `
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-sm font-medium text-gray-700">Product ${productCounter}</h3>
                <button type="button" onclick="removeProductRow('${productId}')" 
                        class="text-red-600 hover:text-red-900 transition duration-200">
                    <i data-feather="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Product Name</label>
                    <input type="text" name="product_name[]" value="${product.name}" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Quantity</label>
                        <input type="number" name="quantity[]" min="1" value="1" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm quantity-input-mobile">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Price</label>
                        <input type="number" name="price[]" step="0.01" min="0" value="${product.price || 0}" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm price-input-mobile">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">HSN Code</label>
                        <input type="text" name="hsn_code[]" value="${product.hsn_code || ''}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">GST Rate (%)</label>
                        <input type="number" name="gst_rate[]" step="0.01" min="0" max="100" value="${product.gst_rate || 0}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm gst-rate-input-mobile">
                    </div>
                </div>
                <div class="text-center pt-2 border-t border-gray-200">
                    <span class="text-sm text-gray-600">Line Total: </span>
                    <span class="line-total-mobile text-sm font-medium text-[#ed6a3e]">₹0.00</span>
                </div>
            </div>
        `;
        
        document.getElementById('mobile-products').appendChild(mobileCard);
        
        // Re-initialize feather icons and calculations
        feather.replace();
        initializeBillCalculations();
        updateTotal();
    }

    function removeProductRow(productId) {
        // Remove desktop row and mobile card
        const elements = document.querySelectorAll(`[data-product-id="${productId}"]`);
        elements.forEach(el => el.remove());
        
        // Show no products message if no products left
        const remainingRows = document.querySelectorAll('.product-row');
        if (remainingRows.length === 0) {
            document.getElementById('no-products-message')?.classList.remove('hidden');
            document.getElementById('mobile-no-products')?.classList.remove('hidden');
        }
        
        updateTotal();
    }

    function initializeBillCalculations() {
        // Add event listeners to all quantity, price, and GST inputs
        document.querySelectorAll('.quantity-input, .price-input, .gst-rate-input, .quantity-input-mobile, .price-input-mobile, .gst-rate-input-mobile').forEach(input => {
            input.addEventListener('input', updateTotal);
        });
    }

    function updateTotal() {
        let total = 0;
        
        // Calculate from desktop rows
        document.querySelectorAll('.product-row').forEach(row => {
            const quantity = parseFloat(row.querySelector('.quantity-input')?.value) || 0;
            const price = parseFloat(row.querySelector('.price-input')?.value) || 0;
            const gstRate = parseFloat(row.querySelector('.gst-rate-input')?.value) || 0;
            
            const subtotal = quantity * price;
            const gstAmount = (subtotal * gstRate) / 100;
            const lineTotal = subtotal + gstAmount;
            
            const lineTotalEl = row.querySelector('.line-total');
            if (lineTotalEl) lineTotalEl.textContent = `₹${lineTotal.toFixed(2)}`;
            total += lineTotal;
        });
        
        // Update mobile cards
        document.querySelectorAll('.mobile-product-card').forEach(card => {
            const quantity = parseFloat(card.querySelector('.quantity-input-mobile')?.value) || 0;
            const price = parseFloat(card.querySelector('.price-input-mobile')?.value) || 0;
            const gstRate = parseFloat(card.querySelector('.gst-rate-input-mobile')?.value) || 0;
            
            const subtotal = quantity * price;
            const gstAmount = (subtotal * gstRate) / 100;
            const lineTotal = subtotal + gstAmount;
            
            const lineTotalEl = card.querySelector('.line-total-mobile');
            if (lineTotalEl) lineTotalEl.textContent = `₹${lineTotal.toFixed(2)}`;
        });
        
        const billTotalEl = document.getElementById('bill-total');
        if (billTotalEl) billTotalEl.textContent = total.toFixed(2);
    }

    // Notification System
    function showNotification(message, type = 'info', duration = 5000) {
        const container = document.getElementById('notification-container');
        const notification = document.createElement('div');
        
        // Set notification styles based on type
        let bgColor, textColor, iconName;
        switch (type) {
            case 'success':
                bgColor = 'bg-green-500';
                textColor = 'text-white';
                iconName = 'check-circle';
                break;
            case 'error':
                bgColor = 'bg-red-500';
                textColor = 'text-white';
                iconName = 'x-circle';
                break;
            case 'warning':
                bgColor = 'bg-yellow-500';
                textColor = 'text-white';
                iconName = 'alert-triangle';
                break;
            default:
                bgColor = 'bg-blue-500';
                textColor = 'text-white';
                iconName = 'info';
        }
        
        notification.className = `${bgColor} ${textColor} rounded-lg shadow-lg p-4 mb-2 transform transition-all duration-300 translate-x-full opacity-0 max-w-sm`;
        notification.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i data-feather="${iconName}" class="w-5 h-5 mr-3 flex-shrink-0"></i>
                    <span class="text-sm font-medium">${message}</span>
                </div>
                <button onclick="removeNotification(this)" class="ml-3 hover:opacity-70 transition-opacity flex-shrink-0">
                    <i data-feather="x" class="w-4 h-4"></i>
                </button>
            </div>
        `;
        
        container.appendChild(notification);
        
        // Initialize feather icons for the notification
        feather.replace();
        
        // Animate in
        setTimeout(() => {
            notification.classList.remove('translate-x-full', 'opacity-0');
            notification.classList.add('translate-x-0', 'opacity-100');
        }, 10);
        
        // Auto remove after duration
        if (duration > 0) {
            setTimeout(() => {
                removeNotification(notification);
            }, duration);
        }
    }

    function removeNotification(element) {
        const notification = element.closest ? element.closest('.transform') : element;
        if (notification) {
            notification.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }
    }

    // Confirm Dialog
    function showConfirmDialog(title, message, onConfirm) {
        const overlay = document.createElement('div');
        overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        overlay.innerHTML = `
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 transform transition-all duration-200">
                <div class="flex items-center mb-4">
                    <i data-feather="alert-triangle" class="w-6 h-6 text-yellow-500 mr-3"></i>
                    <h3 class="text-lg font-semibold text-gray-800">${title}</h3>
                </div>
                <p class="text-gray-600 mb-6">${message}</p>
                <div class="flex gap-3 justify-end">
                    <button onclick="closeConfirmDialog()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition duration-200">
                        Cancel
                    </button>
                    <button onclick="confirmAction()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition duration-200">
                        Confirm
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(overlay);
        feather.replace();
        
        // Add global functions for the dialog
        window.closeConfirmDialog = function() {
            document.body.removeChild(overlay);
            delete window.closeConfirmDialog;
            delete window.confirmAction;
        };
        
        window.confirmAction = function() {
            onConfirm();
            closeConfirmDialog();
        };
        
        // Close on overlay click
        overlay.addEventListener('click', function(e) {
            if (e.target === overlay) {
                closeConfirmDialog();
            }
        });
    }

    // Auto-hide flash messages after 8 seconds
    document.addEventListener('DOMContentLoaded', function() {
        const flashMessages = document.querySelectorAll('.flash-message');
        flashMessages.forEach(message => {
            setTimeout(() => {
                if (message.parentNode) {
                    message.style.transition = 'opacity 0.3s ease-out';
                    message.style.opacity = '0';
                    setTimeout(() => {
                        if (message.parentNode) {
                            message.parentNode.removeChild(message);
                        }
                    }, 300);
                }
            }, 8000);
        });
        
        // Re-initialize feather icons for flash messages
        feather.replace();
    });
</script>
{% endblock %}